<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TanzaniaLoanPro - Loan Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #27ae60;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #27ae60;
            --info-color: #3498db;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --white-color: #ffffff;
            --gray-color: #7f8c8d;
            --light-gray: #f5f6fa;
            --border-color: #dfe6e9;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --card-bg: #ffffff;
            --text-color: #2c3e50;
            --text-light: #7f8c8d;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --sidebar-hover: #34495e;
            --sidebar-active: #27ae60;
        }

        .dark-mode {
            --primary-color: #2ecc71;
            --secondary-color: #27ae60;
            --danger-color: #c0392b;
            --light-color: #34495e;
            --dark-color: #ecf0f1;
            --text-color: #ecf0f1;
            --text-light: #bdc3c7;
            --card-bg: #2c3e50;
            --border-color: #4a6278;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --sidebar-hover: #34495e;
            --sidebar-active: #2ecc71;
            --white-color: #2c3e50;
            --light-gray: #2e3233;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: var(--dark-color);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        /* Login Form Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 20px;
        }

        .login-card {
            background: var(--white-color);
            border-radius: 20px;
            box-shadow: 0 15px 35px var(--shadow-color);
            width: 100%;
            max-width: 400px;
            padding: 40px;
            text-align: center;
        }

        .login-card h2 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 2rem;
        }

        .login-form .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 600;
        }

        .login-form .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 50px;
            background: var(--light-color);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .login-form .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
        }

        .login-btn {
            background: var(--primary-color);
            color: var(--white-color);
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .login-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        .main-app {
            display: none;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--sidebar-bg);
        }

        .sidebar-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--sidebar-text);
        }

        .sidebar-menu {
            padding: 10px 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            margin: 2px 0;
            border-radius: 0 25px 25px 0;
            margin-right: 10px;
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--sidebar-hover);
            color: white;
            border-left: 3px solid var(--sidebar-active);
        }

        .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .nav-text {
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .header-title h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--white-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-secondary {
            background-color: var(--gray-color);
        }

        .btn-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        /* Card Styles */
        .card {
            background-color: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 4px 20px var(--shadow-color);
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .card:hover {
            box-shadow: 0 8px 25px var(--shadow-color);
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
        }

        .card-header h3 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .card-body {
            padding: 20px;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 15px var(--shadow-color);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary-color);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px var(--shadow-color);
        }

        .stat-card h4 {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card p {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }

        .stat-card .stat-icon {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 8px;
            opacity: 0.7;
        }

        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--light-color);
            font-weight: 600;
            color: var(--text-color);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        tbody tr:hover {
            background-color: rgba(46, 204, 113, 0.05);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 50px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
        }

        .input-group-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Status Indicators */
        .status-badge {
            padding: 6px 15px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
        }

        .status-active {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }

        .status-pending {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }

        .status-overdue {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .status-completed {
            background: rgba(52, 152, 219, 0.1);
            color: var(--info-color);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
        }

        .modal-header h3 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.3s ease;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: var(--danger-color);
            background: rgba(231, 76, 60, 0.1);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: var(--light-color);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 50px;
            color: white;
            font-weight: 500;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1200;
            display: none;
            animation: notificationSlideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes notificationSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        /* Section Styles */
        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Borrower Details */
        .borrower-details-container {
            display: none;
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .borrower-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .borrower-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .borrower-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            border: 3px solid var(--light-color);
        }

        .borrower-photo i {
            font-size: 2.5rem;
            color: white;
        }

        .borrower-text h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .borrower-text p {
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .borrower-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .borrower-stat {
            padding: 15px 20px;
            background: var(--light-color);
            border-radius: 10px;
            text-align: center;
            min-width: 120px;
        }

        .borrower-stat h4 {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .borrower-stat p {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .borrower-tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 25px;
            gap: 5px;
            overflow-x: auto;
        }

        .borrower-tab {
            padding: 15px 25px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: var(--text-light);
            border-radius: 10px 10px 0 0;
            white-space: nowrap;
        }

        .borrower-tab.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
            background: rgba(46, 204, 113, 0.1);
        }

        .borrower-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .borrower-content.active {
            display: block;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .info-card {
            background: var(--light-color);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .info-card h4 {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-card p {
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .info-card strong {
            color: var(--primary-color);
        }

        /* Photo Upload */
        .photo-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .photo-placeholder {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--light-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            border: 3px solid var(--primary-color);
            transition: all 0.3s ease;
        }

        .photo-placeholder:hover {
            transform: scale(1.05);
        }

        .photo-placeholder i {
            font-size: 3rem;
            color: var(--text-light);
        }

        /* Select Options */
        .select-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .select-option {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .select-option:hover {
            border-color: var(--primary-color);
        }

        .select-option.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 300px;
            position: relative;
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-active {
            background-color: var(--success-color);
        }

        .status-pending {
            background-color: var(--warning-color);
        }

        .status-overdue {
            background-color: var(--danger-color);
        }

        .status-completed {
            background-color: var(--info-color);
        }

        .status-inactive {
            background-color: var(--gray-color);
        }

        /* Action Buttons */
        .action-button {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            margin-right: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .view-button {
            background-color: var(--info-color);
            color: var(--white-color);
        }

        .edit-button {
            background-color: var(--warning-color);
            color: var(--white-color);
        }

        .delete-button {
            background-color: var(--danger-color);
            color: var(--white-color);
        }

        .call-button {
            background-color: var(--success-color);
            color: var(--white-color);
        }

        .sms-button {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .download-button {
            background-color: var(--secondary-color);
            color: var(--white-color);
        }

        /* Floating Action Button */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
            display: none; /* Hidden by default, shown only when logged in */
        }

        .fab {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .fab:hover {
            background-color: var(--secondary-color);
            transform: scale(1.1);
        }

        .fab-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 8px var(--shadow-color);
            width: 200px;
            overflow: hidden;
            display: none;
        }

        .fab-menu.active {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        .fab-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-color);
            text-decoration: none;
            transition: all 0.2s;
        }

        .fab-item:hover {
            background-color: var(--light-color);
        }

        .fab-item i {
            width: 20px;
            text-align: center;
        }

        /* Notification Icon */
        .notification-icon {
            position: relative;
            cursor: pointer;
            margin-right: 15px;
        }

        .notification-icon i {
            font-size: 1.3rem;
            color: var(--text-color);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Notification Panel */
        .notification-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 350px;
            max-height: 400px;
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 5px 20px var(--shadow-color);
            overflow: hidden;
            display: none;
            z-index: 1100;
        }

        .notification-panel.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification-panel-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-panel-header h4 {
            margin: 0;
            color: var(--primary-color);
        }

        .clear-notifications {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .notification-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .notification-item:hover {
            background-color: var(--light-color);
        }

        .notification-item.unread {
            background-color: rgba(46, 204, 113, 0.05);
        }

        .notification-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .notification-item-title {
            font-weight: 600;
            color: var(--text-color);
        }

        .notification-item-time {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .notification-item-message {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        /* Schedule Section */
        .schedule-container {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .schedule-header h3 {
            color: var(--primary-color);
            font-size: 1.3rem;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
        }

        .schedule-table th, 
        .schedule-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .schedule-table th {
            background-color: var(--light-color);
            font-weight: 600;
            color: var(--text-color);
        }

        .schedule-item {
            transition: background-color 0.2s;
        }

        .schedule-item:hover {
            background-color: rgba(46, 204, 113, 0.05);
        }

        .schedule-item.paid {
            background-color: rgba(39, 174, 96, 0.1);
        }

        .schedule-item.overdue {
            background-color: rgba(231, 76, 60, 0.1);
        }

        /* Receipt Styles */
        .receipt-container {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
        }

        .receipt-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .receipt-table th, 
        .receipt-table td {
            padding: 10px;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        .receipt-table th {
            background-color: var(--light-color);
        }

        .receipt-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: 10px;
        }

        .receipt-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        /* User Profile Dropdown */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .user-profile-menu {
            position: absolute;
            top: 50px;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 15px var(--shadow-color);
            width: 200px;
            overflow: hidden;
            display: none;
            z-index: 1000;
        }

        .user-profile-menu.active {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        .user-profile-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-color);
            text-decoration: none;
            transition: all 0.2s;
        }

        .user-profile-item:hover {
            background-color: var(--light-color);
        }

        .user-profile-item i {
            width: 20px;
            text-align: center;
        }

        .user-profile-info {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .user-profile-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-profile-role {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* Role Badge Styles */
        .role-badge {
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 10px;
            display: inline-block;
        }

        .role-admin {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .role-manager {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }

        .role-loan-officer {
            background: rgba(52, 152, 219, 0.1);
            color: var(--info-color);
        }

        .role-accountant {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }

        .role-viewer {
            background: rgba(149, 165, 166, 0.1);
            color: var(--gray-color);
        }

        /* Accountant Dashboard Styles */
        .profit-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .profit-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
            position: relative;
            overflow: hidden;
        }

        .profit-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(45deg);
            z-index: 0;
        }

        .profit-card h4 {
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }

        .profit-card p {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            position: relative;
            z-index: 1;
        }

        .profit-card .profit-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.7;
            position: relative;
            z-index: 1;
        }

        /* Statement Styles */
        .statement-container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .statement-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .statement-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .statement-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .statement-table th, 
        .statement-table td {
            padding: 10px;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        
        .statement-table th {
            background-color: var(--light-color);
        }
        
        .statement-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: 10px;
        }
        
        /* Filter Styles */
        .filter-container {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        /* Report Styles */
        .report-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        /* Help Styles */
        .help-container {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .help-section {
            margin-bottom: 30px;
        }
        
        .help-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .help-item {
            margin-bottom: 15px;
        }
        
        .help-item h4 {
            color: var(--secondary-color);
            margin-bottom: 8px;
        }
        
        .help-item p {
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .help-steps {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .help-steps li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        /* Loan Details Modal */
        .loan-details-container {
            display: none;
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .loan-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .loan-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .loan-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loan-icon i {
            font-size: 2.5rem;
            color: white;
        }

        .loan-text h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .loan-text p {
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .loan-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .loan-stat {
            padding: 15px 20px;
            background: var(--light-color);
            border-radius: 10px;
            text-align: center;
            min-width: 120px;
        }

        .loan-stat h4 {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .loan-stat p {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .loan-tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 25px;
            gap: 5px;
            overflow-x: auto;
        }

        .loan-tab {
            padding: 15px 25px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: var(--text-light);
            border-radius: 10px 10px 0 0;
            white-space: nowrap;
        }

        .loan-tab.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
            background: rgba(46, 204, 113, 0.1);
        }

        .loan-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .loan-content.active {
            display: block;
        }

        /* Repayment Details Modal */
        .repayment-details-container {
            display: none;
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .repayment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .repayment-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .repayment-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .repayment-icon i {
            font-size: 2.5rem;
            color: white;
        }

        .repayment-text h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .repayment-text p {
            color: var(--text-light);
            margin-bottom: 10px;
        }

        /* SMS Modal */
        .sms-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .sms-modal-content {
            background-color: var(--card-bg);
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        .sms-recipient {
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: 10px;
        }

        .sms-recipient h4 {
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .sms-templates {
            margin-bottom: 20px;
        }

        .sms-templates h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .sms-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            resize: vertical;
        }

        .sms-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
        }

        .sms-counter {
            text-align: right;
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 15px;
        }

        /* Edit Loan Modal */
        .edit-loan-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .edit-loan-modal-content {
            background-color: var(--card-bg);
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        /* Edit Repayment Modal */
        .edit-repayment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .edit-repayment-modal-content {
            background-color: var(--card-bg);
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .settings-modal-content {
            background-color: var(--card-bg);
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        .settings-tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            gap: 5px;
            overflow-x: auto;
        }

        .settings-tab {
            padding: 15px 25px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: var(--text-light);
            border-radius: 10px 10px 0 0;
            white-space: nowrap;
        }

        .settings-tab.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
            background: rgba(46, 204, 113, 0.1);
        }

        .settings-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .settings-content.active {
            display: block;
        }

        /* User Profile Modal */
        .user-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .user-profile-modal-content {
            background-color: var(--card-bg);
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        .profile-photo-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .profile-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--light-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            border: 3px solid var(--primary-color);
            transition: all 0.3s ease;
        }

        .profile-photo:hover {
            transform: scale(1.05);
        }

        .profile-photo i {
            font-size: 3rem;
            color: var(--text-light);
        }

        /* Data Export Modal */
        .export-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .export-modal-content {
            background-color: var(--card-bg);
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .export-option {
            padding: 20px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .export-option:hover {
            border-color: var(--primary-color);
            background-color: rgba(46, 204, 113, 0.05);
        }

        .export-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(46, 204, 113, 0.1);
        }

        .export-option i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .export-option h4 {
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .export-option p {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-content {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .loading-content p {
            margin-top: 15px;
            color: var(--text-color);
        }

        /* Form Check Styles */
        .form-check {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .form-check-input {
            margin-right: 10px;
        }

        .form-check-label {
            margin-bottom: 0;
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
                overflow: hidden;
            }

            .sidebar-header h2, .nav-text {
                display: none;
            }

            .nav-link {
                justify-content: center;
                padding: 15px 0;
                margin: 2px 5px;
            }

            .nav-link i {
                margin-right: 0;
                font-size: 1.3rem;
            }

            .main-content {
                margin-left: 70px;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .input-group-row {
                grid-template-columns: 1fr;
            }

            .borrower-info {
                flex-direction: column;
                text-align: center;
            }

            .borrower-stats {
                justify-content: center;
            }
            
            .chart-container {
                height: 250px;
            }
        }

        @media (max-width: 576px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 10px 0;
            }

            .sidebar-menu {
                display: flex;
                overflow-x: auto;
                padding: 10px 0;
                white-space: nowrap;
            }

            .nav-link {
                padding: 10px 15px;
                border-left: none;
                border-bottom: 3px solid transparent;
                margin: 0 5px;
            }

            .nav-link:hover, .nav-link.active {
                border-left: none;
                border-bottom: 3px solid var(--sidebar-active);
            }

            .main-content {
                margin-left: 0;
                margin-top: 60px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-actions {
                flex-wrap: wrap;
                justify-content: flex-start;
            }
            
            .borrower-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .borrower-stat {
                min-width: 100px;
                padding: 10px 15px;
            }
            
            .borrower-stat p {
                font-size: 1rem;
            }
        }

        /* Print Styles */
        @media print {
            .sidebar, .header-actions, .no-print, .action-button, .btn {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0 !important;
                padding: 0 !important;
            }
            
            .card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
            }
            
            .borrower-details-container {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 20px;
            color: var(--text-light);
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="login-container">
        <div class="login-card">
            <h2>TanzaniaLoanPro</h2>
            <p style="margin-bottom: 20px; color: var(--text-light);">Login to your account</p>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter your username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter your password" required>
                </div>
                <div class="form-group">
                    <label for="role">Role</label>
                    <select id="role" class="form-control" required>
                        <option value="">Select your role</option>
                        <option value="admin">Admin</option>
                        <option value="manager">Manager</option>
                        <option value="loan_officer">Loan Officer</option>
                        <option value="accountant">Accountant</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
                <button type="submit" class="login-btn">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>TanzaniaLoanPro</h2>
            </div>
            <div class="sidebar-menu">
                <a href="#" class="nav-link active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="#" class="nav-link" data-section="borrowers">
                    <i class="fas fa-users"></i>
                    <span class="nav-text">Borrowers</span>
                </a>
                <a href="#" class="nav-link" data-section="loans">
                    <i class="fas fa-hand-holding-usd"></i>
                    <span class="nav-text">Loans</span>
                </a>
                <a href="#" class="nav-link" data-section="repayments">
                    <i class="fas fa-money-bill-wave"></i>
                    <span class="nav-text">Repayments</span>
                </a>
                <a href="#" class="nav-link" data-section="profitDashboard" style="display: none;">
                    <i class="fas fa-chart-line"></i>
                    <span class="nav-text">Profit Dashboard</span>
                </a>
                <a href="#" class="nav-link" data-section="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span class="nav-text">Reports</span>
                </a>
                <a href="#" class="nav-link" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span class="nav-text">Settings</span>
                </a>
                <a href="#" class="nav-link" data-section="help">
                    <i class="fas fa-question-circle"></i>
                    <span class="nav-text">Help</span>
                </a>
                <a href="#" class="nav-link" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="nav-text">Logout</span>
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-title">
                    <h1>Dashboard</h1>
                    <p id="currentDate">Welcome back! Today is <span id="dateDisplay"></span></p>
                </div>
                <div class="header-actions">
                    <div class="notification-icon" id="notificationIcon">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge">0</span>
                    </div>
                    <div class="user-profile" id="userProfile">
                        <span id="userRole" class="role-badge role-admin">Admin</span>
                        <span id="userName">John Doe</span>
                        <div class="photo-placeholder" id="userPhoto" style="width: 40px; height: 40px;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-profile-menu" id="userProfileMenu">
                            <div class="user-profile-info">
                                <div class="user-profile-name" id="profileName">John Doe</div>
                                <div class="user-profile-role" id="profileRole">Admin</div>
                            </div>
                            <a href="#" class="user-profile-item" id="viewProfileBtn">
                                <i class="fas fa-user"></i>
                                <span>My Profile</span>
                            </a>
                            <a href="#" class="user-profile-item" id="settingsBtn">
                                <i class="fas fa-cog"></i>
                                <span>Settings</span>
                            </a>
                            <a href="#" class="user-profile-item" id="exportDataBtn">
                                <i class="fas fa-download"></i>
                                <span>Export Data</span>
                            </a>
                            <a href="#" class="user-profile-item" id="profileLogout">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </a>
                        </div>
                    </div>
                    <button class="btn btn-icon" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>

            <!-- Notification Panel -->
            <div class="notification-panel" id="notificationPanel">
                <div class="notification-panel-header">
                    <h4>Notifications</h4>
                    <button class="clear-notifications" id="clearNotifications">Clear All</button>
                </div>
                <div class="notification-list" id="notificationList">
                    <!-- Notifications will be populated here -->
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-users stat-icon"></i>
                        <h4>Total Borrowers</h4>
                        <p id="totalBorrowers">0</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-hand-holding-usd stat-icon"></i>
                        <h4>Active Loans</h4>
                        <p id="activeLoans">0</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-money-bill-wave stat-icon"></i>
                        <h4>Loan Disbursed</h4>
                        <p id="loanDisbursed">TZS 0</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-chart-line stat-icon"></i>
                        <h4>Amount Repaid</h4>
                        <p id="amountRepaid">TZS 0</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-balance-scale stat-icon"></i>
                        <h4>Outstanding Balance</h4>
                        <p id="outstandingBalance">TZS 0</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Recent Loans</h3>
                        <button class="btn btn-primary" id="viewAllLoansBtn">View All</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="recentLoansTable">
                                <thead>
                                    <tr>
                                        <th>Borrower</th>
                                        <th>Amount</th>
                                        <th>Interest</th>
                                        <th>Total Amount</th>
                                        <th>Status</th>
                                        <th>Due Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Recent loans will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Borrowers Section -->
            <div id="borrowers" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3>Borrowers Management</h3>
                        <button class="btn btn-primary" id="addBorrowerBtn">Add Borrower</button>
                    </div>
                    <div class="card-body">
                        <!-- Borrower Details Container -->
                        <div id="borrowerDetailsContainer" class="borrower-details-container">
                            <div class="borrower-header">
                                <div class="borrower-info">
                                    <div class="borrower-photo" id="borrowerDetailPhoto">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div class="borrower-text">
                                        <h2 id="borrowerDetailName">John Doe</h2>
                                        <p id="borrowerDetailContact">+255 712 345 678 | john.doe@example.com</p>
                                        <p id="borrowerDetailId">ID: BR-0001</p>
                                    </div>
                                </div>
                                <div class="borrower-stats">
                                    <div class="borrower-stat">
                                        <h4>Total Loans</h4>
                                        <p id="borrowerDetailTotalLoans">2</p>
                                    </div>
                                    <div class="borrower-stat">
                                        <h4>Active Loans</h4>
                                        <p id="borrowerDetailActiveLoans">1</p>
                                    </div>
                                    <div class="borrower-stat">
                                        <h4>Total Loan Amount</h4>
                                        <p id="borrowerDetailTotalLoanAmount">TZS 800,000</p>
                                    </div>
                                    <div class="borrower-stat">
                                        <h4>Remaining Balance</h4>
                                        <p id="borrowerDetailRemainingBalance">TZS 350,000</p>
                                    </div>
                                    <div class="borrower-stat">
                                        <h4>Status</h4>
                                        <p><span class="status-badge status-active" id="borrowerDetailStatus">Active</span></p>
                                    </div>
                                </div>
                            </div>

                            <div class="borrower-tabs">
                                <div class="borrower-tab active" data-tab="personal">Personal Information</div>
                                <div class="borrower-tab" data-tab="loans">Loan History</div>
                                <div class="borrower-tab" data-tab="repayments">Repayment History</div>
                                <div class="borrower-tab" data-tab="schedule">Repayment Schedule</div>
                            </div>

                            <div class="borrower-content active" id="personalTab">
                                <div class="info-grid">
                                    <div class="info-card">
                                        <h4>Contact Information</h4>
                                        <p><strong>Phone:</strong> <span id="borrowerDetailPhone">+255 712 345 678</span></p>
                                        <p><strong>Email:</strong> <span id="borrowerDetailEmail">john.doe@example.com</span></p>
                                        <p><strong>Address:</strong> <span id="borrowerDetailAddress">123 Main St, Dar es Salaam</span></p>
                                    </div>
                                    <div class="info-card">
                                        <h4>Personal Details</h4>
                                        <p><strong>ID Number:</strong> <span id="borrowerDetailIdNumber">BR-0001</span></p>
                                        <p><strong>Occupation:</strong> <span id="borrowerDetailOccupation">Business Owner</span></p>
                                        <p><strong>Guarantor:</strong> <span id="borrowerDetailGuarantor">Jane Smith</span></p>
                                        <p><strong>Guarantor Phone:</strong> <span id="borrowerDetailGuarantorPhone">+255 713 456 789</span></p>
                                        <p><strong>Member Since:</strong> <span id="borrowerDetailMemberSince">January 2024</span></p>
                                    </div>
                                </div>
                                <div class="info-card">
                                    <h4>Additional Information</h4>
                                    <p><strong>Credit Score:</strong> <span id="borrowerDetailCreditScore">Good</span></p>
                                    <p><strong>Last Updated:</strong> <span id="borrowerDetailLastUpdated">April 15, 2024</span></p>
                                </div>
                            </div>

                            <div class="borrower-content" id="loansTab">
                                <div class="table-responsive">
                                    <table id="borrowerLoansTable">
                                        <thead>
                                            <tr>
                                                <th>Loan ID</th>
                                                <th>Amount</th>
                                                <th>Interest</th>
                                                <th>Total Amount</th>
                                                <th>Term</th>
                                                <th>Status</th>
                                                <th>Date Issued</th>
                                                <th>Due Date</th>
                                                <th>Remaining</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Borrower's loans will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="borrower-content" id="repaymentsTab">
                                <div class="table-responsive">
                                    <table id="borrowerRepaymentsTable">
                                        <thead>
                                            <tr>
                                                <th>Repayment ID</th>
                                                <th>Loan ID</th>
                                                <th>Amount</th>
                                                <th>Date</th>
                                                <th>Method</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Borrower's repayments will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="borrower-content" id="scheduleTab">
                                <div class="schedule-container">
                                    <div class="schedule-header">
                                        <h3>Repayment Schedule</h3>
                                        <button class="btn btn-primary" id="generateScheduleBtn">Generate Schedule</button>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="schedule-table">
                                            <thead>
                                                <tr>
                                                    <th>Installment #</th>
                                                    <th>Due Date</th>
                                                    <th>Amount</th>
                                                    <th>Principal</th>
                                                    <th>Interest</th>
                                                    <th>Balance</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="scheduleTableBody">
                                                <!-- Schedule will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="borrower-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                                <button class="btn btn-primary" id="editBorrowerBtn">Edit Borrower</button>
                                <button class="btn btn-success" id="sendMessageBtn">Send Message</button>
                                <button class="btn btn-secondary" id="printBorrowerBtn">Print Details</button>
                                <button class="btn btn-danger" id="closeBorrowerDetails">Close Details</button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="borrowersTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Photo</th>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>Email</th>
                                        <th>Loans</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Borrowers will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loans Section -->
            <div id="loans" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3>Loans Management</h3>
                        <button class="btn btn-primary" id="addLoanBtn">Add Loan</button>
                    </div>
                    <div class="card-body">
                        <!-- Loan Details Container -->
                        <div id="loanDetailsContainer" class="loan-details-container">
                            <div class="loan-header">
                                <div class="loan-info">
                                    <div class="loan-icon">
                                        <i class="fas fa-hand-holding-usd"></i>
                                    </div>
                                    <div class="loan-text">
                                        <h2 id="loanDetailId">LN-0001</h2>
                                        <p id="loanDetailBorrower">John Doe</p>
                                        <p id="loanDetailPurpose">Business</p>
                                    </div>
                                </div>
                                <div class="loan-stats">
                                    <div class="loan-stat">
                                        <h4>Loan Amount</h4>
                                        <p id="loanDetailAmount">TZS 500,000</p>
                                    </div>
                                    <div class="loan-stat">
                                        <h4>Interest Rate</h4>
                                        <p id="loanDetailInterest">10%</p>
                                    </div>
                                    <div class="loan-stat">
                                        <h4>Total Amount</h4>
                                        <p id="loanDetailTotalAmount">TZS 550,000</p>
                                    </div>
                                    <div class="loan-stat">
                                        <h4>Status</h4>
                                        <p><span class="status-badge status-active" id="loanDetailStatus">Active</span></p>
                                    </div>
                                </div>
                            </div>

                            <div class="loan-tabs">
                                <div class="loan-tab active" data-tab="details">Loan Details</div>
                                <div class="loan-tab" data-tab="repayments">Repayment History</div>
                            </div>

                            <div class="loan-content active" id="detailsTab">
                                <div class="info-grid">
                                    <div class="info-card">
                                        <h4>Loan Information</h4>
                                        <p><strong>Loan ID:</strong> <span id="loanDetailIdNumber">LN-0001</span></p>
                                        <p><strong>Date Issued:</strong> <span id="loanDetailDateIssued">January 15, 2024</span></p>
                                        <p><strong>Due Date:</strong> <span id="loanDetailDueDate">April 15, 2024</span></p>
                                        <p><strong>Duration:</strong> <span id="loanDetailDuration">90 days</span></p>
                                    </div>
                                    <div class="info-card">
                                        <h4>Financial Details</h4>
                                        <p><strong>Principal Amount:</strong> <span id="loanDetailPrincipal">TZS 500,000</span></p>
                                        <p><strong>Interest Amount:</strong> <span id="loanDetailInterestAmount">TZS 50,000</span></p>
                                        <p><strong>Total Amount:</strong> <span id="loanDetailTotal">TZS 550,000</span></p>
                                        <p><strong>Amount Repaid:</strong> <span id="loanDetailRepaid">TZS 150,000</span></p>
                                        <p><strong>Remaining Balance:</strong> <span id="loanDetailRemaining">TZS 400,000</span></p>
                                    </div>
                                </div>
                                <div class="info-card">
                                    <h4>Description</h4>
                                    <p id="loanDetailDescription">Small business expansion loan</p>
                                </div>
                            </div>

                            <div class="loan-content" id="repaymentsTab">
                                <div class="table-responsive">
                                    <table id="loanRepaymentsTable">
                                        <thead>
                                            <tr>
                                                <th>Repayment ID</th>
                                                <th>Amount</th>
                                                <th>Date</th>
                                                <th>Method</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Loan's repayments will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="loan-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                                <button class="btn btn-primary" id="editLoanBtn">Edit Loan</button>
                                <button class="btn btn-success" id="addRepaymentToLoanBtn">Add Repayment</button>
                                <button class="btn btn-secondary" id="printLoanBtn">Print Details</button>
                                <button class="btn btn-danger" id="closeLoanDetails">Close Details</button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="loansTable">
                                <thead>
                                    <tr>
                                        <th>Loan ID</th>
                                        <th>Borrower</th>
                                        <th>Amount</th>
                                        <th>Interest</th>
                                        <th>Total Amount</th>
                                        <th>Status</th>
                                        <th>Due Date</th>
                                        <th>Remaining</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Loans will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Repayments Section -->
            <div id="repayments" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3>Repayments Management</h3>
                        <button class="btn btn-primary" id="addRepaymentBtn">Add Repayment</button>
                    </div>
                    <div class="card-body">
                        <!-- Repayment Details Container -->
                        <div id="repaymentDetailsContainer" class="repayment-details-container">
                            <div class="repayment-header">
                                <div class="repayment-info">
                                    <div class="repayment-icon">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </div>
                                    <div class="repayment-text">
                                        <h2 id="repaymentDetailId">RPM-0001</h2>
                                        <p id="repaymentDetailLoan">LN-0001</p>
                                        <p id="repaymentDetailBorrower">John Doe</p>
                                    </div>
                                </div>
                                <div class="repayment-stats">
                                    <div class="repayment-stat">
                                        <h4>Amount</h4>
                                        <p id="repaymentDetailAmount">TZS 50,000</p>
                                    </div>
                                    <div class="repayment-stat">
                                        <h4>Date</h4>
                                        <p id="repaymentDetailDate">April 15, 2024</p>
                                    </div>
                                    <div class="repayment-stat">
                                        <h4>Method</h4>
                                        <p id="repaymentDetailMethod">M-Pesa</p>
                                    </div>
                                    <div class="repayment-stat">
                                        <h4>Status</h4>
                                        <p><span class="status-badge status-completed" id="repaymentDetailStatus">Completed</span></p>
                                    </div>
                                </div>
                            </div>

                            <div class="repayment-tabs">
                                <div class="repayment-tab active" data-tab="details">Repayment Details</div>
                                <div class="repayment-tab" data-tab="receipt">Receipt</div>
                            </div>

                            <div class="repayment-content active" id="detailsTab">
                                <div class="info-grid">
                                    <div class="info-card">
                                        <h4>Repayment Information</h4>
                                        <p><strong>Repayment ID:</strong> <span id="repaymentDetailIdNumber">RPM-0001</span></p>
                                        <p><strong>Loan ID:</strong> <span id="repaymentDetailLoanId">LN-0001</span></p>
                                        <p><strong>Borrower:</strong> <span id="repaymentDetailBorrowerName">John Doe</span></p>
                                        <p><strong>Date:</strong> <span id="repaymentDetailPaymentDate">April 15, 2024</span></p>
                                        <p><strong>Method:</strong> <span id="repaymentDetailPaymentMethod">M-Pesa</span></p>
                                    </div>
                                    <div class="info-card">
                                        <h4>Financial Details</h4>
                                        <p><strong>Total Loan Amount:</strong> <span id="repaymentDetailTotalLoanAmount">TZS 550,000</span></p>
                                        <p><strong>Previously Paid:</strong> <span id="repaymentDetailPreviouslyPaid">TZS 100,000</span></p>
                                        <p><strong>Current Payment:</strong> <span id="repaymentDetailCurrentPayment">TZS 50,000</span></p>
                                        <p><strong>Remaining Balance:</strong> <span id="repaymentDetailRemainingBalance">TZS 400,000</span></p>
                                    </div>
                                </div>
                                <div class="info-card">
                                    <h4>Notes</h4>
                                    <p id="repaymentDetailNotes">First installment</p>
                                </div>
                            </div>

                            <div class="repayment-content" id="receiptTab">
                                <div class="receipt-container">
                                    <div class="receipt-header">
                                        <h2>TanzaniaLoanPro</h2>
                                        <h3>Payment Receipt</h3>
                                        <p id="receiptDate">Date: April 15, 2024</p>
                                        <p id="receiptNumber">Receipt No: RCP-0001</p>
                                    </div>
                                    <div class="receipt-details">
                                        <div>
                                            <p><strong>Borrower:</strong> <span id="receiptBorrower">John Doe</span></p>
                                            <p><strong>Loan ID:</strong> <span id="receiptLoanId">LN-0001</span></p>
                                        </div>
                                        <div>
                                            <p><strong>Payment Date:</strong> <span id="receiptPaymentDate">April 15, 2024</span></p>
                                            <p><strong>Payment Method:</strong> <span id="receiptPaymentMethod">M-Pesa</span></p>
                                        </div>
                                    </div>
                                    <table class="receipt-table">
                                        <thead>
                                            <tr>
                                                <th>Description</th>
                                                <th>Amount (TZS)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Total Loan Amount with Interest</td>
                                                <td id="receiptTotalAmount">550,000</td>
                                            </tr>
                                            <tr>
                                                <td>Previously Paid</td>
                                                <td id="receiptPaidAmount">100,000</td>
                                            </tr>
                                            <tr>
                                                <td>Current Payment</td>
                                                <td id="receiptCurrentPayment">50,000</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Remaining Balance</strong></td>
                                                <td id="receiptRemainingBalance"><strong>400,000</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="receipt-summary">
                                        <p><strong>Amount in Words:</strong> <span id="receiptAmountWords">Fifty Thousand Tanzanian Shillings Only</span></p>
                                        <p><strong>Processed By:</strong> <span id="receiptProcessedBy">John Doe (Admin)</span></p>
                                    </div>
                                    <div class="receipt-actions">
                                        <button class="btn btn-primary" id="printReceiptBtn">Print Receipt</button>
                                        <button class="btn btn-success" id="exportReceiptBtn">Export as PDF</button>
                                    </div>
                                </div>
                            </div>

                            <div class="repayment-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                                <button class="btn btn-primary" id="editRepaymentBtn">Edit Repayment</button>
                                <button class="btn btn-success" id="generateNewReceiptBtn">Generate New Receipt</button>
                                <button class="btn btn-secondary" id="printRepaymentBtn">Print Details</button>
                                <button class="btn btn-danger" id="deleteRepaymentBtn">Delete Repayment</button>
                                <button class="btn btn-danger" id="closeRepaymentDetails">Close Details</button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="repaymentsTable">
                                <thead>
                                    <tr>
                                        <th>Repayment ID</th>
                                        <th>Loan ID</th>
                                        <th>Borrower</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                        <th>Method</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Repayments will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profit Dashboard Section -->
            <div id="profitDashboard" class="section">
                <div class="profit-overview">
                    <div class="profit-card">
                        <i class="fas fa-money-bill-wave profit-icon"></i>
                        <h4>Total Interest Collected</h4>
                        <p id="totalInterestCollected">TZS 0</p>
                    </div>
                    <div class="profit-card">
                        <i class="fas fa-chart-pie profit-icon"></i>
                        <h4>Monthly Profit</h4>
                        <p id="monthlyProfit">TZS 0</p>
                    </div>
                    <div class="profit-card">
                        <i class="fas fa-calendar-alt profit-icon"></i>
                        <h4>Yearly Profit</h4>
                        <p id="yearlyProfit">TZS 0</p>
                    </div>
                    <div class="profit-card">
                        <i class="fas fa-percentage profit-icon"></i>
                        <h4>Profit Margin</h4>
                        <p id="profitMargin">0%</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Profit Analysis</h3>
                        <div class="filter-container">
                            <div class="filter-row">
                                <div class="form-group">
                                    <label for="profitPeriod">Period</label>
                                    <select id="profitPeriod" class="form-control">
                                        <option value="monthly">Monthly</option>
                                        <option value="quarterly">Quarterly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="profitYear">Year</label>
                                    <select id="profitYear" class="form-control">
                                        <option value="2023">2023</option>
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="profitMonth">Month</label>
                                    <select id="profitMonth" class="form-control">
                                        <option value="all">All Months</option>
                                        <option value="1">January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                        <option value="4">April</option>
                                        <option value="5">May</option>
                                        <option value="6">June</option>
                                        <option value="7">July</option>
                                        <option value="8">August</option>
                                        <option value="9">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="profitChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Profit Statement</h3>
                        <div class="report-actions">
                            <button class="btn btn-primary" id="printProfitStatement">Print Statement</button>
                            <button class="btn btn-success" id="exportProfitData">Export Data</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="statement-container">
                            <div class="statement-header">
                                <h3>Profit Statement</h3>
                                <p id="statementPeriod">Period: January 2024</p>
                            </div>
                            <div class="statement-details">
                                <div>
                                    <p><strong>Total Loan Amount:</strong> <span id="statementLoanAmount">TZS 0</span></p>
                                    <p><strong>Total Interest Collected:</strong> <span id="statementInterestCollected">TZS 0</span></p>
                                </div>
                                <div>
                                    <p><strong>Total Profit:</strong> <span id="statementTotalProfit">TZS 0</span></p>
                                    <p><strong>Profit Margin:</strong> <span id="statementProfitMargin">0%</span></p>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="statement-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Loan ID</th>
                                            <th>Borrower</th>
                                            <th>Principal</th>
                                            <th>Interest</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="profitStatementTable">
                                        <!-- Profit statement rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="statement-summary">
                                <h4>Summary</h4>
                                <p><strong>Total Principal:</strong> <span id="summaryPrincipal">TZS 0</span></p>
                                <p><strong>Total Interest:</strong> <span id="summaryInterest">TZS 0</span></p>
                                <p><strong>Total Profit:</strong> <span id="summaryProfit">TZS 0</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3>Reports</h3>
                        <div class="report-actions">
                            <button class="btn btn-primary" id="generateReportBtn">Generate Report</button>
                            <button class="btn btn-success" id="exportReportBtn">Export Report</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="filter-container">
                            <div class="filter-row">
                                <div class="form-group">
                                    <label for="reportType">Report Type</label>
                                    <select id="reportType" class="form-control">
                                        <option value="loans">Loans Report</option>
                                        <option value="repayments">Repayments Report</option>
                                        <option value="borrowers">Borrowers Report</option>
                                        <option value="profit">Profit Report</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="reportPeriod">Period</label>
                                    <select id="reportPeriod" class="form-control">
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month">This Month</option>
                                        <option value="quarter">This Quarter</option>
                                        <option value="year">This Year</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div class="form-group" id="customDateRange" style="display: none;">
                                    <label for="startDate">Start Date</label>
                                    <input type="date" id="startDate" class="form-control">
                                    <label for="endDate">End Date</label>
                                    <input type="date" id="endDate" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="reportsTable">
                                <thead>
                                    <tr>
                                        <th>Report Data</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Report data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3>System Settings</h3>
                    </div>
                    <div class="card-body">
                        <div class="settings-tabs">
                            <div class="settings-tab active" data-tab="general">General</div>
                            <div class="settings-tab" data-tab="notifications">Notifications</div>
                            <div class="settings-tab" data-tab="backup">Backup & Restore</div>
                            <div class="settings-tab" data-tab="users">User Management</div>
                        </div>
                        <div class="settings-content active" id="generalTab">
                            <div class="form-group">
                                <label for="systemName">System Name</label>
                                <input type="text" id="systemName" class="form-control" value="TanzaniaLoanPro">
                            </div>
                            <div class="form-group">
                                <label for="currency">Currency</label>
                                <select id="currency" class="form-control">
                                    <option value="TZS" selected>Tanzanian Shillings (TZS)</option>
                                    <option value="USD">US Dollars (USD)</option>
                                    <option value="EUR">Euros (EUR)</option>
                                    <option value="GBP">British Pounds (GBP)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dateFormat">Date Format</label>
                                <select id="dateFormat" class="form-control">
                                    <option value="dd/mm/yyyy" selected>DD/MM/YYYY</option>
                                    <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                                    <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="language">Language</label>
                                <select id="language" class="form-control">
                                    <option value="en" selected>English</option>
                                    <option value="sw">Swahili</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="interestCalculation">Interest Calculation Method</label>
                                <select id="interestCalculation" class="form-control">
                                    <option value="simple" selected>Simple Interest</option>
                                    <option value="compound">Compound Interest</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="defaultLoanDuration">Default Loan Duration (Days)</label>
                                <input type="number" id="defaultLoanDuration" class="form-control" value="90" min="1" max="365">
                            </div>
                            <div class="form-group">
                                <label for="defaultInterestRate">Default Interest Rate (%)</label>
                                <input type="number" id="defaultInterestRate" class="form-control" value="10" min="1" max="50" step="0.1">
                            </div>
                            <button class="btn btn-primary" id="saveGeneralSettings">Save General Settings</button>
                        </div>
                        <div class="settings-content" id="notificationsTab">
                            <div class="form-group">
                                <label class="form-check">
                                    <input type="checkbox" class="form-check-input" id="emailNotifications" checked>
                                    <label class="form-check-label" for="emailNotifications">Email Notifications</label>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-check">
                                    <input type="checkbox" class="form-check-input" id="smsNotifications" checked>
                                    <label class="form-check-label" for="smsNotifications">SMS Notifications</label>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-check">
                                    <input type="checkbox" class="form-check-input" id="paymentReminders" checked>
                                    <label class="form-check-label" for="paymentReminders">Payment Reminders</label>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-check">
                                    <input type="checkbox" class="form-check-input" id="overdueAlerts" checked>
                                    <label class="form-check-label" for="overdueAlerts">Overdue Alerts</label>
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="reminderDays">Reminder Days Before Due Date</label>
                                <input type="number" id="reminderDays" class="form-control" min="1" max="30" value="3">
                            </div>
                            <div class="form-group">
                                <label for="smsApiKey">SMS API Key</label>
                                <input type="text" id="smsApiKey" class="form-control" placeholder="Enter SMS API Key">
                            </div>
                            <div class="form-group">
                                <label for="emailServer">Email Server</label>
                                <input type="text" id="emailServer" class="form-control" placeholder="Enter Email Server">
                            </div>
                            <button class="btn btn-primary" id="saveNotificationSettings">Save Notification Settings</button>
                        </div>
                        <div class="settings-content" id="backupTab">
                            <div class="form-group">
                                <h4>Backup Data</h4>
                                <p>Backup your data to prevent data loss. It's recommended to backup your data regularly.</p>
                                <button type="button" class="btn btn-primary" id="backupDataBtn">Backup Now</button>
                            </div>
                            <div class="form-group">
                                <h4>Restore Data</h4>
                                <p>Restore your data from a previous backup. This will replace all current data.</p>
                                <input type="file" id="restoreFile" class="form-control" accept=".json">
                                <button type="button" class="btn btn-success" id="restoreDataBtn" style="margin-top: 10px;">Restore Data</button>
                            </div>
                            <div class="form-group">
                                <h4>Auto Backup</h4>
                                <label class="form-check">
                                    <input type="checkbox" class="form-check-input" id="autoBackup">
                                    <label class="form-check-label" for="autoBackup">Enable Auto Backup</label>
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="backupFrequency">Backup Frequency</label>
                                <select id="backupFrequency" class="form-control">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="saveBackupSettings">Save Backup Settings</button>
                        </div>
                        <div class="settings-content" id="usersTab">
                            <div class="form-group">
                                <h4>User Management</h4>
                                <p>Manage system users and their permissions.</p>
                                <button type="button" class="btn btn-primary" id="addUserBtn">Add New User</button>
                            </div>
                            <div class="table-responsive">
                                <table id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Full Name</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Last Login</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>admin</td>
                                            <td>System Administrator</td>
                                            <td><span class="role-badge role-admin">Admin</span></td>
                                            <td><span class="status-badge status-active">Active</span></td>
                                            <td>2024-04-15 10:30 AM</td>
                                            <td>
                                                <button class="action-button edit-button"><i class="fas fa-edit"></i></button>
                                                <button class="action-button delete-button"><i class="fas fa-trash"></i></button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>manager</td>
                                            <td>Loan Manager</td>
                                            <td><span class="role-badge role-manager">Manager</span></td>
                                            <td><span class="status-badge status-active">Active</span></td>
                                            <td>2024-04-14 02:15 PM</td>
                                            <td>
                                                <button class="action-button edit-button"><i class="fas fa-edit"></i></button>
                                                <button class="action-button delete-button"><i class="fas fa-trash"></i></button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Help Section -->
            <div id="help" class="section">
                <div class="help-container">
                    <h2>Help Center</h2>
                    <p style="margin-bottom: 30px; color: var(--text-light);">Learn how to use TanzaniaLoanPro effectively</p>
                    
                    <div class="help-section">
                        <h3>Getting Started</h3>
                        <div class="help-item">
                            <h4>Login and Role Management</h4>
                            <p>The system uses role-based access control. Different roles have different permissions:</p>
                            <ul class="help-steps">
                                <li><strong>Admin:</strong> Full access to all features and user management</li>
                                <li><strong>Manager:</strong> Can manage borrowers, loans, and view reports</li>
                                <li><strong>Loan Officer:</strong> Can add borrowers and process loans</li>
                                <li><strong>Accountant:</strong> Can manage repayments and view profit dashboard</li>
                                <li><strong>Viewer:</strong> Read-only access to view data</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h3>Managing Borrowers</h3>
                        <div class="help-item">
                            <h4>Adding a New Borrower</h4>
                            <ol class="help-steps">
                                <li>Navigate to the Borrowers section</li>
                                <li>Click the "Add Borrower" button</li>
                                <li>Fill in the borrower's personal information</li>
                                <li>Upload identification documents if needed</li>
                                <li>Save the borrower record</li>
                            </ol>
                        </div>
                        
                        <div class="help-item">
                            <h4>Viewing Borrower Details</h4>
                            <p>Click the "View" button (eye icon) next to any borrower in the borrowers table to see detailed information including:</p>
                            <ul class="help-steps">
                                <li>Personal information and contact details</li>
                                <li>Loan history and status</li>
                                <li>Repayment history</li>
                                <li>Repayment schedule</li>
                            </ul>
                        </div>
                        
                        <div class="help-item">
                            <h4>Editing Borrower Information</h4>
                            <p>Click the edit button next to a borrower's record to update their information.</p>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h3>Loan Management</h3>
                        <div class="help-item">
                            <h4>Creating a New Loan</h4>
                            <ol class="help-steps">
                                <li>Navigate to the Loans section</li>
                                <li>Click the "Add Loan" button</li>
                                <li>Select the borrower from the dropdown</li>
                                <li>Enter the loan amount and interest rate</li>
                                <li>Set the loan term and repayment schedule</li>
                                <li>Review and save the loan</li>
                            </ol>
                        </div>
                        
                        <div class="help-item">
                            <h4>Tracking Loan Status</h4>
                            <p>Loans can have different statuses:</p>
                            <ul class="help-steps">
                                <li><span class="status-active">Active</span> - Loan is currently active and being repaid</li>
                                <li><span class="status-pending">Pending</span> - Loan application is being processed</li>
                                <li><span class="status-overdue">Overdue</span> - Loan has missed repayment deadlines</li>
                                <li><span class="status-completed">Completed</span> - Loan has been fully repaid</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h3>Profit Dashboard</h3>
                        <div class="help-item">
                            <h4>Understanding the Profit Dashboard</h4>
                            <p>The Profit Dashboard is designed for accountants to track financial performance:</p>
                            <ul class="help-steps">
                                <li><strong>Total Interest Collected:</strong> Sum of all interest payments received</li>
                                <li><strong>Monthly/Yearly Profit:</strong> Profit generated in specific time periods</li>
                                <li><strong>Profit Margin:</strong> Percentage of profit relative to total loan amount</li>
                                <li><strong>Profit Analysis Chart:</strong> Visual representation of profit trends</li>
                                <li><strong>Profit Statement:</strong> Detailed breakdown of profit sources</li>
                            </ul>
                        </div>
                        
                        <div class="help-item">
                            <h4>Generating Profit Reports</h4>
                            <p>Use the filters on the Profit Dashboard to generate reports for specific periods. You can also print or export these reports for further analysis.</p>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h3>System Features</h3>
                        <div class="help-item">
                            <h4>Dark Mode</h4>
                            <p>Toggle between light and dark mode using the moon icon in the header.</p>
                        </div>
                        
                        <div class="help-item">
                            <h4>Responsive Design</h4>
                            <p>The system is optimized for all devices including phones, tablets, and desktops.</p>
                        </div>
                        
                        <div class="help-item">
                            <h4>Print and Export</h4>
                            <p>Most reports and statements can be printed or exported for external use.</p>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h3>Need More Help?</h3>
                        <div class="help-item">
                            <p>If you need additional assistance, please contact your system administrator or refer to the user manual.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Borrower Modal -->
    <div id="addBorrowerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Borrower</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addBorrowerForm">
                    <div class="input-group-row">
                        <div class="form-group">
                            <label for="borrowerFullName">Full Name *</label>
                            <input type="text" id="borrowerFullName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="borrowerPhone">Phone Number *</label>
                            <input type="tel" id="borrowerPhone" class="form-control" required>
                        </div>
                    </div>
                    <div class="input-group-row">
                        <div class="form-group">
                            <label for="borrowerEmail">Email Address (Optional)</label>
                            <input type="email" id="borrowerEmail" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="borrowerOccupation">Occupation</label>
                            <input type="text" id="borrowerOccupation" class="form-control">
                        </div>
                    </div>
                    <div class="input-group-row">
                        <div class="form-group">
                            <label for="borrowerAddress">Address</label>
                            <input type="text" id="borrowerAddress" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="borrowerGuarantorName">Guarantor Name</label>
                            <input type="text" id="borrowerGuarantorName" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="borrowerGuarantorPhone">Guarantor Phone</label>
                        <input type="tel" id="borrowerGuarantorPhone" class="form-control">
                    </div>
                    <div class="photo-upload">
                        <div class="photo-placeholder" id="borrowerPhotoPlaceholder">
                            <i class="fas fa-user"></i>
                        </div>
                        <input type="file" id="borrowerPhoto" accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-secondary" id="uploadPhotoBtn">Upload Photo</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelBorrowerBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBorrowerBtn">Save Borrower</button>
            </div>
        </div>
    </div>

    <!-- Add Loan Modal -->
    <div id="addLoanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Loan</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addLoanForm">
                    <div class="form-group">
                        <label for="loanBorrower">Select Borrower *</label>
                        <select id="loanBorrower" class="form-control" required>
                            <option value="">Select a borrower</option>
                        </select>
                    </div>
                    <div class="input-group-row">
                        <div class="form-group">
                            <label for="loanAmount">Loan Amount (TZS) *</label>
                            <input type="number" id="loanAmount" class="form-control" required min="1000">
                        </div>
                        <div class="form-group">
                            <label for="loanInterest">Interest Rate (%) *</label>
                            <input type="number" id="loanInterest" class="form-control" required min="1" max="50" step="0.1">
                        </div>
                    </div>
                    <div class="input-group-row">
                        <div class="form-group">
                            <label for="loanDuration">Loan Duration (Days) *</label>
                            <input type="number" id="loanDuration" class="form-control" required min="1" max="365">
                        </div>
                        <div class="form-group">
                            <label for="loanPurpose">Loan Purpose</label>
                            <select id="loanPurpose" class="form-control">
                                <option value="Business">Business</option>
                                <option value="Education">Education</option>
                                <option value="Emergency">Emergency</option>
                                <option value="Home Improvement">Home Improvement</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="loanDescription">Description</label>
                        <textarea id="loanDescription" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="info-card">
                            <h4>Loan Summary</h4>
                            <p><strong>Loan Amount:</strong> <span id="loanAmountDisplay">TZS 0</span></p>
                            <p><strong>Interest Amount:</strong> <span id="interestAmountDisplay">TZS 0</span></p>
                            <p><strong>Total Loan Amount:</strong> <span id="totalLoanAmountDisplay">TZS 0</span></p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelLoanBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveLoanBtn">Save Loan</button>
            </div>
        </div>
    </div>

    <!-- Add Repayment Modal -->
    <div id="addRepaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Repayment</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addRepaymentForm">
                    <div class="form-group">
                        <label for="repaymentLoan">Select Loan *</label>
                        <select id="repaymentLoan" class="form-control" required>
                            <option value="">Select a loan</option>
                        </select>
                    </div>
                    <div class="input-group-row">
                        <div class="form-group">
                            <label for="repaymentAmount">Amount (TZS) *</label>
                            <input type="number" id="repaymentAmount" class="form-control" required min="1000">
                        </div>
                        <div class="form-group">
                            <label for="repaymentDate">Date *</label>
                            <input type="date" id="repaymentDate" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="repaymentMethod">Payment Method *</label>
                        <select id="repaymentMethod" class="form-control" required>
                            <option value="M-Pesa">M-Pesa</option>
                            <option value="Tigo Pesa">Tigo Pesa</option>
                            <option value="Airtel Money">Airtel Money</option>
                            <option value="Halo Pesa">Halo Pesa</option>
                            <option value="Cash">Cash</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Check">Check</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="repaymentNotes">Notes</label>
                        <textarea id="repaymentNotes" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="info-card">
                            <h4>Loan Summary</h4>
                            <p><strong>Total Loan Amount:</strong> <span id="repaymentTotalAmount">TZS 0</span></p>
                            <p><strong>Amount Paid:</strong> <span id="repaymentAmountPaid">TZS 0</span></p>
                            <p><strong>Remaining Balance:</strong> <span id="repaymentRemainingBalance">TZS 0</span></p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelRepaymentBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveRepaymentBtn">Save Repayment</button>
                <button type="button" class="btn btn-success" id="generateReceiptBtn" style="display: none;">Generate Receipt</button>
            </div>
        </div>
    </div>

    <!-- Edit Borrower Modal -->
    <div id="editBorrowerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Borrower</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editBorrowerForm">
                    <input type="hidden" id="editBorrowerId">
                    <div class="input-group-row">
                        <div class="form-group">
                            <label for="editBorrowerFullName">Full Name *</label>
                            <input type="text" id="editBorrowerFullName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="editBorrowerPhone">Phone Number *</label>
                            <input type="tel" id="editBorrowerPhone" class="form-control" required>
                        </div>
                    </div>
                    <div class="input-group-row">
                        <div class="form-group">
                            <label for="editBorrowerEmail">Email Address (Optional)</label>
                            <input type="email" id="editBorrowerEmail" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="editBorrowerOccupation">Occupation</label>
                            <input type="text" id="editBorrowerOccupation" class="form-control">
                        </div>
                    </div>
                    <div class="input-group-row">
                        <div class="form-group">
                            <label for="editBorrowerAddress">Address</label>
                            <input type="text" id="editBorrowerAddress" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="editBorrowerGuarantorName">Guarantor Name</label>
                            <input type="text" id="editBorrowerGuarantorName" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editBorrowerGuarantorPhone">Guarantor Phone</label>
                        <input type="tel" id="editBorrowerGuarantorPhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editBorrowerStatus">Status</label>
                        <select id="editBorrowerStatus" class="form-control">
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="photo-upload">
                        <div class="photo-placeholder" id="editBorrowerPhotoPlaceholder">
                            <i class="fas fa-user"></i>
                        </div>
                        <input type="file" id="editBorrowerPhoto" accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-secondary" id="editUploadPhotoBtn">Upload Photo</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelEditBorrowerBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateBorrowerBtn">Update Borrower</button>
            </div>
        </div>
    </div>

    <!-- Edit Loan Modal -->
    <div id="editLoanModal" class="edit-loan-modal">
        <div class="edit-loan-modal-content">
            <div class="modal-header">
                <h3>Edit Loan</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editLoanForm">
                    <input type="hidden" id="editLoanId">
                    <div class="form-group">
                        <label for="editLoanBorrower">Borrower</label>
                        <input type="text" id="editLoanBorrower" class="form-control" readonly>
                    </div>
                    <div class="input-group-row">
                        <div class="form-group">
                            <label for="editLoanAmount">Loan Amount (TZS) *</label>
                            <input type="number" id="editLoanAmount" class="form-control" required min="1000">
                        </div>
                        <div class="form-group">
                            <label for="editLoanInterest">Interest Rate (%) *</label>
                            <input type="number" id="editLoanInterest" class="form-control" required min="1" max="50" step="0.1">
                        </div>
                    </div>
                    <div class="input-group-row">
                        <div class="form-group">
                            <label for="editLoanDuration">Loan Duration (Days) *</label>
                            <input type="number" id="editLoanDuration" class="form-control" required min="1" max="365">
                        </div>
                        <div class="form-group">
                            <label for="editLoanPurpose">Loan Purpose</label>
                            <select id="editLoanPurpose" class="form-control">
                                <option value="Business">Business</option>
                                <option value="Education">Education</option>
                                <option value="Emergency">Emergency</option>
                                <option value="Home Improvement">Home Improvement</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editLoanDescription">Description</label>
                        <textarea id="editLoanDescription" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editLoanStatus">Status</label>
                        <select id="editLoanStatus" class="form-control">
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="overdue">Overdue</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="info-card">
                            <h4>Loan Summary</h4>
                            <p><strong>Loan Amount:</strong> <span id="editLoanAmountDisplay">TZS 0</span></p>
                            <p><strong>Interest Amount:</strong> <span id="editInterestAmountDisplay">TZS 0</span></p>
                            <p><strong>Total Loan Amount:</strong> <span id="editTotalLoanAmountDisplay">TZS 0</span></p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelEditLoanBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateLoanBtn">Update Loan</button>
            </div>
        </div>
    </div>

    <!-- Edit Repayment Modal -->
    <div id="editRepaymentModal" class="edit-repayment-modal">
        <div class="edit-repayment-modal-content">
            <div class="modal-header">
                <h3>Edit Repayment</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editRepaymentForm">
                    <input type="hidden" id="editRepaymentId">
                    <div class="form-group">
                        <label for="editRepaymentLoan">Loan</label>
                        <input type="text" id="editRepaymentLoan" class="form-control" readonly>
                    </div>
                    <div class="input-group-row">
                        <div class="form-group">
                            <label for="editRepaymentAmount">Amount (TZS) *</label>
                            <input type="number" id="editRepaymentAmount" class="form-control" required min="1000">
                        </div>
                        <div class="form-group">
                            <label for="editRepaymentDate">Date *</label>
                            <input type="date" id="editRepaymentDate" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editRepaymentMethod">Payment Method *</label>
                        <select id="editRepaymentMethod" class="form-control" required>
                            <option value="M-Pesa">M-Pesa</option>
                            <option value="Tigo Pesa">Tigo Pesa</option>
                            <option value="Airtel Money">Airtel Money</option>
                            <option value="Halo Pesa">Halo Pesa</option>
                            <option value="Cash">Cash</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Check">Check</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editRepaymentNotes">Notes</label>
                        <textarea id="editRepaymentNotes" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelEditRepaymentBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateRepaymentBtn">Update Repayment</button>
            </div>
        </div>
    </div>

    <!-- SMS Modal -->
    <div id="smsModal" class="sms-modal">
        <div class="sms-modal-content">
            <div class="modal-header">
                <h3>Send SMS</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="sms-recipient">
                    <h4>Recipient</h4>
                    <p id="smsRecipientName">John Doe</p>
                    <p id="smsRecipientPhone">+255 712 345 678</p>
                </div>
                <div class="sms-templates">
                    <h4>Message Templates</h4>
                    <div class="select-options">
                        <div class="select-option" data-template="reminder">Payment Reminder</div>
                        <div class="select-option" data-template="overdue">Overdue Notice</div>
                        <div class="select-option" data-template="welcome">Welcome Message</div>
                        <div class="select-option" data-template="custom">Custom Message</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="smsMessage">Message</label>
                    <textarea id="smsMessage" class="sms-textarea" maxlength="160"></textarea>
                    <div class="sms-counter">
                        <span id="smsCounter">0</span>/160 characters
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelSmsBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendSmsBtn">Send SMS</button>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="userProfileModal" class="user-profile-modal">
        <div class="user-profile-modal-content">
            <div class="modal-header">
                <h3>User Profile</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="profile-photo-section">
                    <div class="profile-photo" id="userProfilePhoto">
                        <i class="fas fa-user"></i>
                    </div>
                    <input type="file" id="userProfilePhotoInput" accept="image/*" style="display: none;">
                    <button type="button" class="btn btn-secondary" id="changeProfilePhotoBtn">Change Photo</button>
                </div>
                <form id="userProfileForm">
                    <div class="input-group-row">
                        <div class="form-group">
                            <label for="userFullName">Full Name *</label>
                            <input type="text" id="userFullName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="userUsername">Username *</label>
                            <input type="text" id="userUsername" class="form-control" required>
                        </div>
                    </div>
                    <div class="input-group-row">
                        <div class="form-group">
                            <label for="userEmail">Email Address</label>
                            <input type="email" id="userEmail" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="userPhone">Phone Number</label>
                            <input type="tel" id="userPhone" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="userRole">Role</label>
                        <select id="userRole" class="form-control" disabled>
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                            <option value="loan_officer">Loan Officer</option>
                            <option value="accountant">Accountant</option>
                            <option value="viewer">Viewer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userBio">Bio</label>
                        <textarea id="userBio" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelUserProfileBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveUserProfileBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Export Data Modal -->
    <div id="exportModal" class="export-modal">
        <div class="export-modal-content">
            <div class="modal-header">
                <h3>Export Data</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select data to export:</label>
                    <div class="export-options">
                        <div class="export-option" data-type="borrowers">
                            <i class="fas fa-users"></i>
                            <h4>Borrowers</h4>
                            <p>Export all borrower data</p>
                        </div>
                        <div class="export-option" data-type="loans">
                            <i class="fas fa-hand-holding-usd"></i>
                            <h4>Loans</h4>
                            <p>Export all loan data</p>
                        </div>
                        <div class="export-option" data-type="repayments">
                            <i class="fas fa-money-bill-wave"></i>
                            <h4>Repayments</h4>
                            <p>Export all repayment data</p>
                        </div>
                        <div class="export-option" data-type="all">
                            <i class="fas fa-database"></i>
                            <h4>All Data</h4>
                            <p>Export complete database</p>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="exportFormat">Export Format</label>
                    <select id="exportFormat" class="form-control">
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="exportDateRange">Date Range</label>
                    <select id="exportDateRange" class="form-control">
                        <option value="all">All Data</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div class="form-group" id="customExportDateRange" style="display: none;">
                    <div class="input-group-row">
                        <div>
                            <label for="exportStartDate">Start Date</label>
                            <input type="date" id="exportStartDate" class="form-control">
                        </div>
                        <div>
                            <label for="exportEndDate">End Date</label>
                            <input type="date" id="exportEndDate" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelExportBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmExportBtn">Export Data</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Floating Action Button -->
    <div class="fab-container" id="fabContainer">
        <div class="fab" id="mainFab">
            <i class="fas fa-plus"></i>
        </div>
        <div class="fab-menu" id="fabMenu">
            <a href="#" class="fab-item" id="fabAddBorrower">
                <i class="fas fa-user-plus"></i>
                <span>Add Borrower</span>
            </a>
            <a href="#" class="fab-item" id="fabAddLoan">
                <i class="fas fa-hand-holding-usd"></i>
                <span>Add Loan</span>
            </a>
            <a href="#" class="fab-item" id="fabAddRepayment">
                <i class="fas fa-money-bill-wave"></i>
                <span>Add Repayment</span>
            </a>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Loading, please wait...</p>
        </div>
    </div>

<script>
    // Enhanced sample data for the application
    let borrowers = JSON.parse(localStorage.getItem('borrowers')) || [];
    let loans = JSON.parse(localStorage.getItem('loans')) || [];
    let repayments = JSON.parse(localStorage.getItem('repayments')) || [];
    let notifications = JSON.parse(localStorage.getItem('notifications')) || [];

    // SMS Templates
    const smsTemplates = {
        reminder: "Dear {name}, this is a reminder that your loan payment of {amount} TZS is due on {date}. Please make your payment on time to avoid late fees. Thank you.",
        overdue: "Dear {name}, your loan payment of {amount} TZS was due on {date}. Please make your payment as soon as possible to avoid additional charges. Contact us if you need assistance.",
        welcome: "Dear {name}, welcome to TanzaniaLoanPro! Your loan application has been approved. Your loan amount is {amount} TZS with an interest rate of {interest}%. Thank you for choosing us.",
        custom: ""
    };

    // System settings
    let systemSettings = JSON.parse(localStorage.getItem('systemSettings')) || {
        systemName: "TanzaniaLoanPro",
        currency: "TZS",
        dateFormat: "dd/mm/yyyy",
        language: "en",
        emailNotifications: true,
        smsNotifications: true,
        paymentReminders: true,
        overdueAlerts: true,
        reminderDays: 3,
        autoBackup: false,
        backupFrequency: "weekly",
        interestCalculation: "simple",
        defaultLoanDuration: 90,
        defaultInterestRate: 10
    };

    // Current user information
    let currentUser = JSON.parse(localStorage.getItem('currentUser')) || {
        username: "",
        role: "",
        name: "",
        email: "",
        phone: "",
        photo: null,
        bio: ""
    };

    // Currently selected borrower for details view
    let currentBorrowerId = null;

    // Currently selected loan for details view
    let currentLoanId = null;

    // Currently selected repayment for details view
    let currentRepaymentId = null;

    // DOM Elements
    const loginSection = document.getElementById('loginSection');
    const mainApp = document.getElementById('mainApp');
    const loginForm = document.getElementById('loginForm');
    const logoutBtn = document.getElementById('logoutBtn');
    const themeToggle = document.getElementById('themeToggle');
    const notification = document.getElementById('notification');
    const sections = document.querySelectorAll('.section');
    const navLinks = document.querySelectorAll('.nav-link');
    const currentDate = document.getElementById('dateDisplay');
    const userRole = document.getElementById('userRole');
    const userName = document.getElementById('userName');
    const userPhoto = document.getElementById('userPhoto');
    const userProfile = document.getElementById('userProfile');
    const userProfileMenu = document.getElementById('userProfileMenu');
    const profileName = document.getElementById('profileName');
    const profileRole = document.getElementById('profileRole');
    const profileLogout = document.getElementById('profileLogout');
    const viewProfileBtn = document.getElementById('viewProfileBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const exportDataBtn = document.getElementById('exportDataBtn');

    // Notification Elements
    const notificationIcon = document.getElementById('notificationIcon');
    const notificationBadge = document.getElementById('notificationBadge');
    const notificationPanel = document.getElementById('notificationPanel');
    const notificationList = document.getElementById('notificationList');
    const clearNotifications = document.getElementById('clearNotifications');

    // Borrower Details Elements
    const borrowerDetailsContainer = document.getElementById('borrowerDetailsContainer');
    const borrowerDetailPhoto = document.getElementById('borrowerDetailPhoto');
    const borrowerDetailName = document.getElementById('borrowerDetailName');
    const borrowerDetailContact = document.getElementById('borrowerDetailContact');
    const borrowerDetailId = document.getElementById('borrowerDetailId');
    const borrowerDetailTotalLoans = document.getElementById('borrowerDetailTotalLoans');
    const borrowerDetailActiveLoans = document.getElementById('borrowerDetailActiveLoans');
    const borrowerDetailTotalLoanAmount = document.getElementById('borrowerDetailTotalLoanAmount');
    const borrowerDetailRemainingBalance = document.getElementById('borrowerDetailRemainingBalance');
    const borrowerDetailStatus = document.getElementById('borrowerDetailStatus');
    const borrowerDetailPhone = document.getElementById('borrowerDetailPhone');
    const borrowerDetailEmail = document.getElementById('borrowerDetailEmail');
    const borrowerDetailAddress = document.getElementById('borrowerDetailAddress');
    const borrowerDetailIdNumber = document.getElementById('borrowerDetailIdNumber');
    const borrowerDetailOccupation = document.getElementById('borrowerDetailOccupation');
    const borrowerDetailGuarantor = document.getElementById('borrowerDetailGuarantor');
    const borrowerDetailGuarantorPhone = document.getElementById('borrowerDetailGuarantorPhone');
    const borrowerDetailMemberSince = document.getElementById('borrowerDetailMemberSince');
    const borrowerDetailCreditScore = document.getElementById('borrowerDetailCreditScore');
    const borrowerDetailLastUpdated = document.getElementById('borrowerDetailLastUpdated');
    const borrowerTabs = document.querySelectorAll('.borrower-tab');
    const borrowerContents = document.querySelectorAll('.borrower-content');
    const borrowerLoansTable = document.getElementById('borrowerLoansTable').getElementsByTagName('tbody')[0];
    const borrowerRepaymentsTable = document.getElementById('borrowerRepaymentsTable').getElementsByTagName('tbody')[0];
    const closeBorrowerDetails = document.getElementById('closeBorrowerDetails');

    // Loan Details Elements
    const loanDetailsContainer = document.getElementById('loanDetailsContainer');
    const loanDetailId = document.getElementById('loanDetailId');
    const loanDetailBorrower = document.getElementById('loanDetailBorrower');
    const loanDetailPurpose = document.getElementById('loanDetailPurpose');
    const loanDetailAmount = document.getElementById('loanDetailAmount');
    const loanDetailInterest = document.getElementById('loanDetailInterest');
    const loanDetailTotalAmount = document.getElementById('loanDetailTotalAmount');
    const loanDetailStatus = document.getElementById('loanDetailStatus');
    const loanDetailIdNumber = document.getElementById('loanDetailIdNumber');
    const loanDetailDateIssued = document.getElementById('loanDetailDateIssued');
    const loanDetailDueDate = document.getElementById('loanDetailDueDate');
    const loanDetailDuration = document.getElementById('loanDetailDuration');
    const loanDetailPrincipal = document.getElementById('loanDetailPrincipal');
    const loanDetailInterestAmount = document.getElementById('loanDetailInterestAmount');
    const loanDetailTotal = document.getElementById('loanDetailTotal');
    const loanDetailRepaid = document.getElementById('loanDetailRepaid');
    const loanDetailRemaining = document.getElementById('loanDetailRemaining');
    const loanDetailDescription = document.getElementById('loanDetailDescription');
    const loanTabs = document.querySelectorAll('.loan-tab');
    const loanContents = document.querySelectorAll('.loan-content');
    const loanRepaymentsTable = document.getElementById('loanRepaymentsTable').getElementsByTagName('tbody')[0];
    const closeLoanDetails = document.getElementById('closeLoanDetails');

    // Repayment Details Elements
    const repaymentDetailsContainer = document.getElementById('repaymentDetailsContainer');
    const repaymentDetailId = document.getElementById('repaymentDetailId');
    const repaymentDetailLoan = document.getElementById('repaymentDetailLoan');
    const repaymentDetailBorrower = document.getElementById('repaymentDetailBorrower');
    const repaymentDetailAmount = document.getElementById('repaymentDetailAmount');
    const repaymentDetailDate = document.getElementById('repaymentDetailDate');
    const repaymentDetailMethod = document.getElementById('repaymentDetailMethod');
    const repaymentDetailStatus = document.getElementById('repaymentDetailStatus');
    const repaymentDetailIdNumber = document.getElementById('repaymentDetailIdNumber');
    const repaymentDetailLoanId = document.getElementById('repaymentDetailLoanId');
    const repaymentDetailBorrowerName = document.getElementById('repaymentDetailBorrowerName');
    const repaymentDetailPaymentDate = document.getElementById('repaymentDetailPaymentDate');
    const repaymentDetailPaymentMethod = document.getElementById('repaymentDetailPaymentMethod');
    const repaymentDetailTotalLoanAmount = document.getElementById('repaymentDetailTotalLoanAmount');
    const repaymentDetailPreviouslyPaid = document.getElementById('repaymentDetailPreviouslyPaid');
    const repaymentDetailCurrentPayment = document.getElementById('repaymentDetailCurrentPayment');
    const repaymentDetailRemainingBalance = document.getElementById('repaymentDetailRemainingBalance');
    const repaymentDetailNotes = document.getElementById('repaymentDetailNotes');
    const repaymentTabs = document.querySelectorAll('.repayment-tab');
    const repaymentContents = document.querySelectorAll('.repayment-content');
    const closeRepaymentDetails = document.getElementById('closeRepaymentDetails');
    const deleteRepaymentBtn = document.getElementById('deleteRepaymentBtn');

    // Modal Elements
    const modals = document.querySelectorAll('.modal');
    const closeModalButtons = document.querySelectorAll('.close-modal');
    const addBorrowerModal = document.getElementById('addBorrowerModal');
    const addLoanModal = document.getElementById('addLoanModal');
    const addRepaymentModal = document.getElementById('addRepaymentModal');
    const editBorrowerModal = document.getElementById('editBorrowerModal');
    const editLoanModal = document.getElementById('editLoanModal');
    const editRepaymentModal = document.getElementById('editRepaymentModal');
    const smsModal = document.getElementById('smsModal');
    const userProfileModal = document.getElementById('userProfileModal');
    const exportModal = document.getElementById('exportModal');
    const addBorrowerBtn = document.getElementById('addBorrowerBtn');
    const addLoanBtn = document.getElementById('addLoanBtn');
    const addRepaymentBtn = document.getElementById('addRepaymentBtn');
    const saveBorrowerBtn = document.getElementById('saveBorrowerBtn');
    const saveLoanBtn = document.getElementById('saveLoanBtn');
    const saveRepaymentBtn = document.getElementById('saveRepaymentBtn');
    const cancelBorrowerBtn = document.getElementById('cancelBorrowerBtn');
    const cancelLoanBtn = document.getElementById('cancelLoanBtn');
    const cancelRepaymentBtn = document.getElementById('cancelRepaymentBtn');
    const updateBorrowerBtn = document.getElementById('updateBorrowerBtn');
    const cancelEditBorrowerBtn = document.getElementById('cancelEditBorrowerBtn');
    const updateLoanBtn = document.getElementById('updateLoanBtn');
    const cancelEditLoanBtn = document.getElementById('cancelEditLoanBtn');
    const updateRepaymentBtn = document.getElementById('updateRepaymentBtn');
    const cancelEditRepaymentBtn = document.getElementById('cancelEditRepaymentBtn');
    const generateReceiptBtn = document.getElementById('generateReceiptBtn');
    const cancelSmsBtn = document.getElementById('cancelSmsBtn');
    const sendSmsBtn = document.getElementById('sendSmsBtn');
    const cancelUserProfileBtn = document.getElementById('cancelUserProfileBtn');
    const saveUserProfileBtn = document.getElementById('saveUserProfileBtn');
    const cancelExportBtn = document.getElementById('cancelExportBtn');
    const confirmExportBtn = document.getElementById('confirmExportBtn');

    // Receipt Elements
    const receiptContainer = document.getElementById('receiptContainer');
    const receiptDate = document.getElementById('receiptDate');
    const receiptNumber = document.getElementById('receiptNumber');
    const receiptBorrower = document.getElementById('receiptBorrower');
    const receiptLoanId = document.getElementById('receiptLoanId');
    const receiptPaymentDate = document.getElementById('receiptPaymentDate');
    const receiptPaymentMethod = document.getElementById('receiptPaymentMethod');
    const receiptTotalAmount = document.getElementById('receiptTotalAmount');
    const receiptPaidAmount = document.getElementById('receiptPaidAmount');
    const receiptCurrentPayment = document.getElementById('receiptCurrentPayment');
    const receiptRemainingBalance = document.getElementById('receiptRemainingBalance');
    const receiptAmountWords = document.getElementById('receiptAmountWords');
    const receiptProcessedBy = document.getElementById('receiptProcessedBy');
    const printReceiptBtn = document.getElementById('printReceiptBtn');
    const exportReceiptBtn = document.getElementById('exportReceiptBtn');
    const closeReceiptBtn = document.getElementById('closeReceiptBtn');

    // FAB Elements
    const mainFab = document.getElementById('mainFab');
    const fabMenu = document.getElementById('fabMenu');
    const fabContainer = document.getElementById('fabContainer');
    const fabAddBorrower = document.getElementById('fabAddBorrower');
    const fabAddLoan = document.getElementById('fabAddLoan');
    const fabAddRepayment = document.getElementById('fabAddRepayment');

    // Loan Form Elements
    const loanAmountInput = document.getElementById('loanAmount');
    const loanInterestInput = document.getElementById('loanInterest');
    const loanAmountDisplay = document.getElementById('loanAmountDisplay');
    const interestAmountDisplay = document.getElementById('interestAmountDisplay');
    const totalLoanAmountDisplay = document.getElementById('totalLoanAmountDisplay');

    // Repayment Form Elements
    const repaymentLoanSelect = document.getElementById('repaymentLoan');
    const repaymentAmountInput = document.getElementById('repaymentAmount');
    const repaymentDateInput = document.getElementById('repaymentDate');
    const repaymentTotalAmount = document.getElementById('repaymentTotalAmount');
    const repaymentAmountPaid = document.getElementById('repaymentAmountPaid');
    const repaymentRemainingBalance = document.getElementById('repaymentRemainingBalance');

    // Edit Borrower Form Elements
    const editBorrowerId = document.getElementById('editBorrowerId');
    const editBorrowerFullName = document.getElementById('editBorrowerFullName');
    const editBorrowerPhone = document.getElementById('editBorrowerPhone');
    const editBorrowerEmail = document.getElementById('editBorrowerEmail');
    const editBorrowerOccupation = document.getElementById('editBorrowerOccupation');
    const editBorrowerAddress = document.getElementById('editBorrowerAddress');
    const editBorrowerGuarantorName = document.getElementById('editBorrowerGuarantorName');
    const editBorrowerGuarantorPhone = document.getElementById('editBorrowerGuarantorPhone');
    const editBorrowerStatus = document.getElementById('editBorrowerStatus');
    const editBorrowerPhotoPlaceholder = document.getElementById('editBorrowerPhotoPlaceholder');
    const editBorrowerPhoto = document.getElementById('editBorrowerPhoto');

    // Edit Loan Form Elements
    const editLoanId = document.getElementById('editLoanId');
    const editLoanBorrower = document.getElementById('editLoanBorrower');
    const editLoanAmount = document.getElementById('editLoanAmount');
    const editLoanInterest = document.getElementById('editLoanInterest');
    const editLoanDuration = document.getElementById('editLoanDuration');
    const editLoanPurpose = document.getElementById('editLoanPurpose');
    const editLoanDescription = document.getElementById('editLoanDescription');
    const editLoanStatus = document.getElementById('editLoanStatus');
    const editLoanAmountDisplay = document.getElementById('editLoanAmountDisplay');
    const editInterestAmountDisplay = document.getElementById('editInterestAmountDisplay');
    const editTotalLoanAmountDisplay = document.getElementById('editTotalLoanAmountDisplay');

    // Edit Repayment Form Elements
    const editRepaymentId = document.getElementById('editRepaymentId');
    const editRepaymentLoan = document.getElementById('editRepaymentLoan');
    const editRepaymentAmount = document.getElementById('editRepaymentAmount');
    const editRepaymentDate = document.getElementById('editRepaymentDate');
    const editRepaymentMethod = document.getElementById('editRepaymentMethod');
    const editRepaymentNotes = document.getElementById('editRepaymentNotes');

    // SMS Form Elements
    const smsRecipientName = document.getElementById('smsRecipientName');
    const smsRecipientPhone = document.getElementById('smsRecipientPhone');
    const smsMessage = document.getElementById('smsMessage');
    const smsCounter = document.getElementById('smsCounter');
    const smsTemplateOptions = document.querySelectorAll('.select-option[data-template]');

    // Settings Form Elements
    const settingsTabs = document.querySelectorAll('.settings-tab');
    const settingsContents = document.querySelectorAll('.settings-content');
    const systemName = document.getElementById('systemName');
    const currency = document.getElementById('currency');
    const dateFormat = document.getElementById('dateFormat');
    const language = document.getElementById('language');
    const emailNotifications = document.getElementById('emailNotifications');
    const smsNotifications = document.getElementById('smsNotifications');
    const paymentReminders = document.getElementById('paymentReminders');
    const overdueAlerts = document.getElementById('overdueAlerts');
    const reminderDays = document.getElementById('reminderDays');
    const autoBackup = document.getElementById('autoBackup');
    const backupFrequency = document.getElementById('backupFrequency');
    const backupDataBtn = document.getElementById('backupDataBtn');
    const restoreFile = document.getElementById('restoreFile');
    const restoreDataBtn = document.getElementById('restoreDataBtn');
    const interestCalculation = document.getElementById('interestCalculation');
    const defaultLoanDuration = document.getElementById('defaultLoanDuration');
    const defaultInterestRate = document.getElementById('defaultInterestRate');
    const saveGeneralSettings = document.getElementById('saveGeneralSettings');
    const saveNotificationSettings = document.getElementById('saveNotificationSettings');
    const saveBackupSettings = document.getElementById('saveBackupSettings');

    // User Profile Form Elements
    const userProfilePhoto = document.getElementById('userProfilePhoto');
    const userProfilePhotoInput = document.getElementById('userProfilePhotoInput');
    const changeProfilePhotoBtn = document.getElementById('changeProfilePhotoBtn');
    const userFullName = document.getElementById('userFullName');
    const userUsername = document.getElementById('userUsername');
    const userEmail = document.getElementById('userEmail');
    const userPhone = document.getElementById('userPhone');
    const userRoleSelect = document.getElementById('userRole');
    const userBio = document.getElementById('userBio');

    // Export Form Elements
    const exportOptions = document.querySelectorAll('.export-option');
    const exportFormat = document.getElementById('exportFormat');
    const exportDateRange = document.getElementById('exportDateRange');
    const customExportDateRange = document.getElementById('customExportDateRange');
    const exportStartDate = document.getElementById('exportStartDate');
    const exportEndDate = document.getElementById('exportEndDate');

    // Loading Overlay
    const loadingOverlay = document.getElementById('loadingOverlay');

    // Schedule Elements
    const generateScheduleBtn = document.getElementById('generateScheduleBtn');
    const scheduleTableBody = document.getElementById('scheduleTableBody');

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        // Set current date
        const now = new Date();
        currentDate.textContent = now.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });

        // Set default date for repayment
        repaymentDateInput.valueAsDate = now;
        editRepaymentDate.valueAsDate = now;

        // Check if user is already logged in (for demo purposes)
        if (currentUser.username) {
            showMainApp();
        }

        // Load system settings
        applySystemSettings();

        // Initialize charts
        initializeCharts();

        // Load initial data
        loadDashboardData();
        loadBorrowersTable();
        loadLoansTable();
        loadRepaymentsTable();
        loadProfitDashboard();
        loadNotifications();

        // Set up event listeners
        setupEventListeners();

        // Set up offline functionality
        setupOfflineFunctionality();
    });

    // Set up offline functionality
    function setupOfflineFunctionality() {
        // Check if browser supports service workers
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
        }

        // Listen for online/offline events
        window.addEventListener('online', function() {
            showNotification('Connection restored. You are now online.', 'success');
            // Sync any pending data here if needed
        });

        window.addEventListener('offline', function() {
            showNotification('You are currently offline. Some features may be limited.', 'warning');
        });
    }

    // Set up all event listeners
    function setupEventListeners() {
        // Login form
        loginForm.addEventListener('submit', handleLogin);

        // Logout button
        logoutBtn.addEventListener('click', handleLogout);
        profileLogout.addEventListener('click', handleLogout);

        // Theme toggle
        themeToggle.addEventListener('click', toggleTheme);

        // User profile dropdown
        userProfile.addEventListener('click', function(e) {
            e.stopPropagation();
            userProfileMenu.classList.toggle('active');
        });

        // Close user profile dropdown when clicking elsewhere
        document.addEventListener('click', function() {
            userProfileMenu.classList.remove('active');
        });

        // Notification panel
        notificationIcon.addEventListener('click', function(e) {
            e.stopPropagation();
            notificationPanel.classList.toggle('active');
        });

        // Close notification panel when clicking elsewhere
        document.addEventListener('click', function() {
            notificationPanel.classList.remove('active');
        });

        // Clear notifications
        clearNotifications.addEventListener('click', function() {
            notifications = [];
            localStorage.setItem('notifications', JSON.stringify(notifications));
            loadNotifications();
            showNotification('All notifications cleared', 'info');
        });

        // Navigation links
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const sectionId = this.getAttribute('data-section');
                showSection(sectionId);
                
                // Update active nav link
                navLinks.forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // View all loans button
        document.getElementById('viewAllLoansBtn').addEventListener('click', function() {
            showSection('loans');
            navLinks.forEach(nav => nav.classList.remove('active'));
            document.querySelector('[data-section="loans"]').classList.add('active');
        });

        // Modal close buttons
        closeModalButtons.forEach(button => {
            button.addEventListener('click', function() {
                const modal = this.closest('.modal, .edit-loan-modal, .edit-repayment-modal, .sms-modal, .user-profile-modal, .export-modal');
                closeModal(modal);
            });
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            modals.forEach(modal => {
                if (e.target === modal) {
                    closeModal(modal);
                }
            });
            
            const customModals = document.querySelectorAll('.edit-loan-modal, .edit-repayment-modal, .sms-modal, .user-profile-modal, .export-modal');
            customModals.forEach(modal => {
                if (e.target === modal) {
                    closeModal(modal);
                }
            });
        });

        // Add buttons
        addBorrowerBtn.addEventListener('click', () => openModal(addBorrowerModal));
        addLoanBtn.addEventListener('click', () => openModal(addLoanModal));
        addRepaymentBtn.addEventListener('click', () => openModal(addRepaymentModal));

        // Save buttons
        saveBorrowerBtn.addEventListener('click', saveBorrower);
        saveLoanBtn.addEventListener('click', saveLoan);
        saveRepaymentBtn.addEventListener('click', saveRepayment);
        updateBorrowerBtn.addEventListener('click', updateBorrower);
        updateLoanBtn.addEventListener('click', updateLoan);
        updateRepaymentBtn.addEventListener('click', updateRepayment);
        saveUserProfileBtn.addEventListener('click', saveUserProfile);
        confirmExportBtn.addEventListener('click', exportData);

        // Cancel buttons
        cancelBorrowerBtn.addEventListener('click', () => closeModal(addBorrowerModal));
        cancelLoanBtn.addEventListener('click', () => closeModal(addLoanModal));
        cancelRepaymentBtn.addEventListener('click', () => closeModal(addRepaymentModal));
        cancelEditBorrowerBtn.addEventListener('click', () => closeModal(editBorrowerModal));
        cancelEditLoanBtn.addEventListener('click', () => closeModal(editLoanModal));
        cancelEditRepaymentBtn.addEventListener('click', () => closeModal(editRepaymentModal));
        cancelSmsBtn.addEventListener('click', () => closeModal(smsModal));
        cancelUserProfileBtn.addEventListener('click', () => closeModal(userProfileModal));
        cancelExportBtn.addEventListener('click', () => closeModal(exportModal));

        // FAB functionality
        mainFab.addEventListener('click', toggleFabMenu);
        fabAddBorrower.addEventListener('click', (e) => {
            e.preventDefault();
            openModal(addBorrowerModal);
            toggleFabMenu();
        });
        fabAddLoan.addEventListener('click', (e) => {
            e.preventDefault();
            openModal(addLoanModal);
            toggleFabMenu();
        });
        fabAddRepayment.addEventListener('click', (e) => {
            e.preventDefault();
            openModal(addRepaymentModal);
            toggleFabMenu();
        });

        // Photo upload
        const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
        const borrowerPhoto = document.getElementById('borrowerPhoto');
        uploadPhotoBtn.addEventListener('click', () => borrowerPhoto.click());
        borrowerPhoto.addEventListener('change', handlePhotoUpload);

        // Edit photo upload
        const editUploadPhotoBtn = document.getElementById('editUploadPhotoBtn');
        editUploadPhotoBtn.addEventListener('click', () => editBorrowerPhoto.click());
        editBorrowerPhoto.addEventListener('change', handleEditPhotoUpload);

        // Borrower details tabs
        borrowerTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active tab
                borrowerTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding content
                borrowerContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabId}Tab`).classList.add('active');
            });
        });

        // Loan details tabs
        loanTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active tab
                loanTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding content
                loanContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabId}Tab`).classList.add('active');
            });
        });

        // Repayment details tabs
        repaymentTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active tab
                repaymentTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding content
                repaymentContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabId}Tab`).classList.add('active');
            });
        });

        // Close details buttons
        closeBorrowerDetails.addEventListener('click', function() {
            borrowerDetailsContainer.style.display = 'none';
        });
        closeLoanDetails.addEventListener('click', function() {
            loanDetailsContainer.style.display = 'none';
        });
        closeRepaymentDetails.addEventListener('click', function() {
            repaymentDetailsContainer.style.display = 'none';
        });

        // Delete repayment button
        deleteRepaymentBtn.addEventListener('click', function() {
            if (currentRepaymentId) {
                deleteRepayment(currentRepaymentId);
            }
        });

        // Loan amount and interest calculation
        loanAmountInput.addEventListener('input', calculateLoanSummary);
        loanInterestInput.addEventListener('input', calculateLoanSummary);

        // Edit loan amount and interest calculation
        editLoanAmount.addEventListener('input', calculateEditLoanSummary);
        editLoanInterest.addEventListener('input', calculateEditLoanSummary);

        // Repayment loan selection
        repaymentLoanSelect.addEventListener('change', updateRepaymentSummary);

        // Generate receipt button
        generateReceiptBtn.addEventListener('click', generateReceipt);

        // Receipt actions
        printReceiptBtn.addEventListener('click', printReceipt);
        exportReceiptBtn.addEventListener('click', exportReceipt);

        // SMS functionality
        sendMessageBtn.addEventListener('click', function() {
            if (currentBorrowerId) {
                openSmsModal(currentBorrowerId);
            }
        });
        sendSmsBtn.addEventListener('click', sendSms);

        // SMS template selection
        smsTemplateOptions.forEach(option => {
            option.addEventListener('click', function() {
                const template = this.getAttribute('data-template');
                selectSmsTemplate(template);
            });
        });

        // SMS character counter
        smsMessage.addEventListener('input', function() {
            smsCounter.textContent = this.value.length;
        });

        // Settings tabs
        settingsTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active tab
                settingsTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding content
                settingsContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabId}Tab`).classList.add('active');
            });
        });

        // Export date range selection
        exportDateRange.addEventListener('change', function() {
            if (this.value === 'custom') {
                customExportDateRange.style.display = 'block';
            } else {
                customExportDateRange.style.display = 'none';
            }
        });

        // Export option selection
        exportOptions.forEach(option => {
            option.addEventListener('click', function() {
                exportOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
            });
        });

        // User profile photo
        changeProfilePhotoBtn.addEventListener('click', function() {
            userProfilePhotoInput.click();
        });
        userProfilePhotoInput.addEventListener('change', handleUserProfilePhotoUpload);

        // Backup and restore
        backupDataBtn.addEventListener('click', backupData);
        restoreDataBtn.addEventListener('click', restoreData);

        // Print borrower details
        printBorrowerBtn.addEventListener('click', function() {
            window.print();
        });

        // Print loan details
        printLoanBtn.addEventListener('click', function() {
            window.print();
        });

        // Print repayment details
        printRepaymentBtn.addEventListener('click', function() {
            window.print();
        });

        // Generate new receipt
        generateNewReceiptBtn.addEventListener('click', function() {
            generateReceipt();
        });

        // Add repayment to loan
        addRepaymentToLoanBtn.addEventListener('click', function() {
            if (currentLoanId) {
                closeModal(loanDetailsContainer);
                openModal(addRepaymentModal);
                // Pre-select the current loan
                setTimeout(() => {
                    repaymentLoanSelect.value = currentLoanId;
                    updateRepaymentSummary();
                }, 100);
            }
        });

        // Edit loan from details
        editLoanBtn.addEventListener('click', function() {
            if (currentLoanId) {
                openModal(editLoanModal);
                populateEditLoanForm(currentLoanId);
            }
        });

        // Edit repayment from details
        editRepaymentBtn.addEventListener('click', function() {
            if (currentRepaymentId) {
                openModal(editRepaymentModal);
                populateEditRepaymentForm(currentRepaymentId);
            }
        });

        // Profit dashboard filters
        const profitPeriod = document.getElementById('profitPeriod');
        const profitYear = document.getElementById('profitYear');
        const profitMonth = document.getElementById('profitMonth');
        profitPeriod.addEventListener('change', loadProfitDashboard);
        profitYear.addEventListener('change', loadProfitDashboard);
        profitMonth.addEventListener('change', loadProfitDashboard);

        // Report filters
        const reportPeriod = document.getElementById('reportPeriod');
        reportPeriod.addEventListener('change', function() {
            const customDateRange = document.getElementById('customDateRange');
            if (this.value === 'custom') {
                customDateRange.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
            }
        });

        // Generate report button
        const generateReportBtn = document.getElementById('generateReportBtn');
        generateReportBtn.addEventListener('click', generateReport);

        // Print profit statement
        const printProfitStatement = document.getElementById('printProfitStatement');
        printProfitStatement.addEventListener('click', printProfitStatementHandler);

        // Export profit data
        const exportProfitData = document.getElementById('exportProfitData');
        exportProfitData.addEventListener('click', exportProfitDataHandler);

        // User profile menu items
        viewProfileBtn.addEventListener('click', function(e) {
            e.preventDefault();
            openModal(userProfileModal);
            populateUserProfileForm();
        });

        settingsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            showSection('settings');
            navLinks.forEach(nav => nav.classList.remove('active'));
            document.querySelector('[data-section="settings"]').classList.add('active');
        });

        exportDataBtn.addEventListener('click', function(e) {
            e.preventDefault();
            openModal(exportModal);
        });

        // Settings save buttons
        saveGeneralSettings.addEventListener('click', saveGeneralSettingsHandler);
        saveNotificationSettings.addEventListener('click', saveNotificationSettingsHandler);
        saveBackupSettings.addEventListener('click', saveBackupSettingsHandler);

        // Generate schedule button
        generateScheduleBtn.addEventListener('click', generateSchedule);

        // View all loans button
        document.getElementById('viewAllLoansBtn').addEventListener('click', function() {
            showSection('loans');
            navLinks.forEach(nav => nav.classList.remove('active'));
            document.querySelector('[data-section="loans"]').classList.add('active');
        });
    }

    // Handle login
    function handleLogin(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const role = document.getElementById('role').value;
        
        // Simple validation (in a real app, this would be done on the server)
        if (username && password && role) {
            // For demo purposes, accept any login with valid credentials
            currentUser = {
                username: username,
                role: role,
                name: username.charAt(0).toUpperCase() + username.slice(1),
                email: `${username.toLowerCase()}@tanzanialoanpro.com`,
                phone: "+255 700 000 000",
                photo: null,
                bio: "System user"
            };
            
            // Save user to localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            showMainApp();
            showNotification('Login successful!', 'success');
            addNotification('Login', `User ${currentUser.name} logged in as ${currentUser.role}`);
        } else {
            showNotification('Please fill in all fields', 'error');
        }
    }

    // Handle logout
    function handleLogout(e) {
        e.preventDefault();
        currentUser = {};
        localStorage.removeItem('currentUser');
        showLogin();
        showNotification('You have been logged out', 'info');
        addNotification('Logout', 'User logged out');
    }

    // Show main application
    function showMainApp() {
        loginSection.style.display = 'none';
        mainApp.style.display = 'block';
        
        // Show FAB when logged in
        fabContainer.style.display = 'block';
        
        // Update user info
        userName.textContent = currentUser.name;
        profileName.textContent = currentUser.name;
        userRole.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
        profileRole.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
        userRole.className = `role-badge role-${currentUser.role.replace('_', '-')}`;
        
        // Update user photo if exists
        if (currentUser.photo) {
            userPhoto.style.backgroundImage = `url(${currentUser.photo})`;
            userPhoto.innerHTML = '';
        }
        
        // Apply role-based restrictions
        applyRoleRestrictions();
    }

    // Show login screen
    function showLogin() {
        loginSection.style.display = 'flex';
        mainApp.style.display = 'none';
        
        // Hide FAB when logged out
        fabContainer.style.display = 'none';
    }

    // Apply role-based restrictions
    function applyRoleRestrictions() {
        // Hide/show sections based on role
        const profitDashboardLink = document.querySelector('[data-section="profitDashboard"]');
        const reportsLink = document.querySelector('[data-section="reports"]');
        const settingsLink = document.querySelector('[data-section="settings"]');
        
        // Show profit dashboard for accountant and admin only
        if (currentUser.role === 'accountant' || currentUser.role === 'admin') {
            profitDashboardLink.style.display = 'flex';
        } else {
            profitDashboardLink.style.display = 'none';
        }
        
        // Hide settings for non-admins
        if (currentUser.role !== 'admin') {
            settingsLink.style.display = 'none';
        } else {
            settingsLink.style.display = 'flex';
        }
        
        // Hide reports for viewers
        if (currentUser.role === 'viewer') {
            // Viewers can only view data, not add/edit
            const addButtons = document.querySelectorAll('.btn-primary');
            addButtons.forEach(button => {
                if (button.id !== 'viewAllLoansBtn') {
                    button.style.display = 'none';
                }
            });
            
            // Hide action buttons in tables
            const actionButtons = document.querySelectorAll('.action-button');
            actionButtons.forEach(button => button.style.display = 'none');
            
            // Hide FAB
            fabContainer.style.display = 'none';
        }
    }

    // Show specific section
    function showSection(sectionId) {
        sections.forEach(section => {
            section.classList.remove('active');
        });
        
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.classList.add('active');
            
            // Update header title
            const headerTitle = document.querySelector('.header-title h1');
            headerTitle.textContent = targetSection.querySelector('.card-header h3')?.textContent || 
                                    targetSection.querySelector('h2')?.textContent || 
                                    'Dashboard';
        }
    }

    // Open modal
    function openModal(modal) {
        modal.style.display = 'flex';
        
        // Populate dropdowns if needed
        if (modal === addLoanModal) {
            populateBorrowerDropdown();
            calculateLoanSummary();
        } else if (modal === addRepaymentModal) {
            populateLoanDropdown();
            updateRepaymentSummary();
        } else if (modal === editBorrowerModal && currentBorrowerId) {
            populateEditBorrowerForm(currentBorrowerId);
        } else if (modal === editLoanModal && currentLoanId) {
            populateEditLoanForm(currentLoanId);
        } else if (modal === editRepaymentModal && currentRepaymentId) {
            populateEditRepaymentForm(currentRepaymentId);
        }
    }

    // Close modal
    function closeModal(modal) {
        modal.style.display = 'none';
    }

    // Toggle FAB menu
    function toggleFabMenu() {
        fabMenu.classList.toggle('active');
    }

    // Handle photo upload
    function handlePhotoUpload(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const photoPlaceholder = document.getElementById('borrowerPhotoPlaceholder');
                photoPlaceholder.style.backgroundImage = `url(${event.target.result})`;
                photoPlaceholder.innerHTML = '';
            };
            reader.readAsDataURL(file);
        }
    }

    // Handle edit photo upload
    function handleEditPhotoUpload(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                editBorrowerPhotoPlaceholder.style.backgroundImage = `url(${event.target.result})`;
                editBorrowerPhotoPlaceholder.innerHTML = '';
            };
            reader.readAsDataURL(file);
        }
    }

    // Handle user profile photo upload
    function handleUserProfilePhotoUpload(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                userProfilePhoto.style.backgroundImage = `url(${event.target.result})`;
                userProfilePhoto.innerHTML = '';
                
                // Update current user photo
                currentUser.photo = event.target.result;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Update header photo
                userPhoto.style.backgroundImage = `url(${event.target.result})`;
                userPhoto.innerHTML = '';
            };
            reader.readAsDataURL(file);
        }
    }

    // Save borrower
    function saveBorrower() {
        const fullName = document.getElementById('borrowerFullName').value;
        const phone = document.getElementById('borrowerPhone').value;
        const email = document.getElementById('borrowerEmail').value;
        const address = document.getElementById('borrowerAddress').value;
        const occupation = document.getElementById('borrowerOccupation').value;
        const guarantorName = document.getElementById('borrowerGuarantorName').value;
        const guarantorPhone = document.getElementById('borrowerGuarantorPhone').value;
        
        if (fullName && phone) {
            const newBorrower = {
                id: borrowers.length > 0 ? Math.max(...borrowers.map(b => b.id)) + 1 : 1,
                fullName,
                phone,
                email,
                address,
                idNumber: `BR-${String(borrowers.length + 1).padStart(4, '0')}`,
                occupation,
                guarantorName,
                guarantorPhone,
                photo: null,
                status: 'active',
                loans: 0,
                memberSince: new Date().toISOString().split('T')[0],
                creditScore: 'Good',
                lastUpdated: new Date().toISOString().split('T')[0]
            };
            
            // Handle photo upload
            const photoPlaceholder = document.getElementById('borrowerPhotoPlaceholder');
            if (photoPlaceholder.style.backgroundImage) {
                newBorrower.photo = photoPlaceholder.style.backgroundImage.slice(5, -2); // Remove url("") from the string
            }
            
            borrowers.push(newBorrower);
            saveDataToLocalStorage();
            loadBorrowersTable();
            closeModal(addBorrowerModal);
            showNotification('Borrower added successfully!', 'success');
            addNotification('New Borrower', `${fullName} has been added as a new borrower`);
            
            // Reset form
            document.getElementById('addBorrowerForm').reset();
            document.getElementById('borrowerPhotoPlaceholder').innerHTML = '<i class="fas fa-user"></i>';
            document.getElementById('borrowerPhotoPlaceholder').style.backgroundImage = '';
        } else {
            showNotification('Please fill in all required fields', 'error');
        }
    }

    // Save loan - FIXED VERSION
    function saveLoan() {
        const borrowerId = parseInt(document.getElementById('loanBorrower').value);
        const amount = parseFloat(document.getElementById('loanAmount').value);
        const interestRate = parseFloat(document.getElementById('loanInterest').value);
        const duration = parseInt(document.getElementById('loanDuration').value);
        const purpose = document.getElementById('loanPurpose').value;
        const description = document.getElementById('loanDescription').value;
        
        // Validate required fields
        if (!borrowerId || !amount || !interestRate || !duration || !purpose) {
            showNotification('Please fill in all required fields', 'error');
            return;
        }
        
        // Calculate simple interest correctly
        const interestAmount = amount * (interestRate / 100);
        const totalAmount = amount + interestAmount;
        
        const newLoan = {
            id: loans.length > 0 ? Math.max(...loans.map(l => l.id)) + 1 : 1,
            borrowerId,
            amount,
            interestRate,
            duration,
            purpose,
            description,
            status: 'active',
            dateIssued: new Date().toISOString().split('T')[0],
            dueDate: calculateDueDate(duration),
            totalRepaid: 0,
            totalAmount: totalAmount
        };
        
        loans.push(newLoan);
        
        // Update borrower's loan count
        const borrower = borrowers.find(b => b.id === borrowerId);
        if (borrower) {
            borrower.loans += 1;
            borrower.lastUpdated = new Date().toISOString().split('T')[0];
        }
        
        saveDataToLocalStorage();
        loadLoansTable();
        loadDashboardData();
        closeModal(addLoanModal);
        showNotification('Loan added successfully!', 'success');
        addNotification('New Loan', `Loan of TZS ${amount.toLocaleString()} approved for ${borrower?.fullName}`);
        
        // Reset form
        document.getElementById('addLoanForm').reset();
    }

    // Save repayment
    function saveRepayment() {
        const loanId = parseInt(document.getElementById('repaymentLoan').value);
        const amount = parseFloat(document.getElementById('repaymentAmount').value);
        const date = document.getElementById('repaymentDate').value;
        const method = document.getElementById('repaymentMethod').value;
        const notes = document.getElementById('repaymentNotes').value;
        
        if (loanId && amount && date && method) {
            const newRepayment = {
                id: repayments.length > 0 ? Math.max(...repayments.map(r => r.id)) + 1 : 1,
                loanId,
                amount,
                date,
                method,
                notes
            };
            
            repayments.push(newRepayment);
            
            // Update loan's total repaid
            const loan = loans.find(l => l.id === loanId);
            if (loan) {
                loan.totalRepaid += amount;
                
                // Check if loan is completed
                if (loan.totalRepaid >= loan.totalAmount) {
                    loan.status = 'completed';
                }
                
                // Update borrower's last updated date
                const borrower = borrowers.find(b => b.id === loan.borrowerId);
                if (borrower) {
                    borrower.lastUpdated = new Date().toISOString().split('T')[0];
                }
            }
            
            saveDataToLocalStorage();
            loadRepaymentsTable();
            loadDashboardData();
            loadProfitDashboard();
            
            // Show generate receipt button
            generateReceiptBtn.style.display = 'inline-block';
            showNotification('Repayment added successfully! Click "Generate Receipt" to create a receipt.', 'success');
            addNotification('New Repayment', `Payment of TZS ${amount.toLocaleString()} received`);
        } else {
            showNotification('Please fill in all required fields', 'error');
        }
    }

    // Update borrower
    function updateBorrower() {
        const id = parseInt(editBorrowerId.value);
        const fullName = editBorrowerFullName.value;
        const phone = editBorrowerPhone.value;
        const email = editBorrowerEmail.value;
        const address = editBorrowerAddress.value;
        const occupation = editBorrowerOccupation.value;
        const guarantorName = editBorrowerGuarantorName.value;
        const guarantorPhone = editBorrowerGuarantorPhone.value;
        const status = editBorrowerStatus.value;
        
        if (id && fullName && phone) {
            const borrowerIndex = borrowers.findIndex(b => b.id === id);
            if (borrowerIndex !== -1) {
                borrowers[borrowerIndex] = {
                    ...borrowers[borrowerIndex],
                    fullName,
                    phone,
                    email,
                    address,
                    occupation,
                    guarantorName,
                    guarantorPhone,
                    status,
                    lastUpdated: new Date().toISOString().split('T')[0]
                };
                
                // Handle photo update
                if (editBorrowerPhotoPlaceholder.style.backgroundImage) {
                    borrowers[borrowerIndex].photo = editBorrowerPhotoPlaceholder.style.backgroundImage.slice(5, -2);
                }
                
                saveDataToLocalStorage();
                loadBorrowersTable();
                
                // Update borrower details if currently viewing
                if (currentBorrowerId === id) {
                    showBorrowerDetails(id);
                }
                
                closeModal(editBorrowerModal);
                showNotification('Borrower updated successfully!', 'success');
                addNotification('Borrower Updated', `${fullName}'s information has been updated`);
            }
        } else {
            showNotification('Please fill in all required fields', 'error');
        }
    }

    // Update loan
    function updateLoan() {
        const id = parseInt(editLoanId.value);
        const amount = parseFloat(editLoanAmount.value);
        const interestRate = parseFloat(editLoanInterest.value);
        const duration = parseInt(editLoanDuration.value);
        const purpose = editLoanPurpose.value;
        const description = editLoanDescription.value;
        const status = editLoanStatus.value;
        
        if (id && amount && interestRate && duration) {
            const loanIndex = loans.findIndex(l => l.id === id);
            if (loanIndex !== -1) {
                // Calculate new interest amount
                const interestAmount = amount * (interestRate / 100);
                const totalAmount = amount + interestAmount;
                
                // Update loan
                loans[loanIndex] = {
                    ...loans[loanIndex],
                    amount,
                    interestRate,
                    duration,
                    purpose,
                    description,
                    status,
                    totalAmount
                };
                
                saveDataToLocalStorage();
                loadLoansTable();
                loadDashboardData();
                
                // Update loan details if currently viewing
                if (currentLoanId === id) {
                    showLoanDetails(id);
                }
                
                closeModal(editLoanModal);
                showNotification('Loan updated successfully!', 'success');
                addNotification('Loan Updated', `Loan #${String(id).padStart(4, '0')} has been updated`);
            }
        } else {
            showNotification('Please fill in all required fields', 'error');
        }
    }

    // Update repayment
    function updateRepayment() {
        const id = parseInt(editRepaymentId.value);
        const amount = parseFloat(editRepaymentAmount.value);
        const date = editRepaymentDate.value;
        const method = editRepaymentMethod.value;
        const notes = editRepaymentNotes.value;
        
        if (id && amount && date && method) {
            const repaymentIndex = repayments.findIndex(r => r.id === id);
            if (repaymentIndex !== -1) {
                // Get the old amount
                const oldAmount = repayments[repaymentIndex].amount;
                const loanId = repayments[repaymentIndex].loanId;
                
                // Update repayment
                repayments[repaymentIndex] = {
                    ...repayments[repaymentIndex],
                    amount,
                    date,
                    method,
                    notes
                };
                
                // Update loan's total repaid
                const loan = loans.find(l => l.id === loanId);
                if (loan) {
                    // Adjust the total repaid
                    loan.totalRepaid = loan.totalRepaid - oldAmount + amount;
                    
                    // Check if loan is completed
                    if (loan.totalRepaid >= loan.totalAmount) {
                        loan.status = 'completed';
                    } else if (loan.status === 'completed') {
                        loan.status = 'active';
                    }
                    
                    // Update borrower's last updated date
                    const borrower = borrowers.find(b => b.id === loan.borrowerId);
                    if (borrower) {
                        borrower.lastUpdated = new Date().toISOString().split('T')[0];
                    }
                }
                
                saveDataToLocalStorage();
                loadRepaymentsTable();
                loadDashboardData();
                loadProfitDashboard();
                
                // Update repayment details if currently viewing
                if (currentRepaymentId === id) {
                    showRepaymentDetails(id);
                }
                
                closeModal(editRepaymentModal);
                showNotification('Repayment updated successfully!', 'success');
                addNotification('Repayment Updated', `Payment of TZS ${amount.toLocaleString()} has been updated`);
            }
        } else {
            showNotification('Please fill in all required fields', 'error');
        }
    }

    // Delete borrower
    function deleteBorrower(borrowerId) {
        // Check if borrower has active loans
        const borrowerLoans = loans.filter(loan => loan.borrowerId === borrowerId && loan.status === 'active');
        if (borrowerLoans.length > 0) {
            showNotification('Cannot delete borrower with active loans. Please close all loans first.', 'error');
            return;
        }
        
        if (confirm('Are you sure you want to delete this borrower? This action cannot be undone.')) {
            const borrowerIndex = borrowers.findIndex(b => b.id === borrowerId);
            if (borrowerIndex !== -1) {
                // Remove all loans associated with this borrower
                loans = loans.filter(loan => loan.borrowerId !== borrowerId);
                
                // Remove all repayments associated with these loans
                const loanIds = loans.map(loan => loan.id);
                repayments = repayments.filter(repayment => loanIds.includes(repayment.loanId));
                
                // Remove the borrower
                borrowers.splice(borrowerIndex, 1);
                
                saveDataToLocalStorage();
                loadBorrowersTable();
                loadLoansTable();
                loadRepaymentsTable();
                loadDashboardData();
                
                // Hide borrower details if currently viewing
                if (currentBorrowerId === borrowerId) {
                    borrowerDetailsContainer.style.display = 'none';
                    currentBorrowerId = null;
                }
                
                showNotification('Borrower deleted successfully!', 'success');
                addNotification('Borrower Deleted', 'A borrower has been removed from the system');
            }
        }
    }

    // Delete loan
    function deleteLoan(loanId) {
        if (currentUser.role !== 'admin') {
            showNotification('Only administrators can delete loans.', 'error');
            return;
        }
        
        if (confirm('Are you sure you want to delete this loan? This action cannot be undone.')) {
            const loanIndex = loans.findIndex(l => l.id === loanId);
            if (loanIndex !== -1) {
                // Remove all repayments associated with this loan
                repayments = repayments.filter(repayment => repayment.loanId !== loanId);
                
                // Update borrower's loan count
                const borrower = borrowers.find(b => b.id === loans[loanIndex].borrowerId);
                if (borrower) {
                    borrower.loans = Math.max(0, borrower.loans - 1);
                }
                
                // Remove the loan
                loans.splice(loanIndex, 1);
                
                saveDataToLocalStorage();
                loadLoansTable();
                loadDashboardData();
                loadRepaymentsTable();
                showNotification('Loan deleted successfully!', 'success');
                addNotification('Loan Deleted', `Loan #${String(loanId).padStart(4, '0')} has been deleted`);
                
                // Hide loan details if currently viewing
                if (currentLoanId === loanId) {
                    loanDetailsContainer.style.display = 'none';
                    currentLoanId = null;
                }
            }
        }
    }

    // Delete repayment
    function deleteRepayment(repaymentId) {
        if (confirm('Are you sure you want to delete this repayment? This action cannot be undone.')) {
            const repaymentIndex = repayments.findIndex(r => r.id === repaymentId);
            if (repaymentIndex !== -1) {
                const loanId = repayments[repaymentIndex].loanId;
                const amount = repayments[repaymentIndex].amount;
                
                // Remove repayment
                repayments.splice(repaymentIndex, 1);
                
                // Update loan's total repaid
                const loan = loans.find(l => l.id === loanId);
                if (loan) {
                    loan.totalRepaid = Math.max(0, loan.totalRepaid - amount);
                    
                    // If loan was completed, set it back to active
                    if (loan.status === 'completed' && loan.totalRepaid < loan.totalAmount) {
                        loan.status = 'active';
                    }
                }
                
                saveDataToLocalStorage();
                loadRepaymentsTable();
                loadDashboardData();
                loadProfitDashboard();
                showNotification('Repayment deleted successfully!', 'success');
                addNotification('Repayment Deleted', 'A payment record has been deleted');
                
                // Hide repayment details if currently viewing
                if (currentRepaymentId === repaymentId) {
                    repaymentDetailsContainer.style.display = 'none';
                    currentRepaymentId = null;
                }
            }
        }
    }

    // Populate borrower dropdown
    function populateBorrowerDropdown() {
        const dropdown = document.getElementById('loanBorrower');
        dropdown.innerHTML = '<option value="">Select a borrower</option>';
        
        borrowers.forEach(borrower => {
            if (borrower.status === 'active') {
                const option = document.createElement('option');
                option.value = borrower.id;
                option.textContent = `${borrower.fullName} (${borrower.idNumber})`;
                dropdown.appendChild(option);
            }
        });
    }

    // Populate loan dropdown
    function populateLoanDropdown() {
        const dropdown = document.getElementById('repaymentLoan');
        dropdown.innerHTML = '<option value="">Select a loan</option>';
        
        loans.forEach(loan => {
            if (loan.status === 'active') {
                const borrower = borrowers.find(b => b.id === loan.borrowerId);
                if (borrower) {
                    const option = document.createElement('option');
                    option.value = loan.id;
                    option.textContent = `Loan #${loan.id} - ${borrower.fullName} (TZS ${loan.amount.toLocaleString()})`;
                    dropdown.appendChild(option);
                }
            }
        });
    }

    // Populate edit borrower form
    function populateEditBorrowerForm(borrowerId) {
        const borrower = borrowers.find(b => b.id === borrowerId);
        if (borrower) {
            editBorrowerId.value = borrower.id;
            editBorrowerFullName.value = borrower.fullName;
            editBorrowerPhone.value = borrower.phone;
            editBorrowerEmail.value = borrower.email || '';
            editBorrowerOccupation.value = borrower.occupation || '';
            editBorrowerAddress.value = borrower.address || '';
            editBorrowerGuarantorName.value = borrower.guarantorName || '';
            editBorrowerGuarantorPhone.value = borrower.guarantorPhone || '';
            editBorrowerStatus.value = borrower.status;
            
            // Reset photo placeholder
            editBorrowerPhotoPlaceholder.innerHTML = '<i class="fas fa-user"></i>';
            editBorrowerPhotoPlaceholder.style.backgroundImage = '';
            
            // Set photo if exists
            if (borrower.photo) {
                editBorrowerPhotoPlaceholder.style.backgroundImage = `url(${borrower.photo})`;
                editBorrowerPhotoPlaceholder.innerHTML = '';
            }
        }
    }

    // Populate edit loan form
    function populateEditLoanForm(loanId) {
        const loan = loans.find(l => l.id === loanId);
        if (loan) {
            editLoanId.value = loan.id;
            
            const borrower = borrowers.find(b => b.id === loan.borrowerId);
            editLoanBorrower.value = borrower ? borrower.fullName : 'Unknown';
            
            editLoanAmount.value = loan.amount;
            editLoanInterest.value = loan.interestRate;
            editLoanDuration.value = loan.duration;
            editLoanPurpose.value = loan.purpose;
            editLoanDescription.value = loan.description;
            editLoanStatus.value = loan.status;
            
            calculateEditLoanSummary();
        }
    }

    // Populate edit repayment form
    function populateEditRepaymentForm(repaymentId) {
        const repayment = repayments.find(r => r.id === repaymentId);
        if (repayment) {
            editRepaymentId.value = repayment.id;
            
            const loan = loans.find(l => l.id === repayment.loanId);
            if (loan) {
                const borrower = borrowers.find(b => b.id === loan.borrowerId);
                editRepaymentLoan.value = `Loan #${loan.id} - ${borrower ? borrower.fullName : 'Unknown'}`;
            }
            
            editRepaymentAmount.value = repayment.amount;
            editRepaymentDate.value = repayment.date;
            editRepaymentMethod.value = repayment.method;
            editRepaymentNotes.value = repayment.notes || '';
        }
    }

    // Calculate loan summary - FIXED SIMPLE INTEREST CALCULATION
    function calculateLoanSummary() {
        const amount = parseFloat(loanAmountInput.value) || 0;
        const interestRate = parseFloat(loanInterestInput.value) || 0;
        
        // Calculate simple interest correctly
        const interestAmount = amount * (interestRate / 100);
        const totalAmount = amount + interestAmount;
        
        loanAmountDisplay.textContent = `TZS ${amount.toLocaleString()}`;
        interestAmountDisplay.textContent = `TZS ${interestAmount.toLocaleString()}`;
        totalLoanAmountDisplay.textContent = `TZS ${totalAmount.toLocaleString()}`;
    }

    // Calculate edit loan summary - FIXED SIMPLE INTEREST CALCULATION
    function calculateEditLoanSummary() {
        const amount = parseFloat(editLoanAmount.value) || 0;
        const interestRate = parseFloat(editLoanInterest.value) || 0;
        
        // Calculate simple interest correctly
        const interestAmount = amount * (interestRate / 100);
        const totalAmount = amount + interestAmount;
        
        editLoanAmountDisplay.textContent = `TZS ${amount.toLocaleString()}`;
        editInterestAmountDisplay.textContent = `TZS ${interestAmount.toLocaleString()}`;
        editTotalLoanAmountDisplay.textContent = `TZS ${totalAmount.toLocaleString()}`;
    }

    // Update repayment summary
    function updateRepaymentSummary() {
        const loanId = parseInt(repaymentLoanSelect.value);
        if (loanId) {
            const loan = loans.find(l => l.id === loanId);
            if (loan) {
                repaymentTotalAmount.textContent = `TZS ${loan.totalAmount.toLocaleString()}`;
                repaymentAmountPaid.textContent = `TZS ${loan.totalRepaid.toLocaleString()}`;
                repaymentRemainingBalance.textContent = `TZS ${(loan.totalAmount - loan.totalRepaid).toLocaleString()}`;
            }
        } else {
            repaymentTotalAmount.textContent = 'TZS 0';
            repaymentAmountPaid.textContent = 'TZS 0';
            repaymentRemainingBalance.textContent = 'TZS 0';
        }
    }

    // Generate receipt - FIXED VERSION
    function generateReceipt() {
        const loanId = parseInt(repaymentLoanSelect.value);
        const repaymentAmount = parseFloat(repaymentAmountInput.value) || 0;
        
        if (loanId) {
            const loan = loans.find(l => l.id === loanId);
            if (loan) {
                const borrower = borrowers.find(b => b.id === loan.borrowerId);
                if (borrower) {
                    // Set receipt details
                    const now = new Date();
                    receiptDate.textContent = `Date: ${now.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}`;
                    
                    receiptNumber.textContent = `Receipt No: RCP-${String(repayments.length).padStart(4, '0')}`;
                    receiptBorrower.textContent = borrower.fullName;
                    receiptLoanId.textContent = `LN-${String(loan.id).padStart(4, '0')}`;
                    receiptPaymentDate.textContent = document.getElementById('repaymentDate').value;
                    receiptPaymentMethod.textContent = document.getElementById('repaymentMethod').value;
                    receiptTotalAmount.textContent = loan.totalAmount.toLocaleString();
                    receiptPaidAmount.textContent = (loan.totalRepaid - repaymentAmount).toLocaleString();
                    receiptCurrentPayment.textContent = repaymentAmount.toLocaleString();
                    receiptRemainingBalance.textContent = (loan.totalAmount - loan.totalRepaid).toLocaleString();
                    receiptAmountWords.textContent = convertToWords(repaymentAmount);
                    receiptProcessedBy.textContent = `${currentUser.name} (${currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1)})`;
                    
                    // Show receipt container
                    document.getElementById('receiptTab').style.display = 'block';
                    
                    // Close repayment modal
                    closeModal(addRepaymentModal);
                    
                    // Reset generate receipt button
                    generateReceiptBtn.style.display = 'none';
                }
            }
        }
    }

    // Print receipt
    function printReceipt() {
        const printContent = document.getElementById('receiptTab').innerHTML;
        const originalContent = document.body.innerHTML;
        
        document.body.innerHTML = printContent;
        window.print();
        document.body.innerHTML = originalContent;
        
        // Reload the page to restore functionality
        location.reload();
    }

    // Export receipt as PDF
    function exportReceipt() {
        showLoadingOverlay();
        
        setTimeout(() => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.text('TanzaniaLoanPro', 105, 15, { align: 'center' });
            
            // Add subtitle
            doc.setFontSize(16);
            doc.text('Payment Receipt', 105, 25, { align: 'center' });
            
            // Add receipt details
            doc.setFontSize(12);
            doc.text(`Date: ${receiptDate.textContent.replace('Date: ', '')}`, 20, 40);
            doc.text(`Receipt No: ${receiptNumber.textContent.replace('Receipt No: ', '')}`, 20, 50);
            
            // Add borrower and loan details
            doc.text(`Borrower: ${receiptBorrower.textContent}`, 20, 70);
            doc.text(`Loan ID: ${receiptLoanId.textContent}`, 20, 80);
            doc.text(`Payment Date: ${receiptPaymentDate.textContent}`, 120, 70);
            doc.text(`Payment Method: ${receiptPaymentMethod.textContent}`, 120, 80);
            
            // Add table
            doc.autoTable({
                startY: 100,
                head: [['Description', 'Amount (TZS)']],
                body: [
                    ['Total Loan Amount with Interest', receiptTotalAmount.textContent],
                    ['Previously Paid', receiptPaidAmount.textContent],
                    ['Current Payment', receiptCurrentPayment.textContent],
                    ['Remaining Balance', receiptRemainingBalance.textContent]
                ],
                theme: 'grid'
            });
            
            // Add summary
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Amount in Words: ${receiptAmountWords.textContent}`, 20, finalY);
            doc.text(`Processed By: ${receiptProcessedBy.textContent}`, 20, finalY + 10);
            
            // Save the PDF
            doc.save(`receipt-${receiptNumber.textContent.replace('Receipt No: ', '')}.pdf`);
            
            hideLoadingOverlay();
            showNotification('Receipt exported as PDF successfully!', 'success');
        }, 1000);
    }

    // Load dashboard data - UPDATED WITH NEW METRICS
    function loadDashboardData() {
        // Update stats
        document.getElementById('totalBorrowers').textContent = borrowers.length;
        document.getElementById('activeLoans').textContent = loans.filter(l => l.status === 'active').length;
        
        // Calculate loan disbursed (total amount with interest)
        const loanDisbursed = loans.reduce((sum, loan) => sum + loan.totalAmount, 0);
        document.getElementById('loanDisbursed').textContent = `TZS ${loanDisbursed.toLocaleString()}`;
        
        // Calculate amount repaid
        const amountRepaid = repayments.reduce((sum, repayment) => sum + repayment.amount, 0);
        document.getElementById('amountRepaid').textContent = `TZS ${amountRepaid.toLocaleString()}`;
        
        // Calculate outstanding balance
        const outstandingBalance = loanDisbursed - amountRepaid;
        document.getElementById('outstandingBalance').textContent = `TZS ${outstandingBalance.toLocaleString()}`;
        
        // Load recent loans table
        const recentLoansTable = document.getElementById('recentLoansTable').getElementsByTagName('tbody')[0];
        recentLoansTable.innerHTML = '';
        
        const recentLoans = loans.slice(0, 5); // Get first 5 loans
        recentLoans.forEach(loan => {
            const borrower = borrowers.find(b => b.id === loan.borrowerId);
            if (borrower) {
                const row = recentLoansTable.insertRow();
                row.innerHTML = `
                    <td>${borrower.fullName}</td>
                    <td>TZS ${loan.amount.toLocaleString()}</td>
                    <td>${loan.interestRate}%</td>
                    <td>TZS ${loan.totalAmount.toLocaleString()}</td>
                    <td><span class="status-badge status-${loan.status}">${loan.status}</span></td>
                    <td>${loan.dueDate}</td>
                    <td>
                        <button class="action-button view-button" data-id="${loan.id}" data-type="loan"><i class="fas fa-eye"></i></button>
                        <button class="action-button edit-button" data-id="${loan.id}"><i class="fas fa-edit"></i></button>
                    </td>
                `;
            }
        });
        
        // Add event listeners to action buttons
        addActionButtonListeners();
    }

    // Load borrowers table
    function loadBorrowersTable() {
        const borrowersTable = document.getElementById('borrowersTable').getElementsByTagName('tbody')[0];
        borrowersTable.innerHTML = '';
        
        borrowers.forEach(borrower => {
            const row = borrowersTable.insertRow();
            row.innerHTML = `
                <td>${borrower.idNumber}</td>
                <td>
                    <div class="photo-placeholder" style="width: 40px; height: 40px;">
                        ${borrower.photo ? 
                            `<div style="width: 100%; height: 100%; border-radius: 50%; background-image: url(${borrower.photo}); background-size: cover; background-position: center;"></div>` : 
                            `<i class="fas fa-user"></i>`
                        }
                    </div>
                </td>
                <td>${borrower.fullName}</td>
                <td>
                    <a href="tel:${borrower.phone}" class="action-button call-button" style="margin-right: 5px;">
                        <i class="fas fa-phone"></i>
                    </a>
                    ${borrower.phone}
                </td>
                <td>${borrower.email || 'N/A'}</td>
                <td>${borrower.loans}</td>
                <td><span class="status-badge status-${borrower.status}">${borrower.status}</span></td>
                <td>
                    <button class="action-button view-button" data-id="${borrower.id}" data-type="borrower"><i class="fas fa-eye"></i></button>
                    <button class="action-button edit-button" data-id="${borrower.id}"><i class="fas fa-edit"></i></button>
                    <button class="action-button delete-button" data-id="${borrower.id}"><i class="fas fa-trash"></i></button>
                </td>
            `;
        });
        
        // Add event listeners to action buttons
        addActionButtonListeners();
    }

    // Load loans table
    function loadLoansTable() {
        const loansTable = document.getElementById('loansTable').getElementsByTagName('tbody')[0];
        loansTable.innerHTML = '';
        
        loans.forEach(loan => {
            const borrower = borrowers.find(b => b.id === loan.borrowerId);
            if (borrower) {
                const remainingBalance = loan.totalAmount - loan.totalRepaid;
                const row = loansTable.insertRow();
                row.innerHTML = `
                    <td>LN-${String(loan.id).padStart(4, '0')}</td>
                    <td>${borrower.fullName}</td>
                    <td>TZS ${loan.amount.toLocaleString()}</td>
                    <td>${loan.interestRate}%</td>
                    <td>TZS ${loan.totalAmount.toLocaleString()}</td>
                    <td><span class="status-badge status-${loan.status}">${loan.status}</span></td>
                    <td>${loan.dueDate}</td>
                    <td>TZS ${remainingBalance.toLocaleString()}</td>
                    <td>
                        <button class="action-button view-button" data-id="${loan.id}" data-type="loan"><i class="fas fa-eye"></i></button>
                        <button class="action-button edit-button" data-id="${loan.id}"><i class="fas fa-edit"></i></button>
                        <button class="action-button delete-button" data-id="${loan.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            }
        });
        
        // Add event listeners to action buttons
        addActionButtonListeners();
    }

    // Load repayments table
    function loadRepaymentsTable() {
        const repaymentsTable = document.getElementById('repaymentsTable').getElementsByTagName('tbody')[0];
        repaymentsTable.innerHTML = '';
        
        repayments.forEach(repayment => {
            const loan = loans.find(l => l.id === repayment.loanId);
            if (loan) {
                const borrower = borrowers.find(b => b.id === loan.borrowerId);
                if (borrower) {
                    const row = repaymentsTable.insertRow();
                    row.innerHTML = `
                        <td>RPM-${String(repayment.id).padStart(4, '0')}</td>
                        <td>LN-${String(loan.id).padStart(4, '0')}</td>
                        <td>${borrower.fullName}</td>
                        <td>TZS ${repayment.amount.toLocaleString()}</td>
                        <td>${repayment.date}</td>
                        <td>${repayment.method}</td>
                        <td>
                            <button class="action-button view-button" data-id="${repayment.id}" data-type="repayment"><i class="fas fa-eye"></i></button>
                            <button class="action-button edit-button" data-id="${repayment.id}"><i class="fas fa-edit"></i></button>
                            <button class="action-button receipt-button" data-id="${repayment.id}"><i class="fas fa-receipt"></i></button>
                        </td>
                    `;
                }
            }
        });
        
        // Add event listeners to action buttons
        addActionButtonListeners();
    }

    // Show borrower details
    function showBorrowerDetails(borrowerId) {
        const borrower = borrowers.find(b => b.id === borrowerId);
        if (!borrower) return;
        
        currentBorrowerId = borrowerId;
        
        // Update borrower details
        borrowerDetailName.textContent = borrower.fullName;
        borrowerDetailContact.textContent = `${borrower.phone} | ${borrower.email || 'No email'}`;
        borrowerDetailId.textContent = `ID: ${borrower.idNumber}`;
        
        // Update borrower photo
        borrowerDetailPhoto.innerHTML = '<i class="fas fa-user"></i>';
        borrowerDetailPhoto.style.backgroundImage = '';
        if (borrower.photo) {
            borrowerDetailPhoto.style.backgroundImage = `url(${borrower.photo})`;
            borrowerDetailPhoto.innerHTML = '';
        }
        
        // Update borrower stats
        const borrowerLoans = loans.filter(l => l.borrowerId === borrowerId);
        const activeLoans = borrowerLoans.filter(l => l.status === 'active');
        const totalBorrowed = borrowerLoans.reduce((sum, loan) => sum + loan.totalAmount, 0);
        const remainingBalance = borrowerLoans.reduce((sum, loan) => sum + (loan.totalAmount - loan.totalRepaid), 0);
        
        borrowerDetailTotalLoans.textContent = borrowerLoans.length;
        borrowerDetailActiveLoans.textContent = activeLoans.length;
        borrowerDetailTotalLoanAmount.textContent = `TZS ${totalBorrowed.toLocaleString()}`;
        borrowerDetailRemainingBalance.textContent = `TZS ${remainingBalance.toLocaleString()}`;
        borrowerDetailStatus.textContent = borrower.status;
        borrowerDetailStatus.className = `status-badge status-${borrower.status}`;
        
        // Update contact information
        borrowerDetailPhone.innerHTML = `
            <a href="tel:${borrower.phone}" class="action-button call-button" style="margin-right: 5px;">
                <i class="fas fa-phone"></i>
            </a>
            ${borrower.phone}
        `;
        borrowerDetailEmail.textContent = borrower.email || 'N/A';
        borrowerDetailAddress.textContent = borrower.address || 'N/A';
        
        // Update personal details
        borrowerDetailIdNumber.textContent = borrower.idNumber;
        borrowerDetailOccupation.textContent = borrower.occupation || 'N/A';
        borrowerDetailGuarantor.innerHTML = borrower.guarantorName ? `
            ${borrower.guarantorName}
            <a href="tel:${borrower.guarantorPhone}" class="action-button call-button" style="margin-left: 5px;">
                <i class="fas fa-phone"></i>
            </a>
        ` : 'N/A';
        borrowerDetailGuarantorPhone.textContent = borrower.guarantorPhone || 'N/A';
        borrowerDetailMemberSince.textContent = new Date(borrower.memberSince).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        borrowerDetailCreditScore.textContent = borrower.creditScore;
        borrowerDetailLastUpdated.textContent = new Date(borrower.lastUpdated).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        // Load borrower's loans
        loadBorrowerLoans(borrowerId);
        
        // Load borrower's repayments
        loadBorrowerRepayments(borrowerId);
        
        // Load borrower's documents
        loadBorrowerDocuments(borrowerId);
        
        // Show borrower details container
        borrowerDetailsContainer.style.display = 'block';
        
        // Scroll to top of borrower details
        borrowerDetailsContainer.scrollIntoView({ behavior: 'smooth' });
    }

    // Show loan details
    function showLoanDetails(loanId) {
        const loan = loans.find(l => l.id === loanId);
        if (!loan) return;
        
        currentLoanId = loanId;
        
        // Get borrower information
        const borrower = borrowers.find(b => b.id === loan.borrowerId);
        const borrowerName = borrower ? borrower.fullName : 'Unknown';
        
        // Update loan details
        loanDetailId.textContent = `LN-${String(loan.id).padStart(4, '0')}`;
        loanDetailBorrower.textContent = borrowerName;
        loanDetailPurpose.textContent = loan.purpose;
        loanDetailAmount.textContent = `TZS ${loan.amount.toLocaleString()}`;
        loanDetailInterest.textContent = `${loan.interestRate}%`;
        loanDetailTotalAmount.textContent = `TZS ${loan.totalAmount.toLocaleString()}`;
        loanDetailStatus.textContent = loan.status;
        loanDetailStatus.className = `status-badge status-${loan.status}`;
        
        // Update detailed information
        loanDetailIdNumber.textContent = `LN-${String(loan.id).padStart(4, '0')}`;
        loanDetailDateIssued.textContent = new Date(loan.dateIssued).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        loanDetailDueDate.textContent = new Date(loan.dueDate).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        loanDetailDuration.textContent = `${loan.duration} days`;
        loanDetailPrincipal.textContent = `TZS ${loan.amount.toLocaleString()}`;
        loanDetailInterestAmount.textContent = `TZS ${(loan.totalAmount - loan.amount).toLocaleString()}`;
        loanDetailTotal.textContent = `TZS ${loan.totalAmount.toLocaleString()}`;
        loanDetailRepaid.textContent = `TZS ${loan.totalRepaid.toLocaleString()}`;
        loanDetailRemaining.textContent = `TZS ${(loan.totalAmount - loan.totalRepaid).toLocaleString()}`;
        loanDetailDescription.textContent = loan.description || 'No description provided';
        
        // Load loan's repayments
        loadLoanRepayments(loanId);
        
        // Show loan details container
        loanDetailsContainer.style.display = 'block';
        
        // Scroll to top of loan details
        loanDetailsContainer.scrollIntoView({ behavior: 'smooth' });
    }

    // Show repayment details
    function showRepaymentDetails(repaymentId) {
        const repayment = repayments.find(r => r.id === repaymentId);
        if (!repayment) return;
        
        currentRepaymentId = repaymentId;
        
        // Get loan and borrower information
        const loan = loans.find(l => l.id === repayment.loanId);
        const borrower = loan ? borrowers.find(b => b.id === loan.borrowerId) : null;
        const borrowerName = borrower ? borrower.fullName : 'Unknown';
        const loanId = loan ? `LN-${String(loan.id).padStart(4, '0')}` : 'Unknown';
        
        // Update repayment details
        repaymentDetailId.textContent = `RPM-${String(repayment.id).padStart(4, '0')}`;
        repaymentDetailLoan.textContent = loanId;
        repaymentDetailBorrower.textContent = borrowerName;
        repaymentDetailAmount.textContent = `TZS ${repayment.amount.toLocaleString()}`;
        repaymentDetailDate.textContent = new Date(repayment.date).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        repaymentDetailMethod.textContent = repayment.method;
        repaymentDetailStatus.textContent = 'Completed';
        repaymentDetailStatus.className = `status-badge status-completed`;
        
        // Update detailed information
        repaymentDetailIdNumber.textContent = `RPM-${String(repayment.id).padStart(4, '0')}`;
        repaymentDetailLoanId.textContent = loanId;
        repaymentDetailBorrowerName.textContent = borrowerName;
        repaymentDetailPaymentDate.textContent = new Date(repayment.date).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        repaymentDetailPaymentMethod.textContent = repayment.method;
        
        if (loan) {
            repaymentDetailTotalLoanAmount.textContent = `TZS ${loan.totalAmount.toLocaleString()}`;
            
            // Calculate previously paid amount
            const previousRepayments = repayments.filter(r => 
                r.loanId === loan.id && r.id !== repayment.id
            );
            const previouslyPaid = previousRepayments.reduce((sum, r) => sum + r.amount, 0);
            
            repaymentDetailPreviouslyPaid.textContent = `TZS ${previouslyPaid.toLocaleString()}`;
            repaymentDetailCurrentPayment.textContent = `TZS ${repayment.amount.toLocaleString()}`;
            repaymentDetailRemainingBalance.textContent = `TZS ${(loan.totalAmount - previouslyPaid - repayment.amount).toLocaleString()}`;
        } else {
            repaymentDetailTotalLoanAmount.textContent = 'TZS 0';
            repaymentDetailPreviouslyPaid.textContent = 'TZS 0';
            repaymentDetailCurrentPayment.textContent = `TZS ${repayment.amount.toLocaleString()}`;
            repaymentDetailRemainingBalance.textContent = 'TZS 0';
        }
        
        repaymentDetailNotes.textContent = repayment.notes || 'No notes provided';
        
        // Show repayment details container
        repaymentDetailsContainer.style.display = 'block';
        
        // Scroll to top of repayment details
        repaymentDetailsContainer.scrollIntoView({ behavior: 'smooth' });
    }

    // Load borrower's loans
    function loadBorrowerLoans(borrowerId) {
        borrowerLoansTable.innerHTML = '';
        
        const borrowerLoans = loans.filter(loan => loan.borrowerId === borrowerId);
        
        borrowerLoans.forEach(loan => {
            const remainingBalance = loan.totalAmount - loan.totalRepaid;
            const row = borrowerLoansTable.insertRow();
            row.innerHTML = `
                <td>LN-${String(loan.id).padStart(4, '0')}</td>
                <td>TZS ${loan.amount.toLocaleString()}</td>
                <td>${loan.interestRate}%</td>
                <td>TZS ${loan.totalAmount.toLocaleString()}</td>
                <td>${loan.duration} days</td>
                <td><span class="status-badge status-${loan.status}">${loan.status}</span></td>
                <td>${loan.dateIssued}</td>
                <td>${loan.dueDate}</td>
                <td>TZS ${remainingBalance.toLocaleString()}</td>
                <td>
                    <button class="action-button view-button" data-id="${loan.id}" data-type="loan"><i class="fas fa-eye"></i></button>
                </td>
            `;
        });
        
        // Add event listeners to action buttons
        addActionButtonListeners();
    }

    // Load borrower's repayments
    function loadBorrowerRepayments(borrowerId) {
        borrowerRepaymentsTable.innerHTML = '';
        
        // Get all loans for this borrower
        const borrowerLoans = loans.filter(loan => loan.borrowerId === borrowerId);
        const borrowerLoanIds = borrowerLoans.map(loan => loan.id);
        
        // Get all repayments for these loans
        const borrowerRepayments = repayments.filter(repayment => 
            borrowerLoanIds.includes(repayment.loanId)
        );
        
        borrowerRepayments.forEach(repayment => {
            const loan = loans.find(l => l.id === repayment.loanId);
            const row = borrowerRepaymentsTable.insertRow();
            row.innerHTML = `
                <td>RPM-${String(repayment.id).padStart(4, '0')}</td>
                <td>LN-${String(repayment.loanId).padStart(4, '0')}</td>
                <td>TZS ${repayment.amount.toLocaleString()}</td>
                <td>${repayment.date}</td>
                <td>${repayment.method}</td>
                <td><span class="status-badge status-completed">Completed</span></td>
            `;
        });
    }

    // Load borrower's documents
    function loadBorrowerDocuments(borrowerId) {
        const borrowerDocumentsList = document.getElementById('borrowerDocumentsList');
        borrowerDocumentsList.innerHTML = '';
        
        // In a real application, this would load actual documents from a database
        // For demo purposes, we'll just show a placeholder
        borrowerDocumentsList.innerHTML = `
            <div class="info-card">
                <p>No documents uploaded yet.</p>
            </div>
        `;
    }

    // Load loan's repayments
    function loadLoanRepayments(loanId) {
        loanRepaymentsTable.innerHTML = '';
        
        const loanRepayments = repayments.filter(repayment => repayment.loanId === loanId);
        
        loanRepayments.forEach(repayment => {
            const row = loanRepaymentsTable.insertRow();
            row.innerHTML = `
                <td>RPM-${String(repayment.id).padStart(4, '0')}</td>
                <td>TZS ${repayment.amount.toLocaleString()}</td>
                <td>${repayment.date}</td>
                <td>${repayment.method}</td>
                <td><span class="status-badge status-completed">Completed</span></td>
                <td>
                    <button class="action-button view-button" data-id="${repayment.id}" data-type="repayment"><i class="fas fa-eye"></i></button>
                </td>
            `;
        });
        
        // Add event listeners to action buttons
        addActionButtonListeners();
    }

    // Generate repayment schedule
    function generateSchedule() {
        if (!currentBorrowerId) return;
        
        const borrower = borrowers.find(b => b.id === currentBorrowerId);
        if (!borrower) return;
        
        // Get active loans for this borrower
        const activeLoans = loans.filter(l => l.borrowerId === currentBorrowerId && l.status === 'active');
        
        if (activeLoans.length === 0) {
            showNotification('No active loans found for this borrower', 'info');
            return;
        }
        
        scheduleTableBody.innerHTML = '';
        
        activeLoans.forEach(loan => {
            const totalAmount = loan.totalAmount;
            const duration = loan.duration;
            const installmentAmount = Math.ceil(totalAmount / duration);
            const startDate = new Date(loan.dateIssued);
            
            let remainingBalance = totalAmount;
            
            for (let i = 1; i <= duration; i++) {
                const dueDate = new Date(startDate);
                dueDate.setDate(dueDate.getDate() + (i * 30)); // Monthly installments
                
                const principalPayment = Math.min(installmentAmount * 0.7, remainingBalance);
                const interestPayment = installmentAmount - principalPayment;
                
                remainingBalance -= installmentAmount;
                if (remainingBalance < 0) remainingBalance = 0;
                
                const row = scheduleTableBody.insertRow();
                const isPaid = repayments.some(r => r.loanId === loan.id && new Date(r.date) <= dueDate);
                const isOverdue = !isPaid && new Date() > dueDate;
                
                row.className = isPaid ? 'schedule-item paid' : (isOverdue ? 'schedule-item overdue' : '');
                row.innerHTML = `
                    <td>${i}</td>
                    <td>${dueDate.toLocaleDateString()}</td>
                    <td>TZS ${installmentAmount.toLocaleString()}</td>
                    <td>TZS ${principalPayment.toLocaleString()}</td>
                    <td>TZS ${interestPayment.toLocaleString()}</td>
                    <td>TZS ${remainingBalance.toLocaleString()}</td>
                    <td>
                        <span class="status-badge ${isPaid ? 'status-completed' : (isOverdue ? 'status-overdue' : 'status-pending')}">
                            ${isPaid ? 'Paid' : (isOverdue ? 'Overdue' : 'Pending')}
                        </span>
                    </td>
                `;
            }
        });
        
        showNotification('Repayment schedule generated successfully!', 'success');
    }

    // Load profit dashboard
    function loadProfitDashboard() {
        // Calculate profit metrics
        const totalInterestCollected = calculateTotalInterest();
        const monthlyProfit = calculateMonthlyProfit();
        const yearlyProfit = calculateYearlyProfit();
        const profitMargin = calculateProfitMargin();
        
        // Update profit cards
        document.getElementById('totalInterestCollected').textContent = `TZS ${totalInterestCollected.toLocaleString()}`;
        document.getElementById('monthlyProfit').textContent = `TZS ${monthlyProfit.toLocaleString()}`;
        document.getElementById('yearlyProfit').textContent = `TZS ${yearlyProfit.toLocaleString()}`;
        document.getElementById('profitMargin').textContent = `${profitMargin}%`;
        
        // Update profit statement
        updateProfitStatement();
        
        // Update profit chart
        updateProfitChart();
    }

    // Calculate total interest collected
    function calculateTotalInterest() {
        let totalInterest = 0;
        
        loans.forEach(loan => {
            const interestAmount = loan.totalAmount - loan.amount;
            totalInterest += Math.min(interestAmount, loan.totalRepaid - loan.amount);
        });
        
        return totalInterest;
    }

    // Calculate monthly profit
    function calculateMonthlyProfit() {
        const currentMonth = new Date().getMonth() + 1;
        const currentYear = new Date().getFullYear();
        
        let monthlyProfit = 0;
        
        repayments.forEach(repayment => {
            const repaymentDate = new Date(repayment.date);
            if (repaymentDate.getMonth() + 1 === currentMonth && repaymentDate.getFullYear() === currentYear) {
                const loan = loans.find(l => l.id === repayment.loanId);
                if (loan) {
                    // Calculate interest portion of repayment
                    const totalLoanAmount = loan.totalAmount;
                    const interestRatio = (loan.totalAmount - loan.amount) / totalLoanAmount;
                    monthlyProfit += repayment.amount * interestRatio;
                }
            }
        });
        
        return monthlyProfit;
    }

    // Calculate yearly profit
    function calculateYearlyProfit() {
        const currentYear = new Date().getFullYear();
        
        let yearlyProfit = 0;
        
        repayments.forEach(repayment => {
            const repaymentDate = new Date(repayment.date);
            if (repaymentDate.getFullYear() === currentYear) {
                const loan = loans.find(l => l.id === repayment.loanId);
                if (loan) {
                    // Calculate interest portion of repayment
                    const totalLoanAmount = loan.totalAmount;
                    const interestRatio = (loan.totalAmount - loan.amount) / totalLoanAmount;
                    yearlyProfit += repayment.amount * interestRatio;
                }
            }
        });
        
        return yearlyProfit;
    }

    // Calculate profit margin
    function calculateProfitMargin() {
        const totalLoanAmount = loans.reduce((sum, loan) => sum + loan.amount, 0);
        const totalProfit = calculateTotalProfit();
        
        if (totalLoanAmount === 0) return 0;
        
        return ((totalProfit / totalLoanAmount) * 100).toFixed(2);
    }

    // Calculate total profit
    function calculateTotalProfit() {
        return calculateTotalInterest();
    }

    // Update profit statement
    function updateProfitStatement() {
        const statementPeriod = document.getElementById('statementPeriod');
        const statementLoanAmount = document.getElementById('statementLoanAmount');
        const statementInterestCollected = document.getElementById('statementInterestCollected');
        const statementTotalProfit = document.getElementById('statementTotalProfit');
        const statementProfitMargin = document.getElementById('statementProfitMargin');
        const profitStatementTable = document.getElementById('profitStatementTable');
        const summaryPrincipal = document.getElementById('summaryPrincipal');
        const summaryInterest = document.getElementById('summaryInterest');
        const summaryProfit = document.getElementById('summaryProfit');
        
        // Set period text
        const period = document.getElementById('profitPeriod').value;
        const year = document.getElementById('profitYear').value;
        const month = document.getElementById('profitMonth').value;
        
        let periodText = '';
        if (period === 'monthly') {
            if (month === 'all') {
                periodText = `All months of ${year}`;
            } else {
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                periodText = `${monthNames[parseInt(month) - 1]} ${year}`;
            }
        } else if (period === 'quarterly') {
            periodText = `Quarterly ${year}`;
        } else {
            periodText = `Yearly ${year}`;
        }
        
        statementPeriod.textContent = `Period: ${periodText}`;
        
        // Calculate statement data
        let totalPrincipal = 0;
        let totalInterest = 0;
        let totalProfit = 0;
        
        // Filter loans based on period
        const filteredLoans = loans.filter(loan => {
            const loanDate = new Date(loan.dateIssued);
            const loanYear = loanDate.getFullYear();
            
            if (period === 'yearly') {
                return loanYear === parseInt(year);
            } else if (period === 'quarterly') {
                // For simplicity, we'll use all loans in the year for quarterly
                return loanYear === parseInt(year);
            } else { // monthly
                if (month === 'all') {
                    return loanYear === parseInt(year);
                } else {
                    const loanMonth = loanDate.getMonth() + 1;
                    return loanYear === parseInt(year) && loanMonth === parseInt(month);
                }
            }
        });
        
        // Populate statement table
        profitStatementTable.innerHTML = '';
        filteredLoans.forEach(loan => {
            const borrower = borrowers.find(b => b.id === loan.borrowerId);
            if (borrower) {
                const interestAmount = loan.totalAmount - loan.amount;
                
                const row = profitStatementTable.insertRow();
                row.innerHTML = `
                    <td>${loan.dateIssued}</td>
                    <td>LN-${String(loan.id).padStart(4, '0')}</td>
                    <td>${borrower.fullName}</td>
                    <td>TZS ${loan.amount.toLocaleString()}</td>
                    <td>TZS ${interestAmount.toLocaleString()}</td>
                    <td>TZS ${loan.totalAmount.toLocaleString()}</td>
                `;
                
                totalPrincipal += loan.amount;
                totalInterest += interestAmount;
                totalProfit += interestAmount;
            }
        });
        
        // Update statement totals
        statementLoanAmount.textContent = `TZS ${totalPrincipal.toLocaleString()}`;
        statementInterestCollected.textContent = `TZS ${totalInterest.toLocaleString()}`;
        statementTotalProfit.textContent = `TZS ${totalProfit.toLocaleString()}`;
        statementProfitMargin.textContent = `${((totalProfit / totalPrincipal) * 100).toFixed(2)}%`;
        
        // Update summary
        summaryPrincipal.textContent = `TZS ${totalPrincipal.toLocaleString()}`;
        summaryInterest.textContent = `TZS ${totalInterest.toLocaleString()}`;
        summaryProfit.textContent = `TZS ${totalProfit.toLocaleString()}`;
    }

    // Initialize charts
    function initializeCharts() {
        // Profit chart
        const profitCtx = document.getElementById('profitChart').getContext('2d');
        window.profitChart = new Chart(profitCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'Monthly Profit (TZS)',
                    data: [1200000, 1900000, 1500000, 1800000, 2200000, 2100000, 2400000, 2300000, 2500000, 2700000, 2600000, 2900000],
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Monthly Profit Trend'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'TZS ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Update profit chart
    function updateProfitChart() {
        // In a real application, this would fetch data based on the selected filters
        // For demo purposes, we'll use static data
        const monthlyProfitData = [1200000, 1900000, 1500000, 1800000, 2200000, 2100000, 2400000, 2300000, 2500000, 2700000, 2600000, 2900000];
        
        window.profitChart.data.datasets[0].data = monthlyProfitData;
        window.profitChart.update();
    }

    // Generate report
    function generateReport() {
        const reportType = document.getElementById('reportType').value;
        const reportPeriod = document.getElementById('reportPeriod').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        const reportsTable = document.getElementById('reportsTable').getElementsByTagName('tbody')[0];
        reportsTable.innerHTML = '';
        
        // For demo purposes, we'll just show a message
        const row = reportsTable.insertRow();
        row.innerHTML = `
            <td>
                <div style="text-align: center; padding: 20px;">
                    <h3>Report Generated</h3>
                    <p>Report Type: ${reportType}</p>
                    <p>Period: ${reportPeriod}</p>
                    ${startDate && endDate ? `<p>Date Range: ${startDate} to ${endDate}</p>` : ''}
                    <p>This is a sample report. In a real application, this would contain actual data based on the selected filters.</p>
                </div>
            </td>
        `;
        
        showNotification('Report generated successfully!', 'success');
    }

    // Print profit statement
    function printProfitStatementHandler() {
        window.print();
    }

    // Export profit data
    function exportProfitDataHandler() {
        showLoadingOverlay();
        
        setTimeout(() => {
            // In a real application, this would generate and download a file with the profit data
            hideLoadingOverlay();
            showNotification('Profit data exported successfully!', 'success');
        }, 1000);
    }

    // Add action button listeners
    function addActionButtonListeners() {
        // View buttons
        const viewButtons = document.querySelectorAll('.view-button');
        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = parseInt(this.getAttribute('data-id'));
                const type = this.getAttribute('data-type');
                
                if (type === 'borrower') {
                    showBorrowerDetails(id);
                } else if (type === 'loan') {
                    showLoanDetails(id);
                } else if (type === 'repayment') {
                    showRepaymentDetails(id);
                }
            });
        });
        
        // Edit buttons
        const editButtons = document.querySelectorAll('.edit-button');
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = parseInt(this.getAttribute('data-id'));
                const type = this.closest('table').id;
                
                if (type === 'borrowersTable') {
                    currentBorrowerId = id;
                    openModal(editBorrowerModal);
                } else if (type === 'loansTable') {
                    currentLoanId = id;
                    openModal(editLoanModal);
                } else if (type === 'repaymentsTable') {
                    currentRepaymentId = id;
                    openModal(editRepaymentModal);
                }
            });
        });
        
        // Delete buttons
        const deleteButtons = document.querySelectorAll('.delete-button');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = parseInt(this.getAttribute('data-id'));
                const type = this.closest('table').id;
                
                if (type === 'borrowersTable') {
                    deleteBorrower(id);
                } else if (type === 'loansTable') {
                    // Check if user is admin before allowing deletion
                    if (currentUser.role === 'admin') {
                        deleteLoan(id);
                    } else {
                        showNotification('Only administrators can delete loans.', 'error');
                    }
                }
            });
        });
        
        // Receipt buttons
        const receiptButtons = document.querySelectorAll('.receipt-button');
        receiptButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = parseInt(this.getAttribute('data-id'));
                const repayment = repayments.find(r => r.id === id);
                
                if (repayment) {
                    // Generate receipt for this repayment
                    currentRepaymentId = id;
                    showRepaymentDetails(id);
                    
                    // Switch to receipt tab
                    repaymentTabs.forEach(tab => tab.classList.remove('active'));
                    document.querySelector('[data-tab="receipt"]').classList.add('active');
                    repaymentContents.forEach(content => content.classList.remove('active'));
                    document.getElementById('receiptTab').classList.add('active');
                }
            });
        });
    }

    // Calculate due date
    function calculateDueDate(duration) {
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + duration);
        return dueDate.toISOString().split('T')[0];
    }

    // Convert number to words (for receipt)
    function convertToWords(num) {
        // This is a simplified version for demo purposes
        // In a real application, you would use a more comprehensive function
        const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
        const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
        const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
        
        if (num === 0) return 'Zero';
        
        let words = '';
        
        // Handle thousands
        if (num >= 1000) {
            words += convertToWords(Math.floor(num / 1000)) + ' Thousand ';
            num %= 1000;
        }
        
        // Handle hundreds
        if (num >= 100) {
            words += ones[Math.floor(num / 100)] + ' Hundred ';
            num %= 100;
        }
        
        // Handle tens and ones
        if (num >= 20) {
            words += tens[Math.floor(num / 10)] + ' ';
            num %= 10;
        } else if (num >= 10) {
            words += teens[num - 10] + ' ';
            num = 0;
        }
        
        if (num > 0) {
            words += ones[num] + ' ';
        }
        
        return words.trim() + ' Tanzanian Shillings Only';
    }

    // Toggle theme
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const icon = themeToggle.querySelector('i');
        if (document.body.classList.contains('dark-mode')) {
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
        } else {
            icon.classList.remove('fa-sun');
            icon.classList.add('fa-moon');
        }
    }

    // Show notification
    function showNotification(message, type) {
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    // Open SMS modal
    function openSmsModal(borrowerId) {
        const borrower = borrowers.find(b => b.id === borrowerId);
        if (borrower) {
            smsRecipientName.textContent = borrower.fullName;
            smsRecipientPhone.textContent = borrower.phone;
            smsMessage.value = '';
            smsCounter.textContent = '0';
            
            // Reset template selection
            smsTemplateOptions.forEach(option => option.classList.remove('selected'));
            
            openModal(smsModal);
        }
    }

    // Select SMS template
    function selectSmsTemplate(template) {
        const borrower = borrowers.find(b => b.id === currentBorrowerId);
        if (!borrower) return;
        
        let message = '';
        
        if (template === 'reminder') {
            // Find the next due loan for this borrower
            const borrowerLoans = loans.filter(l => l.borrowerId === borrower.id && l.status === 'active');
            if (borrowerLoans.length > 0) {
                const nextLoan = borrowerLoans[0]; // Just use the first loan for demo
                message = smsTemplates.reminder
                    .replace('{name}', borrower.fullName)
                    .replace('{amount}', nextLoan.totalAmount.toLocaleString())
                    .replace('{date}', new Date(nextLoan.dueDate).toLocaleDateString());
            }
        } else if (template === 'overdue') {
            // Find overdue loans for this borrower
            const today = new Date();
            const overdueLoans = loans.filter(l => 
                l.borrowerId === borrower.id && 
                l.status === 'active' && 
                new Date(l.dueDate) < today
            );
            if (overdueLoans.length > 0) {
                const overdueLoan = overdueLoans[0]; // Just use the first loan for demo
                message = smsTemplates.overdue
                    .replace('{name}', borrower.fullName)
                    .replace('{amount}', overdueLoan.totalAmount.toLocaleString())
                    .replace('{date}', new Date(overdueLoan.dueDate).toLocaleDateString());
            }
        } else if (template === 'welcome') {
            // Find the most recent loan for this borrower
            const borrowerLoans = loans.filter(l => l.borrowerId === borrower.id);
            if (borrowerLoans.length > 0) {
                const recentLoan = borrowerLoans[borrowerLoans.length - 1]; // Use the most recent loan
                message = smsTemplates.welcome
                    .replace('{name}', borrower.fullName)
                    .replace('{amount}', recentLoan.amount.toLocaleString())
                    .replace('{interest}', recentLoan.interestRate);
            }
        }
        
        smsMessage.value = message;
        smsCounter.textContent = message.length;
        
        // Update template selection
        smsTemplateOptions.forEach(option => option.classList.remove('selected'));
        document.querySelector(`[data-template="${template}"]`).classList.add('selected');
    }

    // Send SMS
    function sendSms() {
        const message = smsMessage.value.trim();
        
        if (message) {
            // In a real application, this would send the SMS via an API
            showNotification('SMS sent successfully!', 'success');
            closeModal(smsModal);
            addNotification('SMS Sent', `Message sent to ${smsRecipientName.textContent}`);
        } else {
            showNotification('Please enter a message', 'error');
        }
    }

    // Populate user profile form
    function populateUserProfileForm() {
        userFullName.value = currentUser.name;
        userUsername.value = currentUser.username;
        userEmail.value = currentUser.email;
        userPhone.value = currentUser.phone;
        userRoleSelect.value = currentUser.role;
        userBio.value = currentUser.bio;
        
        // Reset photo placeholder
        userProfilePhoto.innerHTML = '<i class="fas fa-user"></i>';
        userProfilePhoto.style.backgroundImage = '';
        
        // Set photo if exists
        if (currentUser.photo) {
            userProfilePhoto.style.backgroundImage = `url(${currentUser.photo})`;
            userProfilePhoto.innerHTML = '';
        }
    }

    // Save user profile
    function saveUserProfile() {
        currentUser.name = userFullName.value;
        currentUser.email = userEmail.value;
        currentUser.phone = userPhone.value;
        currentUser.bio = userBio.value;
        
        // Update user info in the header
        userName.textContent = currentUser.name;
        profileName.textContent = currentUser.name;
        
        // Save user to localStorage
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        closeModal(userProfileModal);
        showNotification('Profile updated successfully!', 'success');
    }

    // Export data
    function exportData() {
        const selectedType = document.querySelector('.export-option.selected');
        if (!selectedType) {
            showNotification('Please select data to export', 'error');
            return;
        }
        
        const type = selectedType.getAttribute('data-type');
        const format = exportFormat.value;
        const dateRange = exportDateRange.value;
        
        let dataToExport = {};
        
        if (type === 'borrowers') {
            dataToExport = { borrowers };
        } else if (type === 'loans') {
            dataToExport = { loans };
        } else if (type === 'repayments') {
            dataToExport = { repayments };
        } else if (type === 'all') {
            dataToExport = { borrowers, loans, repayments };
        }
        
        // Apply date range filter if needed
        if (dateRange !== 'all') {
            // In a real application, this would filter the data based on the selected date range
            // For demo purposes, we'll just use the data as is
        }
        
        // Export the data
        if (format === 'json') {
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `${type}_export_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        } else if (format === 'csv') {
            // In a real application, this would convert the data to CSV format
            showNotification('CSV export not implemented in this demo', 'info');
        } else if (format === 'excel') {
            // In a real application, this would convert the data to Excel format
            showNotification('Excel export not implemented in this demo', 'info');
        }
        
        closeModal(exportModal);
        showNotification('Data exported successfully!', 'success');
    }

    // Backup data
    function backupData() {
        showLoadingOverlay();
        
        setTimeout(() => {
            const dataToBackup = {
                borrowers,
                loans,
                repayments,
                systemSettings,
                backupDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(dataToBackup, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const backupFileName = `tanzanialoanpro_backup_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', backupFileName);
            linkElement.click();
            
            hideLoadingOverlay();
            showNotification('Data backed up successfully!', 'success');
        }, 1000);
    }

    // Restore data
    function restoreData() {
        const file = restoreFile.files[0];
        if (!file) {
            showNotification('Please select a backup file', 'error');
            return;
        }
        
        if (!confirm('Are you sure you want to restore data? This will replace all current data.')) {
            return;
        }
        
        showLoadingOverlay();
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                // Restore data
                if (data.borrowers) borrowers = data.borrowers;
                if (data.loans) loans = data.loans;
                if (data.repayments) repayments = data.repayments;
                if (data.systemSettings) {
                    systemSettings = data.systemSettings;
                    applySystemSettings();
                }
                
                // Save to localStorage
                saveDataToLocalStorage();
                
                // Reload all data
                loadDashboardData();
                loadBorrowersTable();
                loadLoansTable();
                loadRepaymentsTable();
                loadProfitDashboard();
                
                hideLoadingOverlay();
                showNotification('Data restored successfully!', 'success');
            } catch (error) {
                hideLoadingOverlay();
                showNotification('Error restoring data. Please check the backup file.', 'error');
            }
        };
        
        reader.readAsText(file);
    }

    // Save data to localStorage
    function saveDataToLocalStorage() {
        localStorage.setItem('borrowers', JSON.stringify(borrowers));
        localStorage.setItem('loans', JSON.stringify(loans));
        localStorage.setItem('repayments', JSON.stringify(repayments));
    }

    // Apply system settings
    function applySystemSettings() {
        // Update system name in title
        document.title = systemSettings.systemName;
        
        // Update form values if they exist
        if (systemName) systemName.value = systemSettings.systemName;
        if (currency) currency.value = systemSettings.currency;
        if (dateFormat) dateFormat.value = systemSettings.dateFormat;
        if (language) language.value = systemSettings.language;
        if (emailNotifications) emailNotifications.checked = systemSettings.emailNotifications;
        if (smsNotifications) smsNotifications.checked = systemSettings.smsNotifications;
        if (paymentReminders) paymentReminders.checked = systemSettings.paymentReminders;
        if (overdueAlerts) overdueAlerts.checked = systemSettings.overdueAlerts;
        if (reminderDays) reminderDays.value = systemSettings.reminderDays;
        if (autoBackup) autoBackup.checked = systemSettings.autoBackup;
        if (backupFrequency) backupFrequency.value = systemSettings.backupFrequency;
        if (interestCalculation) interestCalculation.value = systemSettings.interestCalculation;
        if (defaultLoanDuration) defaultLoanDuration.value = systemSettings.defaultLoanDuration;
        if (defaultInterestRate) defaultInterestRate.value = systemSettings.defaultInterestRate;
    }

    // Save general settings
    function saveGeneralSettingsHandler() {
        systemSettings.systemName = systemName.value;
        systemSettings.currency = currency.value;
        systemSettings.dateFormat = dateFormat.value;
        systemSettings.language = language.value;
        systemSettings.interestCalculation = interestCalculation.value;
        systemSettings.defaultLoanDuration = parseInt(defaultLoanDuration.value);
        systemSettings.defaultInterestRate = parseFloat(defaultInterestRate.value);
        
        localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
        applySystemSettings();
        showNotification('General settings saved successfully!', 'success');
    }

    // Save notification settings
    function saveNotificationSettingsHandler() {
        systemSettings.emailNotifications = emailNotifications.checked;
        systemSettings.smsNotifications = smsNotifications.checked;
        systemSettings.paymentReminders = paymentReminders.checked;
        systemSettings.overdueAlerts = overdueAlerts.checked;
        systemSettings.reminderDays = parseInt(reminderDays.value);
        
        localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
        showNotification('Notification settings saved successfully!', 'success');
    }

    // Save backup settings
    function saveBackupSettingsHandler() {
        systemSettings.autoBackup = autoBackup.checked;
        systemSettings.backupFrequency = backupFrequency.value;
        
        localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
        showNotification('Backup settings saved successfully!', 'success');
    }

    // Show loading overlay
    function showLoadingOverlay() {
        loadingOverlay.style.display = 'flex';
    }

    // Hide loading overlay
    function hideLoadingOverlay() {
        loadingOverlay.style.display = 'none';
    }

    // Notification System
    function addNotification(title, message) {
        const notification = {
            id: Date.now(),
            title,
            message,
            timestamp: new Date().toISOString(),
            read: false
        };
        
        notifications.unshift(notification);
        
        // Keep only last 50 notifications
        if (notifications.length > 50) {
            notifications = notifications.slice(0, 50);
        }
        
        localStorage.setItem('notifications', JSON.stringify(notifications));
        loadNotifications();
        
        // Play notification sound
        playNotificationSound();
    }

    function loadNotifications() {
        notificationList.innerHTML = '';
        
        if (notifications.length === 0) {
            notificationList.innerHTML = '<div class="notification-item"><p>No notifications</p></div>';
            notificationBadge.textContent = '0';
            return;
        }
        
        let unreadCount = 0;
        
        notifications.forEach(notification => {
            const item = document.createElement('div');
            item.className = `notification-item ${notification.read ? '' : 'unread'}`;
            
            const timeAgo = getTimeAgo(new Date(notification.timestamp));
            
            item.innerHTML = `
                <div class="notification-item-header">
                    <span class="notification-item-title">${notification.title}</span>
                    <span class="notification-item-time">${timeAgo}</span>
                </div>
                <div class="notification-item-message">${notification.message}</div>
            `;
            
            notificationList.appendChild(item);
            
            if (!notification.read) {
                unreadCount++;
            }
        });
        
        notificationBadge.textContent = unreadCount > 0 ? unreadCount : '';
    }

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
        if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
        
        return date.toLocaleDateString();
    }

    function playNotificationSound() {
        // Create a simple beep sound using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    }
</script>
</body>
</html>
