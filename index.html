<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TanzaniaLoanPro - Loan Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 
 
 
 <style>
        :root {
            --primary-color: #2e86de;
            --secondary-color: #54a0ff;
            --danger-color: #ee5253;
            --warning-color: #ff9f43;
            --success-color: #10ac84;
            --info-color: #0abde3;
            --light-color: #f5f6fa;
            --dark-color: #222f3e;
            --white-color: #ffffff;
            --gray-color: #576574;
            --light-gray: #f1f2f6;
            --border-color: #ddd;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --card-bg: #ffffff;
            --text-color: #222f3e;
            --text-light: #576574;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --sidebar-hover: #34495e;
            --sidebar-active: #3498db;
        }

        .dark-mode {
            --primary-color: #dee1e4;
            --secondary-color: #3498db;
            --danger-color: #c0392b;
            --light-color: #34495e;
            --dark-color: #ecf0f1;
            --text-color: #ecf0f1;
            --text-light: #bdc3c7;
            --card-bg: #2c3e50;
            --border-color: #4a6278;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --sidebar-hover: #34495e;
            --sidebar-active: #3498db;
            --white-color: #2c3e50;
            --light-gray: #2e3233;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: var(--dark-color);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--sidebar-bg);
        }

        .sidebar-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--sidebar-text);
        }

        .sidebar-menu {
            padding: 10px 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            margin: 2px 0;
            border-radius: 0 25px 25px 0;
            margin-right: 10px;
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--sidebar-hover);
            color: white;
            border-left: 3px solid var(--sidebar-active);
        }

        .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .nav-text {
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .header-title h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-success {
            background-color: var(--success-color);
            color: var(--white-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: var(--white-color);
        }

        .btn-secondary {
            background-color: var(--gray-color);
            color: var(--white-color);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        /* Card Styles */
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color);
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .card:hover {
            box-shadow: 0 8px 25px var(--shadow-color);
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
        }

        .card-header h3 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .card-body {
            padding: 20px;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 15px var(--shadow-color);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .stat-card:hover {
            box-shadow: 0 8px 25px var(--shadow-color);
        }

        .stat-card h4 {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card p {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin: 0;
        }

        .stat-card .stat-icon {
            font-size: 2.5rem;
            color: var(--secondary-color);
            margin-bottom: 10px;
            opacity: 0.7;
        }

        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--light-color);
            font-weight: 600;
            color: var(--text-color);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .input-group-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Status Indicators */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }

        .status-pending {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }

        .status-overdue {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .status-completed {
            background: rgba(52, 152, 219, 0.1);
            color: var(--secondary-color);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
        }

        .modal-header h3 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            color: var(--danger-color);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: var(--light-color);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1200;
            display: none;
            animation: notificationSlideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes notificationSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        /* Section Styles */
        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Borrower Details */
        .borrower-details-container {
            display: none;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .borrower-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .borrower-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .borrower-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            border: 3px solid var(--light-color);
        }

        .borrower-photo i {
            font-size: 2.5rem;
            color: white;
        }

        .borrower-text h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .borrower-text p {
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .borrower-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .borrower-stat {
            padding: 15px 20px;
            background: var(--light-color);
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
        }

        .borrower-stat h4 {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .borrower-stat p {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .borrower-tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 25px;
            gap: 5px;
        }

        .borrower-tab {
            padding: 15px 25px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: var(--text-light);
            border-radius: 8px 8px 0 0;
        }

        .borrower-tab.active {
            border-bottom: 3px solid var(--secondary-color);
            color: var(--secondary-color);
            background: rgba(52, 152, 219, 0.1);
        }

        .borrower-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .borrower-content.active {
            display: block;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .info-card {
            background: var(--light-color);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .info-card h4 {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-card p {
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .info-card strong {
            color: var(--primary-color);
        }

        /* Photo Upload */
        .photo-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .photo-placeholder {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--light-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            border: 3px solid var(--secondary-color);
            transition: all 0.3s ease;
        }

        .photo-placeholder:hover {
            transform: scale(1.05);
        }

        .photo-placeholder i {
            font-size: 3rem;
            color: var(--text-light);
        }

        /* Select Options */
        .select-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .select-option {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .select-option:hover {
            border-color: var(--secondary-color);
        }

        .select-option.selected {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 300px;
            position: relative;
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--secondary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-active {
            background-color: var(--success-color);
        }

        .status-pending {
            background-color: var(--warning-color);
        }

        .status-overdue {
            background-color: var(--danger-color);
        }

        .status-completed {
            background-color: var(--info-color);
        }

        .status-inactive {
            background-color: var(--gray-color);
        }

        /* Action Buttons */
        .action-button {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            margin-right: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .view-button {
            background-color: var(--info-color);
            color: var(--white-color);
        }

        .edit-button {
            background-color: var(--warning-color);
            color: var(--white-color);
        }

        .delete-button {
            background-color: var(--danger-color);
            color: var(--white-color);
        }

        .call-button {
            background-color: var(--success-color);
            color: var(--white-color);
        }

        .sms-button {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .download-button {
            background-color: var(--secondary-color);
            color: var(--white-color);
        }

        /* Floating Action Button */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .fab:hover {
            background-color: var(--secondary-color);
            transform: scale(1.1);
        }

        .fab-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 8px var(--shadow-color);
            width: 200px;
            overflow: hidden;
            display: none;
        }

        .fab-menu.active {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        .fab-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-color);
            text-decoration: none;
            transition: all 0.2s;
        }

        .fab-item:hover {
            background-color: var(--light-color);
        }

        .fab-item i {
            width: 20px;
            text-align: center;
        }

        /* SMS Template Styles */
        .sms-template {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
        }

        .sms-template h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .sms-template-content {
            background-color: var(--light-color);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .sms-template-actions {
            display: flex;
            gap: 10px;
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
                overflow: hidden;
            }

            .sidebar-header h2, .nav-text {
                display: none;
            }

            .nav-link {
                justify-content: center;
                padding: 15px 0;
                margin: 2px 5px;
            }

            .nav-link i {
                margin-right: 0;
                font-size: 1.3rem;
            }

            .main-content {
                margin-left: 70px;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .input-group-row {
                grid-template-columns: 1fr;
            }

            .borrower-info {
                flex-direction: column;
                text-align: center;
            }

            .borrower-stats {
                justify-content: center;
            }
            
            .chart-container {
                height: 250px;
            }
        }

        @media (max-width: 576px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 10px 0;
            }

            .sidebar-menu {
                display: flex;
                overflow-x: auto;
                padding: 10px 0;
                white-space: nowrap;
            }

            .nav-link {
                padding: 10px 15px;
                border-left: none;
                border-bottom: 3px solid transparent;
                margin: 0 5px;
            }

            .nav-link:hover, .nav-link.active {
                border-left: none;
                border-bottom: 3px solid var(--sidebar-active);
            }

            .main-content {
                margin-left: 0;
                margin-top: 60px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-actions {
                flex-wrap: wrap;
                justify-content: flex-start;
            }
            
            .borrower-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .borrower-stat {
                min-width: 100px;
                padding: 10px 15px;
            }
            
            .borrower-stat p {
                font-size: 1rem;
            }
        }

        /* Print Styles */
        @media print {
            .sidebar, .header-actions, .no-print, .action-button, .btn {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0 !important;
                padding: 0 !important;
            }
            
            .card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
            }
            
            .borrower-details-container {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 20px;
            color: var(--text-light);
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
        }
        
        /* Statement Styles */
        .statement-container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .statement-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .statement-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .statement-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .statement-table th, 
        .statement-table td {
            padding: 10px;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        
        .statement-table th {
            background-color: var(--light-color);
        }
        
        .statement-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: 8px;
        }
        
        /* Filter Styles */
        .filter-container {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        /* Report Styles */
        .report-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .report-summary-card {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .report-summary-card h4 {
            margin-bottom: 10px;
            color: var(--text-light);
        }
        
        .report-summary-card p {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
    </style>
	
</head>
<body>

    <div class="container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
		
            <div class="sidebar-header">
                <h2 id="appTitle">TanzaniaLoanPro</h2>
            </div>
            <div class="sidebar-menu">
                <a href="#" class="nav-link active" data-target="home">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="#" class="nav-link" data-target="all-borrowers">
                    <i class="fas fa-users"></i>
                    <span class="nav-text">All Borrowers</span>
                </a>
                <a href="#" class="nav-link" data-target="loan-calculator">
                    <i class="fas fa-calculator"></i>
                    <span class="nav-text">Loan Calculator</span>
                </a>
                <a href="#" class="nav-link" data-target="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span class="nav-text">Reports</span>
                </a>
                <a href="#" class="nav-link" data-target="reminders">
                    <i class="fas fa-bell"></i>
                    <span class="nav-text">Reminders</span>
                </a>
                <a href="#" class="nav-link" data-target="compliance">
                    <i class="fas fa-shield-alt"></i>
                    <span class="nav-text">Compliance</span>
                </a>
                <a href="#" class="nav-link admin-only" data-target="admin-features">
                    <i class="fas fa-cog"></i>
                    <span class="nav-text">Admin</span>
                </a>
                <a href="#" class="nav-link" data-target="settings">
                    <i class="fas fa-cog"></i>
                    <span class="nav-text">Settings</span>
                </a>
            </div>
            
            <div class="sidebar-footer">
                <button id="logoutBtn" class="btn btn-danger btn-block">
                    <i class="fas fa-sign-out-alt"></i> <span class="nav-text">Logout</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-title">
                    <h1>Dashboard</h1>
                    <span id="userRoleBadge" class="role-badge"></span>
                </div>
                <div class="header-actions">
                    <button id="darkModeToggle" class="btn btn-icon btn-secondary">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="language-selector">
                        <button class="btn btn-secondary language-btn active" data-lang="en">EN</button>
                        <button class="btn btn-secondary language-btn" data-lang="sw">SW</button>
                    </div>
                    <div class="currency-selector">
                        <button class="btn btn-secondary currency-btn active" data-currency="TZS">TZS</button>
                        <button class="btn btn-secondary currency-btn" data-currency="USD">USD</button>
                    </div>
                </div>
            </div>

            <!-- Notification -->
            <div id="notification" class="notification"></div>

            <!-- Dashboard Section -->
            <div id="home" class="section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Loan Disbursed</h4>
                        <p id="dashboardLoanDisbursed">TZS 0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Money Received</h4>
                        <p id="dashboardMoneyReceived">TZS 0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Loan Pending</h4>
                        <p id="dashboardLoanPending">TZS 0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Active Borrowers</h4>
                        <p id="dashboardActiveBorrowers">0</p>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Overdue Loans</h4>
                        <p id="dashboardOverdueLoans">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Pending Reminders</h4>
                        <p id="dashboardPendingReminders">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Total Profit</h4>
                        <p id="dashboardTotalProfit">TZS 0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Active Regions</h4>
                        <p id="dashboardActiveRegions">0</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Recent Repayments</h3>
                        <button class="btn btn-primary btn-sm" onclick="loadRepayments()">View All</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Borrower</th>
                                        <th>Region</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="recentRepayments">
                                    <tr>
                                        <td colspan="5" style="text-align: center;">No recent repayments</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3>Loan Portfolio Overview</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                            <div class="chart-container">
                                <canvas id="loanPerformanceChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="portfolioDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3>Monthly Profit Overview</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="profitChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- All Borrowers Section -->
            <div id="all-borrowers" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3>All Borrowers</h3>
                        <div class="header-actions">
                            <input type="text" id="borrowerSearch" class="form-control" placeholder="Search borrowers..." style="width: 200px;">
                            <button class="btn btn-secondary" onclick="exportBorrowersList()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-primary manager-only loan-officer-only" onclick="showNewBorrowerModal()">
                                <i class="fas fa-user-plus"></i> New Borrower
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Region</th>
                                        <th>Phone</th>
                                        <th>Loan Amount</th>
                                        <th>Total Amount</th>
                                        <th>Balance</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="borrowersList">
                                    <tr>
                                        <td colspan="8" style="text-align: center;">Loading borrowers...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Borrower Details Section -->
            <div id="borrower-details" class="section">
                <div id="borrowerDetailsContainer" class="borrower-details-container">
                    <div class="borrower-header">
                        <div class="borrower-info">
                            <div id="detailPhotoPlaceholder" class="borrower-photo">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="borrower-text">
                                <h2 id="borrowerName">Loading...</h2>
                                <p id="borrowerId">ID: Loading...</p>
                                <div class="borrower-stats">
                                    <div class="borrower-stat">
                                        <h4>Loan Amount</h4>
                                        <p id="detailLoanAmount">TZS 0</p>
                                    </div>
                                    <div class="borrower-stat">
                                        <h4>Balance</h4>
                                        <p id="detailBalance">TZS 0</p>
                                    </div>
                                    <div class="borrower-stat">
                                        <h4>Status</h4>
                                        <p id="detailStatus">Loading</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-secondary" onclick="printBorrowerStatement()" style="margin-left: 10px;">
                                <i class="fas fa-print"></i> Statement
                            </button>
                        </div>
                    </div>

                    <div class="borrower-tabs">
                        <div class="borrower-tab active" data-tab="personal">Personal Info</div>
                        <div class="borrower-tab" data-tab="loan">Loan Info</div>
                        <div class="borrower-tab" data-tab="payments">Payments</div>
                        <div class="borrower-tab" data-tab="documents">Documents</div>
                    </div>

                    <div id="personalTab" class="borrower-content active">
                        <div class="info-grid">
                            <div class="info-card">
                                <h4>Contact Information</h4>
                                <p><strong>Phone:</strong> <span id="detailPhone">Loading...</span></p>
                                <p><strong>Email:</strong> <span id="detailEmail">Loading...</span></p>
                            </div>
                            <div class="info-card">
                                <h4>Address</h4>
                                <p><strong>Region:</strong> <span id="detailRegion">Loading...</span></p>
                                <p><strong>Address:</strong> <span id="detailAddress">Loading...</span></p>
                            </div>
                            <div class="info-card">
                                <h4>Business Information</h4>
                                <p id="detailBusiness">Loading...</p>
                            </div>
                            <div class="info-card">
                                <h4>Guarantor</h4>
                                <p id="detailGuarantor">Loading...</p>
                            </div>
                        </div>
                    </div>

                    <div id="loanTab" class="borrower-content">
                        <div class="info-grid">
                            <div class="info-card">
                                <h4>Loan Details</h4>
                                <p><strong>Amount:</strong> <span id="detailLoanAmount2">TZS 0</span></p>
                                <p><strong>Interest Rate:</strong> <span id="detailInterestRate">0%</span></p>
                                <p><strong>Total Amount:</strong> <span id="detailTotalAmount">TZS 0</span></p>
                            </div>
                            <div class="info-card">
                                <h4>Payment Information</h4>
                                <p><strong>Amount Paid:</strong> <span id="detailAmountPaid">TZS 0</span></p>
     
                                <p><strong>Balance:</strong> <span id="detailBalance2">TZS 0</span></p>
                                <p><strong>Payment Frequency:</strong> <span id="detailPaymentFrequency">Loading...</span></p>
                            </div>
                            <div class="info-card">
                                <h4>Loan Term</h4>
                                <p><strong>Start Date:</strong> <span id="detailStartDate">Loading...</span></p>
                                <p><strong>End Date:</strong> <span id="detailEndDate">Loading...</span></p>
                                <p><strong>Days Remaining:</strong> <span id="detailDaysRemaining">0</span></p>
                            </div>
                            <div class="info-card">
                                <h4>Collateral</h4>
                                <p id="detailCollateral">Loading...</p>
                            </div>
                        </div>

                        <h4 style="margin: 20px 0 10px;">Payment Schedule</h4>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Due Date</th>
                                        <th>Amount Due</th>
                                        <th>Status</th>
                                        <th>Payment Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentSchedule">
                                    <tr>
                                        <td colspan="5" style="text-align: center;">Loading payment schedule...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="paymentsTab" class="borrower-content">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>Reference</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="borrowerPayments">
                                    <tr>
                                        <td colspan="6" style="text-align: center;">Loading payment history...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="documentsTab" class="borrower-content">
                        <div class="info-grid">
                            <div class="info-card">
                                <h4>ID Document</h4>
                                <p><strong>Type:</strong> <span id="detailIdType">Loading...</span></p>
                                <p><strong>Number:</strong> <span id="detailIdNumber">Loading...</span></p>
                                <button class="btn btn-secondary" style="margin-top: 10px;" onclick="downloadDocument('id')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                            <div class="info-card">
                                <h4>Loan Agreement</h4>
                                <p><strong>Signed:</strong> <span id="detailAgreementSigned">Loading...</span></p>
                                <p><strong>Date:</strong> <span id="detailAgreementDate">Loading...</span></p>
                                <button class="btn btn-secondary" style="margin-top: 10px;" onclick="downloadDocument('agreement')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                            <div class="info-card">
                                <h4>Collateral Documents</h4>
                                <p id="detailCollateralDocs">Loading...</p>
                                <button class="btn btn-secondary" style="margin-top: 10px;" onclick="downloadDocument('collateral')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                            <div class="info-card">
                                <h4>Other Documents</h4>
                                <button class="btn btn-primary" style="margin-top: 10px;" onclick="uploadDocument()">
                                    <i class="fas fa-upload"></i> Upload Document
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loan Calculator Section -->
            <div id="loan-calculator" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3>Loan Calculator</h3>
                    </div>
                    <div class="card-body">
                        <form id="calculatorForm">
                            <div class="input-group-row">
                                <div class="input-group">
                                    <label for="calcLoanAmount">Loan Amount</label>
                                    <input type="number" id="calcLoanAmount" class="form-control" value="1000000">
                                </div>
                                <div class="input-group">
                                    <label for="calcInterestRate">Interest Rate (%)</label>
                                    <input type="number" id="calcInterestRate" class="form-control" value="24" step="0.1">
                                </div>
                            </div>

                            <div class="input-group-row">
                                <div class="input-group">
                                    <label for="calcTerm">Term</label>
                                    <input type="number" id="calcTerm" class="form-control" value="180">
                                </div>
                                <div class="input-group">
                                    <label for="calcTermUnit">Term Unit</label>
                                    <select id="calcTermUnit" class="form-control">
                                        <option value="days">Days</option>
                                        <option value="weeks">Weeks</option>
                                        <option value="months">Months</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="calcPaymentFrequency">Payment Frequency</label>
                                    <select id="calcPaymentFrequency" class="form-control">
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="bullet">Bullet Payment</option>
                                    </select>
                                </div>
                            </div>

                            <div class="input-group-row">
                                <div class="input-group">
                                    <label for="calcStartDate">Start Date</label>
                                    <input type="date" id="calcStartDate" class="form-control">
                                </div>
                                <div class="input-group">
                                    <label for="calcProcessingFee">Processing Fee (%)</label>
                                    <input type="number" id="calcProcessingFee" class="form-control" value="2" step="0.1">
                                </div>
                                <div class="input-group">
                                    <label for="calcTaxRate">Tax Rate (%)</label>
                                    <input type="number" id="calcTaxRate" class="form-control" value="0" step="0.1">
                                </div>
                            </div>

                            <div class="input-group" style="margin-top: 20px;">
                                <button type="button" id="calculateLoanBtn" class="btn btn-primary">
                                    <i class="fas fa-calculator"></i> Calculate Loan
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="printLoanCalculation()" style="margin-left: 10px;">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </div>
                        </form>

                        <div style="margin-top: 30px;">
                            <h4>Loan Summary</h4>
                            <div class="info-grid" style="margin-top: 10px;">
                                <div class="info-card">
                                    <h4>Total Amount</h4>
                                    <p id="calcTotalAmount">TZS 0</p>
                                </div>
                                <div class="info-card">
                                    <h4>Per Payment</h4>
                                    <p id="calcPerPayment">TZS 0</p>
                                </div>
                                <div class="info-card">
                                    <h4>Number of Payments</h4>
                                    <p id="calcNumPayments">0</p>
                                </div>
                                <div class="info-card">
                                    <h4>Effective Interest Rate</h4>
                                    <p id="calcEffectiveRate">0%</p>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 30px;">
                            <h4>Payment Schedule</h4>
                            <div class="table-responsive" style="margin-top: 10px;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Date</th>
                                            <th>Principal</th>
                                            <th>Interest</th>
                                            <th>Fees</th>
                                            <th>Total</th>
                                            <th>Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody id="calcSchedule">
                                        <tr>
                                            <td colspan="7" style="text-align: center;">Calculate loan to see schedule</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3>Reports</h3>
                        <div class="header-actions">
                            <select id="reportType" class="form-control" style="width: 200px;">
                                <option value="">Select Report Type</option>
                                <option value="disbursement">Loan Disbursement</option>
                                <option value="repayment">Repayment Collection</option>
                                <option value="risk">Portfolio at Risk</option>
                                <option value="delinquency">Delinquency Report</option>
                                <option value="profitability">Profitability Report</option>
                            </select>
                            <button class="btn btn-primary" onclick="generateReport()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-secondary" onclick="printReport()" style="margin-left: 10px;">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="filter-container">
                            <div class="filter-row">
                                <div>
                                    <label>From Date</label>
                                    <input type="date" id="reportFromDate" class="form-control">
                                </div>
                                <div>
                                    <label>To Date</label>
                                    <input type="date" id="reportToDate" class="form-control">
                                </div>
                                <div>
                                    <label>Region</label>
                                    <select id="reportRegion" class="form-control">
                                        <option value="">All Regions</option>
                                        <option>Dar es Salaam</option>
                                        <option>Arusha</option>
                                        <option>Mwanza</option>
                                        <option>Dodoma</option>
                                        <option>Mbeya</option>
                                    </select>
                                </div>
                                <div style="align-self: flex-end;">
                                    <button class="btn btn-primary btn-block" onclick="filterReports()">
                                        <i class="fas fa-filter"></i> Filter
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="reportSummary" class="report-summary" style="display: none;">
                            <!-- Report summary will be dynamically generated here -->
                        </div>

                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                            <div class="card">
                                <div class="card-header">
                                    <h4 id="reportChartTitle">Loan Disbursement Trend</h4>
                                </div>
                                <div class="card-body" style="height: 300px;">
                                    <canvas id="reportChart"></canvas>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h4 id="reportPieChartTitle">Portfolio Distribution</h4>
                                </div>
                                <div class="card-body" style="height: 300px;">
                                    <canvas id="reportPieChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header">
                                <h4 id="reportDataTitle">Detailed Report Data</h4>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table>
                                        <thead id="reportDataHeader">
                                            <tr>
                                                <th>Month</th>
                                                <th>Loans Disbursed</th>
                                                <th>Amount Disbursed</th>
                                                <th>Repayments Collected</th>
                                                <th>Amount Collected</th>
                                                <th>PAR 30 Days</th>
                                                <th>PAR 60 Days</th>
                                                <th>PAR 90 Days</th>
                                            </tr>
                                        </thead>
                                        <tbody id="reportData">
                                            <tr>
                                                <td colspan="8" style="text-align: center;">Select report type and apply filters</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            </div>
                    </div>
                </div>
            </div>

            <!-- Reminders Section -->
            <div id="reminders" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3>Reminders</h3>
                        <div class="header-actions">
                            <button class="btn btn-primary manager-only loan-officer-only" onclick="addReminder()">
                                <i class="fas fa-plus"></i> Add Reminder
                            </button>
                            <button class="btn btn-secondary" onclick="exportReminders()" style="margin-left: 10px;">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="filter-container">
                            <div class="filter-row">
                                <div>
                                    <label>Reminder Type</label>
                                    <select id="reminderTypeFilter" class="form-control">
                                        <option value="">All Types</option>
                                        <option>Payment Due</option>
                                        <option>Overdue</option>
                                        <option>Follow-up</option>
                                        <option>Renewal</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Status</label>
                                    <select id="reminderStatusFilter" class="form-control">
                                        <option value="">All Statuses</option>
                                        <option>Pending</option>
                                        <option>Completed</option>
                                        <option>Canceled</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Date Range</label>
                                    <select id="reminderDateFilter" class="form-control">
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month">This Month</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                </div>
                                <div style="align-self: flex-end;">
                                    <button class="btn btn-primary btn-block" onclick="filterReminders()">
                                        <i class="fas fa-filter"></i> Filter
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Borrower</th>
                                        <th>Type</th>
                                        <th>Due Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Method</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="remindersList">
                                    <tr>
                                        <td colspan="7" style="text-align: center;">Loading reminders...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compliance Section -->
            <div id="compliance" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3>Compliance Dashboard</h3>
                    </div>
                    <div class="card-body">
                        <div class="compliance-actions" style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button id="kycVerifyBtn" class="btn btn-primary manager-only">
                                <i class="fas fa-user-check"></i> KYC Verification
                            </button>
                            <button id="amlCheckBtn" class="btn btn-primary manager-only">
                                <i class="fas fa-search-dollar"></i> AML Investigation
                            </button>
                            <button id="uploadDocBtn" class="btn btn-primary manager-only">
                                <i class="fas fa-file-upload"></i> Upload Document
                            </button>
                            <button id="botComplianceBtn" class="btn btn-primary manager-only">
                                <i class="fas fa-shield-alt"></i> BoT Compliance
                            </button>
                        </div>
                        
                        <div class="compliance-status" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div class="status-card" style="background: var(--light-color); padding: 15px; border-radius: 8px; text-align: center;">
                                <h4>KYC Status</h4>
                                <p id="kycStatus">Not verified</p>
                            </div>
                            <div class="status-card" style="background: var(--light-color); padding: 15px; border-radius: 8px; text-align: center;">
                                <h4>AML Status</h4>
                                <p id="amlStatus">Not checked</p>
                            </div>
                            <div class="status-card" style="background: var(--light-color); padding: 15px; border-radius: 8px; text-align: center;">
                                <h4>BoT Compliance</h4>
                                <p id="botStatus">Not checked</p>
                            </div>
                        </div>
                        
                        <h4>Documents</h4>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Document Name</th>
                                        <th>Upload Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="documentsList">
                                    <tr>
                                        <td colspan="3">No documents found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Features Section -->
            <div id="admin-features" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3>User Management</h3>
                        <button id="addUserBtn" class="btn btn-primary admin-only">
                            <i class="fas fa-user-plus"></i> Add User
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Regions</th>
                                        <th>Last Login</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="userList">
                                    <tr>
                                        <td colspan="7" style="text-align: center;">Loading users...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3>System Settings</h3>
                    </div>
                    <div class="card-body">
                        <form id="systemSettingsForm">
                            <div class="input-group-row">
                                <div class="input-group">
                                    <label for="systemName">System Name</label>
                                    <input type="text" id="systemName" class="form-control" value="TanzaniaLoanPro">
                                </div>
                                <div class="input-group">
                                    <label for="defaultCurrency">Default Currency</label>
                                    <select id="defaultCurrency" class="form-control">
                                        <option value="TZS" selected>Tanzanian Shilling (TZS)</option>
                                        <option value="USD">US Dollar (USD)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="input-group-row">
                                <div class="input-group">
                                    <label for="defaultLanguage">Default Language</label>
                                    <select id="defaultLanguage" class="form-control">
                                        <option value="en" selected>English</option>
                                        <option value="sw">Swahili</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="timezone">Timezone</label>
                                    <select id="timezone" class="form-control">
                                        <option value="Africa/Dar_es_Salaam" selected>Africa/Dar es Salaam (EAT)</option>
                                        <option value="UTC">UTC</option>
                                    </select>
                                </div>
                            </div>

                            <div class="input-group-row">
                                <div class="input-group">
                                    <label for="smsIntegration">SMS Integration</label>
                                    <select id="smsIntegration" class="form-control">
                                        <option value="none">None</option>
                                        <option value="africas_talking" selected>Africa's Talking</option>
                                        <option value="twilio">Twilio</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="emailIntegration">Email Integration</label>
                                    <select id="emailIntegration" class="form-control">
                                        <option value="none">None</option>
                                        <option value="smtp" selected>SMTP</option>
                                        <option value="mailgun">Mailgun</option>
                                        <option value="sendgrid">SendGrid</option>
                                    </select>
                                </div>
                            </div>

                            <div class="input-group-row">
                                <div class="input-group">
                                    <label for="backupFrequency">Backup Frequency</label>
                                    <select id="backupFrequency" class="form-control">
                                        <option value="daily">Daily</option>
                                        <option value="weekly" selected>Weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="backupLocation">Backup Location</label>
                                    <select id="backupLocation" class="form-control">
                                        <option value="local">Local Server</option>
                                        <option value="cloud" selected>Cloud Storage</option>
                                        <option value="both">Both</option>
                                    </select>
                                </div>
                            </div>

                            <div class="input-group" style="margin-top: 20px;">
                                <button type="button" class="btn btn-primary admin-only" onclick="saveSystemSettings()">
                                    <i class="fas fa-save"></i> Save Settings
                                </button>
                                <button type="button" class="btn btn-secondary admin-only" onclick="backupSystem()" style="margin-left: 10px;">
                                    <i class="fas fa-database"></i> Backup Now
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
    

    <!-- Settings Section - Redesigned -->
            <div id="settings" class="section">
                <div class="settings-container">
                    <!-- System Settings Card -->
                    <div class="card settings-card">
                        <div class="card-header">
                            <h3>System Settings</h3>
                        </div>
                        <div class="card-body">
                            <form id="systemSettingsForm">
                                <div class="settings-group">
                                    <h4>Basic Information</h4>
                                    <div class="input-group-row">
                                        <div class="input-group">
                                            <label for="systemName">System Name</label>
                                            <input type="text" id="systemName" class="form-control" value="TanzaniaLoanPro">
                                        </div>
                                        <div class="input-group">
                                            <label for="defaultCurrency">Default Currency</label>
                                            <select id="defaultCurrency" class="form-control">
                                                <option value="TZS" selected>Tanzanian Shilling (TZS)</option>
                                                <option value="USD">US Dollar (USD)</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="input-group-row">
                                        <div class="input-group">
                                            <label for="defaultLanguage">Default Language</label>
                                            <select id="defaultLanguage" class="form-control">
                                                <option value="en" selected>English</option>
                                                <option value="sw">Swahili</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label for="timezone">Timezone</label>
                                            <select id="timezone" class="form-control">
                                                <option value="Africa/Dar_es_Salaam" selected>Africa/Dar es Salaam (EAT)</option>
                                                <option value="UTC">UTC</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="settings-group">
                                    <h4>Integration Settings</h4>
                                    <div class="input-group-row">
                                        <div class="input-group">
                                            <label for="smsIntegration">SMS Integration</label>
                                            <select id="smsIntegration" class="form-control">
                                                <option value="none">None</option>
                                                <option value="africas_talking" selected>Africa's Talking</option>
                                                <option value="twilio">Twilio</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label for="emailIntegration">Email Integration</label>
                                            <select id="emailIntegration" class="form-control">
                                                <option value="none">None</option>
                                                <option value="smtp" selected>SMTP</option>
                                                <option value="mailgun">Mailgun</option>
                                                <option value="sendgrid">SendGrid</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- SMS Integration Status -->
                                    <div class="integration-status">
                                        <div class="integration-info">
                                            <span class="status-indicator status-active"></span>
                                            <span>SMS Integration: Active</span>
                                        </div>
                                        <div class="integration-actions">
                                            <button class="btn btn-secondary btn-sm">Test</button>
                                            <button class="btn btn-primary btn-sm">Configure</button>
                                        </div>
                                    </div>
                                    
                                    <!-- Email Integration Status -->
                                    <div class="integration-status">
                                        <div class="integration-info">
                                            <span class="status-indicator status-active"></span>
                                            <span>Email Integration: Active</span>
                                        </div>
                                        <div class="integration-actions">
                                            <button class="btn btn-secondary btn-sm">Test</button>
                                            <button class="btn btn-primary btn-sm">Configure</button>
                                        </div>
                                    </div>
                                </div>

                                <div class="settings-group">
                                    <h4>Backup Settings</h4>
                                    <div class="input-group-row">
                                        <div class="input-group">
                                            <label for="backupFrequency">Backup Frequency</label>
                                            <select id="backupFrequency" class="form-control">
                                                <option value="daily">Daily</option>
                                                <option value="weekly" selected>Weekly</option>
                                                <option value="monthly">Monthly</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label for="backupLocation">Backup Location</label>
                                            <select id="backupLocation" class="form-control">
                                                <option value="local">Local Server</option>
                                                <option value="cloud" selected>Cloud Storage</option>
                                                <option value="both">Both</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Backup Status -->
                                    <div class="backup-status">
                                        <i class="fas fa-check-circle"></i>
                                        <div>
                                            <p><strong>Last Backup:</strong> October 15, 2023 14:30</p>
                                            <p><strong>Next Backup:</strong> October 22, 2023 02:00</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="input-group" style="margin-top: 20px;">
                                    <button type="button" class="btn btn-primary" onclick="saveSystemSettings()">
                                        <i class="fas fa-save"></i> Save Settings
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="backupSystem()" style="margin-left: 10px;">
                                        <i class="fas fa-database"></i> Backup Now
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- User Roles & Permissions Card -->
                    <div class="card settings-card">
                        <div class="card-header">
                            <h3>User Roles & Permissions</h3>
                        </div>
                        <div class="card-body">
                            <div class="settings-group">
                                <h4>Role Summary</h4>
                                <div class="input-group-row">
                                    <div class="input-group">
                                        <span class="user-role-badge role-admin">Administrator</span>
                                        <span id="adminCount">1 user</span>
                                    </div>
                                    <div class="input-group">
                                        <span class="user-role-badge role-manager">Manager</span>
                                        <span id="managerCount">2 users</span>
                                    </div>
                                </div>
                                <div class="input-group-row">
                                    <div class="input-group">
                                        <span class="user-role-badge role-loan-officer">Loan Officer</span>
                                        <span id="officerCount">5 users</span>
                                    </div>
                                    <div class="input-group">
                                        <span class="user-role-badge role-readonly">Read Only</span>
                                        <span id="readonlyCount">3 users</span>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-group">
                                <h4>Role Permissions</h4>
                                <div class="role-permissions">
                                    <h5>Administrator</h5>
                                    <div class="permission-item">
                                        <i class="fas fa-check"></i>
                                        <span>Full system access</span>
                                    </div>
                                    <div class="permission-item">
                                        <i class="fas fa-check"></i>
                                        <span>User management</span>
                                    </div>
                                    <div class="permission-item">
                                        <i class="fas fa-check"></i>
                                        <span>System configuration</span>
                                    </div>
                                </div>
                                
                                <div class="role-permissions">
                                    <h5>Manager</h5>
                                    <div class="permission-item">
                                        <i class="fas fa-check"></i>
                                        <span>Manage loans and borrowers</span>
                                    </div>
                                    <div class="permission-item">
                                        <i class="fas fa-check"></i>
                                        <span>View reports</span>
                                    </div>
                                    <div class="permission-item">
                                        <i class="fas fa-times"></i>
                                        <span>User management</span>
                                    </div>
                                </div>
                                
                                <div class="role-permissions">
                                    <h5>Loan Officer</h5>
                                    <div class="permission-item">
                                        <i class="fas fa-check"></i>
                                        <span>Add borrowers</span>
                                    </div>
                                    <div class="permission-item">
                                        <i class="fas fa-check"></i>
                                        <span>Record payments</span>
                                    </div>
                                    <div class="permission-item">
                                        <i class="fas fa-times"></i>
                                        <span>System configuration</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="settings-group">
                                <h4>Role Management</h4>
                                <p>Manage user roles and permissions from the Admin section.</p>
                                <button class="btn btn-primary" onclick="showSection('admin-features')">
                                    <i class="fas fa-cog"></i> Go to User Management
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Settings Cards -->
                <div class="settings-container">
                    <!-- Security Settings Card -->
                    <div class="card settings-card">
                        <div class="card-header">
                            <h3>Security Settings</h3>
                        </div>
                        <div class="card-body">
                            <div class="settings-group">
                                <h4>Password Policy</h4>
                                <div class="input-group">
                                    <label for="passwordLength">Minimum Password Length</label>
                                    <input type="number" id="passwordLength" class="form-control" value="8" min="6" max="20">
                                </div>
                                <div class="input-group">
                                    <label for="passwordComplexity">Password Complexity</label>
                                    <select id="passwordComplexity" class="form-control">
                                        <option value="low">Low (letters only)</option>
                                        <option value="medium" selected>Medium (letters and numbers)</option>
                                        <option value="high">High (letters, numbers, and special characters)</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="passwordExpiry">Password Expiry (days)</label>
                                    <input type="number" id="passwordExpiry" class="form-control" value="90" min="30" max="365">
                                </div>
                            </div>
                            
                            <div class="settings-group">
                                <h4>Session Management</h4>
                                <div class="input-group">
                                    <label for="sessionTimeout">Session Timeout (minutes)</label>
                                    <input type="number" id="sessionTimeout" class="form-control" value="30" min="5" max="240">
                                </div>
                                <div class="input-group">
                                    <label for="maxLoginAttempts">Maximum Login Attempts</label>
                                    <input type="number" id="maxLoginAttempts" class="form-control" value="5" min="3" max="10">
                                </div>
                            </div>
                            
                            <div class="input-group" style="margin-top: 20px;">
                                <button type="button" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Security Settings
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notification Settings Card -->
                    <div class="card settings-card">
                        <div class="card-header">
                            <h3>Notification Settings</h3>
                        </div>
                        <div class="card-body">
                            <div class="settings-group">
                                <h4>Email Notifications</h4>
                                <div class="input-group">
                                    <label>
                                        <input type="checkbox" checked> Payment reminders
                                    </label>
                                </div>
                                <div class="input-group">
                                    <label>
                                        <input type="checkbox" checked> Overdue loans
                                    </label>
                                </div>
                                <div class="input-group">
                                    <label>
                                        <input type="checkbox" checked> System updates
                                    </label>
                                </div>
                                <div class="input-group">
                                    <label>
                                        <input type="checkbox"> Monthly reports
                                    </label>
                                </div>
                            </div>
                            
                            <div class="settings-group">
                                <h4>SMS Notifications</h4>
                                <div class="input-group">
                                    <label>
                                        <input type="checkbox" checked> Payment due alerts
                                    </label>
                                </div>
                                <div class="input-group">
                                    <label>
                                        <input type="checkbox"> Loan approval notifications
                                    </label>
                                </div>
                                <div class="input-group">
                                    <label>
                                        <input type="checkbox" checked> Overdue alerts
                                    </label>
                                </div>
                            </div>
                            
                            <div class="input-group" style="margin-top: 20px;">
                                <button type="button" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Notification Settings
                                </button>
                            </div>
                        </div>
                    </div>
				</div>
				</div>
     

    <!-- Floating Action Button -->
    <div class="fab-container manager-only loan-officer-only">
        <div class="fab" id="fabMain">
            <i class="fas fa-plus"></i>
        </div>
        <div class="fab-menu" id="fabMenu">
            <a href="#" class="fab-item" onclick="showNewBorrowerModal()">
                <i class="fas fa-user-plus"></i> Add New Borrower/Loan
            </a>
            <a href="#" class="fab-item" onclick="showRecordPaymentModal()">
                <i class="fas fa-money-bill-wave"></i> Record Payment
            </a>
        </div>
    </div>

    <!-- Footer -->
    <footer class="no-print">
        <p>Designed by David Mwakajoka</p>
    </footer>

    <!-- New Borrower Modal -->
    <div id="newBorrowerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>New Borrower Registration</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="borrowerForm">
                    <div class="photo-upload">
                        <div id="photoPlaceholder" class="photo-placeholder">
                            <i class="fas fa-user"></i>
                        </div>
                        <input type="file" id="photoUpload" accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('photoUpload').click()">
                            <i class="fas fa-camera"></i> Upload Photo
                        </button>
                    </div>

                    <h4>Personal Information</h4>
                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="fullName">Full Name</label>
                            <input type="text" id="fullName" class="form-control" required>
                        </div>
                        <div class="input-group">
                            <label for="phoneNumber">Phone Number</label>
                            <input type="tel" id="phoneNumber" class="form-control" placeholder="+255" required>
                        </div>
                    </div>

                    <div class="input-group-row">
                        <div class="input-group">
                            <label>ID Type</label>
                            <div class="select-options">
                                <div class="select-option id-type-option selected" data-type="NIDA">
                                    <i class="fas fa-id-card"></i> NIDA
                                </div>
                                <div class="select-option id-type-option" data-type="Passport">
                                    <i class="fas fa-passport"></i> Passport
                                </div>
                                <div class="select-option id-type-option" data-type="Voter ID">
                                    <i class="fas fa-vote-yea"></i> Voter ID
                                </div>
                                <div class="select-option id-type-option" data-type="Driving License">
                                    <i class="fas fa-id-card-alt"></i> Driving License
                                </div>
                            </div>
                            <input type="hidden" id="idType" value="NIDA">
                        </div>
                        <div class="input-group">
                            <label for="idNumber">ID Number</label>
                            <input type="text" id="idNumber" class="form-control" required>
                        </div>
                    </div>

                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="region">Region</label>
                            <select id="region" class="form-control" required>
                                <option value="">-- Select Region --</option>
                                <option value="Dar es Salaam">Dar es Salaam</option>
                                <option value="Arusha">Arusha</option>
                                <option value="Dodoma">Dodoma</option>
                                <option value="Mwanza">Mwanza</option>
                                <option value="Mbeya">Mbeya</option>
                                <option value="Morogoro">Morogoro</option>
                                <option value="Tanga">Tanga</option>
                                <option value="Kilimanjaro">Kilimanjaro</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="district">District</label>
                            <input type="text" id="district" class="form-control" required>
                        </div>
                        <div class="input-group">
                            <label for="ward">Ward</label>
                            <input type="text" id="ward" class="form-control" required>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="address">Address</label>
                        <input type="text" id="address" class="form-control" required>
                    </div>

                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="email">Email (Optional)</label>
                            <input type="email" id="email" class="form-control">
                        </div>
                        <div class="input-group">
                            <label for="businessInfo">Business Information</label>
                            <input type="text" id="businessInfo" class="form-control">
                        </div>
                    </div>

                    <h4>Loan Information</h4>
                    <div class="input-group">
                        <label>Loan Purpose</label>
                        <div class="select-options">
                            <div class="select-option loan-purpose-option selected" data-purpose="Business">
                                <i class="fas fa-business-time"></i> Business
                            </div>
                            <div class="select-option loan-purpose-option" data-purpose="Agriculture">
                                <i class="fas fa-tractor"></i> Agriculture
                            </div>
                            <div class="select-option loan-purpose-option" data-purpose="Education">
                                <i class="fas fa-graduation-cap"></i> Education
                            </div>
                            <div class="select-option loan-purpose-option" data-purpose="Personal">
                                <i class="fas fa-user"></i> Personal
                            </div>
                            <div class="select-option loan-purpose-option" data-purpose="Emergency">
                                <i class="fas fa-ambulance"></i> Emergency
                            </div>
                        </div>
                        <input type="hidden" id="loanPurpose" value="Business">
                    </div>

                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="loanAmount">Loan Amount</label>
                            <input type="number" id="loanAmount" class="form-control" required>
                        </div>
                        <div class="input-group">
                            <label for="loanCurrency">Currency</label>
                            <select id="loanCurrency" class="form-control" required>
                                <option value="TZS">TZS</option>
                                <option value="USD">USD</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="interestRate">Interest Rate (%)</label>
                            <input type="number" id="interestRate" class="form-control" step="0.1" required>
                        </div>
                    </div>

                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="totalAmount">Total Amount</label>
                            <input type="number" id="totalAmount" class="form-control" readonly>
                        </div>
                        <div class="input-group">
                            <label for="loanTerm">Loan Term (Days)</label>
                            <input type="number" id="loanTerm" class="form-control" required>
                        </div>
                        <div class="input-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate" class="form-control" required>
                        </div>
                    </div>

                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="paymentFrequency">Payment Frequency</label>
                            <select id="paymentFrequency" class="form-control" required>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="bullet">Bullet Payment</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="collateralInfo">Collateral Information</label>
                            <input type="text" id="collateralInfo" class="form-control">
                        </div>
                    </div>

                    <h4>Guarantor Information</h4>
                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="guarantorName">Guarantor Name</label>
                            <input type="text" id="guarantorName" class="form-control">
                        </div>
                        <div class="input-group">
                            <label for="guarantorPhone">Guarantor Phone</label>
                            <input type="tel" id="guarantorPhone" class="form-control" placeholder="+255">
                        </div>
                    </div>

                    <h4>Group Loan (Optional)</h4>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="isGroupLoan"> This is a group loan
                        </label>
                    </div>

                    <div id="groupMembersContainer" style="display: none;">
                        <div id="groupMembersList"></div>
                        <button type="button" id="addGroupMemberBtn" class="btn btn-secondary">
                            <i class="fas fa-plus"></i> Add Group Member
                        </button>
                    </div>

                    <h4>Compliance</h4>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="kycVerified"> KYC Verified
                        </label>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="amlChecked"> AML Checked
                        </label>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="termsAccepted"> Terms & Conditions Accepted
                        </label>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="boTCompliance"> BoT Compliance
                        </label>
                    </div>

                    <div class="input-group" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Register Borrower
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Record Payment Modal -->
    <div id="recordPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Record Payment</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="repaymentForm">
                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="borrowerSelect">Borrower</label>
                            <select id="borrowerSelect" class="form-control" required>
                                <option value="">-- Select Borrower --</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="repaymentAmount">Amount</label>
                            <input type="number" id="repaymentAmount" class="form-control" required>
                        </div>
                        <div class="input-group">
                            <label for="repaymentCurrency">Currency</label>
                            <select id="repaymentCurrency" class="form-control" required>
                                <option value="TZS">TZS</option>
                                <option value="USD">USD</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="repaymentDate">Date</label>
                            <input type="date" id="repaymentDate" class="form-control">
                        </div>
                        <div class="input-group">
                            <label for="paymentMethod">Payment Method</label>
                            <select id="paymentMethod" class="form-control" required>
                                <option value="cash">Cash</option>
                                <option value="mobile">Mobile Money</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>
                    </div>

                    <div id="mobileMoneyOptions" style="display: none;">
                        <div class="input-group">
                            <label>Mobile Money Provider</label>
                            <div class="select-options">
                                <div class="select-option mobile-money-provider selected" data-provider="M-Pesa">
                                    <i class="fas fa-mobile-alt"></i> M-Pesa
                                </div>
                                <div class="select-option mobile-money-provider" data-provider="Tigo Pesa">
                                    <i class="fas fa-mobile-alt"></i> Tigo Pesa
                                </div>
                                <div class="select-option mobile-money-provider" data-provider="Airtel Money">
                                    <i class="fas fa-mobile-alt"></i> Airtel Money
                                </div>
                                <div class="select-option mobile-money-provider" data-provider="HaloPesa">
                                    <i class="fas fa-mobile-alt"></i> HaloPesa
                                </div>
                            </div>
                            <input type="hidden" id="mobileMoneyProvider" value="M-Pesa">
                        </div>

                        <div class="input-group-row">
                            <div class="input-group">
                                <label for="mobileTransactionId">Transaction ID</label>
                                <input type="text" id="mobileTransactionId" class="form-control">
                            </div>
                            <div class="input-group">
                                <label for="mobileConfirmationCode">Confirmation Code</label>
                                <input type="text" id="mobileConfirmationCode" class="form-control">
                            </div>
                        </div>

                        <div class="input-group">
                            <button type="button" id="verifyMobilePaymentBtn" class="btn btn-secondary">
                                <i class="fas fa-check-circle"></i> Verify Payment
                            </button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="transactionReference">Transaction Reference</label>
                        <input type="text" id="transactionReference" class="form-control">
                    </div>

                    <div class="input-group">
                        <label for="repaymentNotes">Notes</label>
                        <textarea id="repaymentNotes" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="input-group-row">
                        <div class="input-group">
                            <label>
                                <input type="checkbox" id="sendSMSNotification"> Send SMS Notification
                            </label>
                        </div>
                        <div class="input-group">
                            <label>
                                <input type="checkbox" id="sendEmailNotification"> Send Email Notification
                            </label>
                        </div>
                    </div>

                    <div class="input-group" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Record Repayment
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="printRepaymentReceipt()" style="margin-left: 10px;">
                            <i class="fas fa-print"></i> Print Receipt
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SMS Templates Modal -->
    <div id="smsTemplatesModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>SMS Templates</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="sms-template">
                    <h4>Welcome Message</h4>
                    <div class="sms-template-content">
Dear {borrower_name}, welcome to TanzaniaLoanPro! Your loan of {loan_amount} has been approved. Thank you for choosing us.
                    </div>
                    <div class="sms-template-actions">
                        <button class="btn btn-primary" onclick="sendWelcomeSMS(currentBorrowerId)">
                            <i class="fas fa-paper-plane"></i> Send Now
                        </button>
                    </div>
                </div>

                <div class="sms-template">
                    <h4>Repayment Confirmation</h4>
                    <div class="sms-template-content">
Dear {borrower_name}, we have received your payment of {payment_amount}. Your remaining balance is {remaining_balance}. Thank you!
                    </div>
                    <div class="sms-template-actions">
                        <button class="btn btn-primary" onclick="sendRepaymentConfirmationSMS(currentBorrowerId)">
                            <i class="fas fa-paper-plane"></i> Send Now
                        </button>
                    </div>
                </div>

                <div class="sms-template">
                    <h4>Payment Reminder</h4>
                    <div class="sms-template-content">
Dear {borrower_name}, this is a reminder that your payment of {payment_amount} is due on {due_date}. Please make payment to avoid penalties.
                    </div>
                    <div class="sms-template-actions">
                        <button class="btn btn-primary" onclick="sendPaymentReminderSMS(currentBorrowerId)">
                            <i class="fas fa-paper-plane"></i> Send Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Payment Receipt</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body" id="receiptContent">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3>TanzaniaLoanPro</h3>
                    <p>Loan Management System</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <p><strong>Receipt No:</strong> <span id="receiptNumber">000001</span></p>
                    <p><strong>Date:</strong> <span id="receiptDate">Loading...</span></p>
                    <p><strong>Borrower:</strong> <span id="receiptBorrower">Loading...</span></p>
                    <p><strong>Amount:</strong> <span id="receiptAmount">Loading...</span></p>
                    <p><strong>Payment Method:</strong> <span id="receiptMethod">Loading...</span></p>
                    <p><strong>Reference:</strong> <span id="receiptReference">Loading...</span></p>
                    <p><strong>Received By:</strong> System User</p>
                </div>
                <div style="border-top: 1px dashed #ccc; padding-top: 10px; text-align: center;">
                    <p>Thank you for your payment</p>
                    <p>For inquiries: +255 123 456 789</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printReceipt()">
                    <i class="fas fa-print"></i> Print Receipt
                </button>
            </div>
        </div>
    </div>

    <!-- Statement Modal -->
    <div id="statementModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Borrower Statement</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body" id="statementContent">
                <div class="statement-header">
                    <h3>TanzaniaLoanPro</h3>
                    <p>Borrower Statement</p>
                </div>
                <div class="statement-details">
                    <div>
                        <p><strong>Borrower:</strong> <span id="statementBorrowerName"></span></p>
                        <p><strong>ID:</strong> <span id="statementBorrowerId"></span></p>
                    </div>
                    <div>
                        <p><strong>Statement Period:</strong> <span id="statementPeriod"></span></p>
                        <p><strong>Generated On:</strong> <span id="statementGeneratedDate"></span></p>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="statement-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Debit</th>
                                <th>Credit</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="statementTransactions">
                            <!-- Transactions will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div class="statement-summary">
                    <h4>Summary</h4>
                    <p><strong>Opening Balance:</strong> <span id="statementOpeningBalance"></span></p>
                    <p><strong>Total Debit:</strong> <span id="statementTotalDebit"></span></p>
                    <p><strong>Total Credit:</strong> <span id="statementTotalCredit"></span></p>
                    <p><strong>Closing Balance:</strong> <span id="statementClosingBalance"></span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printStatement()">
                    <i class="fas fa-print"></i> Print Statement
                </button>
            </div>
        </div>
    </div>

    <!-- Add Reminder Modal -->
    <div id="addReminderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Reminder</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="reminderForm">
                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="reminderBorrower">Borrower</label>
                            <select id="reminderBorrower" class="form-control" required>
                                <option value="">-- Select Borrower --</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="reminderType">Reminder Type</label>
                            <select id="reminderType" class="form-control" required>
                                <option value="Payment Due">Payment Due</option>
                                <option value="Overdue">Overdue</option>
                                <option value="Follow-up">Follow-up</option>
                                <option value="Renewal">Renewal</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="reminderDate">Date</label>
                            <input type="date" id="reminderDate" class="form-control" required>
                        </div>
                        <div class="input-group">
                            <label for="reminderTime">Time</label>
                            <input type="time" id="reminderTime" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="reminderMethod">Method</label>
                            <select id="reminderMethod" class="form-control" required>
                                <option value="SMS">SMS</option>
                                <option value="Email">Email</option>
                                <option value="Call">Phone Call</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="reminderAmount">Amount (if applicable)</label>
                            <input type="number" id="reminderAmount" class="form-control">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="reminderMessage">Message</label>
                        <textarea id="reminderMessage" class="form-control" rows="4" required></textarea>
                    </div>
                    
                    <div class="input-group" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Reminder
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New User</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="userName">Full Name</label>
                            <input type="text" id="userName" class="form-control" required>
                        </div>
                        <div class="input-group">
                            <label for="userEmail">Email</label>
                            <input type="email" id="userEmail" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="userRole">Role</label>
                            <select id="userRole" class="form-control" required>
                                <option value="">-- Select Role --</option>
                                <option value="Administrator">Administrator</option>
                                <option value="Manager">Manager</option>
                                <option value="Loan Officer">Loan Officer</option>
                                <option value="Read Only">Read Only</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="userStatus">Status</label>
                            <select id="userStatus" class="form-control" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="userRegions">Regions (comma separated)</label>
                            <input type="text" id="userRegions" class="form-control" placeholder="Dar es Salaam, Arusha, Mwanza">
                        </div>
                    </div>
                    
                    <div class="input-group-row">
                        <div class="input-group">
                            <label for="userPassword">Password</label>
                            <input type="password" id="userPassword" class="form-control" required>
                        </div>
                        <div class="input-group">
                            <label for="userConfirmPassword">Confirm Password</label>
                            <input type="password" id="userConfirmPassword" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="input-group" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Create User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
         // DOM Elements
    const logoutBtn = document.getElementById('logoutBtn');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const notification = document.getElementById('notification');
    const languageButtons = document.querySelectorAll('.language-btn');
    const currencyButtons = document.querySelectorAll('.currency-btn');
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.section');
    const borrowerTabs = document.querySelectorAll('.borrower-tab');
    const borrowerContents = document.querySelectorAll('.borrower-content');
    const fabMain = document.getElementById('fabMain');
    const fabMenu = document.getElementById('fabMenu');
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');

    // Current language and currency
    let currentLanguage = 'en';
    let currentCurrency = 'TZS';
    let currentBorrowerId = null;
    let currentUser = {
        id: 'user-1',
        name: 'Admin User',
        email: 'admin@tanzanialoanpro.com',
        role: 'Administrator',
        regions: ['All'],
        active: true
    };

    // Data storage
    let borrowers = JSON.parse(localStorage.getItem('borrowers')) || [];
    let repayments = JSON.parse(localStorage.getItem('repayments')) || [];
    let paymentSchedules = JSON.parse(localStorage.getItem('paymentSchedules')) || [];
    let reminders = JSON.parse(localStorage.getItem('reminders')) || [];
    let users = JSON.parse(localStorage.getItem('users')) || [
        {
            id: 'user-1',
            name: 'Admin User',
            email: 'admin@tanzanialoanpro.com',
            role: 'Administrator',
            regions: ['All'],
            active: true,
            lastLogin: new Date().toISOString()
        }
    ];

    // System settings
    let systemSettings = JSON.parse(localStorage.getItem('systemSettings')) || {
        systemName: 'TanzaniaLoanPro',
        defaultCurrency: 'TZS',
        defaultLanguage: 'en',
        timezone: 'Africa/Dar_es_Salaam',
        smsIntegration: 'africas_talking',
        emailIntegration: 'smtp',
        backupFrequency: 'weekly',
        backupLocation: 'cloud'
    };

        // Chart instances
    let loanPerformanceChart = null;
    let portfolioDistributionChart = null;
    let profitChart = null;
    let reportChart = null;

        // Translations for multilingual support
        const translations = {
            en: {
                dashboard: "Dashboard",
                allBorrowers: "All Borrowers",
                borrowerDetails: "Borrower Details",
                loanCalculator: "Loan Calculator",
                reports: "Reports",
                reminders: "Reminders",
                compliance: "Compliance",
                admin: "Admin",
                settings: "Settings",
                logout: "Logout",
                loanDisbursed: "Loan Disbursed",
                moneyReceived: "Money Received",
                loanPending: "Loan Pending",
                activeBorrowers: "Active Borrowers",
                overdueLoans: "Overdue Loans",
                pendingReminders: "Pending Reminders",
                totalProfit: "Total Profit",
                activeRegions: "Active Regions",
                recentRepayments: "Recent Repayments",
                loanPortfolio: "Loan Portfolio Overview",
                monthlyProfit: "Monthly Profit Overview",
                borrowerRegistration: "New Borrower Registration",
                personalInfo: "Personal Information",
                loanInfo: "Loan Information",
                dailyRepayments: "Daily Repayments",
                todaysRepayments: "Today's Repayments",
                userManagement: "User Management",
                systemSettings: "System Settings",
                complianceDashboard: "Compliance Dashboard",
                complianceChecklist: "Compliance Checklist",
                simpleInterestRate: "Simple Interest Rate (%)",
                remainBalance: "Remaining Balance",
                remove: "Remove",
                call: "Call",
                sendSMS: "Send SMS",
                edit: "Edit",
                delete: "Delete",
                view: "View"
            },
            sw: {
                dashboard: "Dashibodi",
                allBorrowers: "Wakopaji Wote",
                borrowerDetails: "Maelezo ya Mkopaji",
                loanCalculator: "Kikokotoo cha Mkopo",
                reports: "Ripoti",
                reminders: "Ukumbusho",
                compliance: "Uzingatiaji",
                admin: "Msimamizi",
                settings: "Mipangilio",
                logout: "Ondoka",
                loanDisbursed: "Mikopo Iliyotolewa",
                moneyReceived: "Pesa Zilizopokelewa",
                loanPending: "Mikopo Inayosubiri",
                activeBorrowers: "Wakopaji Wanaotumika",
                overdueLoans: "Mikopo Iliyochelewa",
                pendingReminders: "Ukumbusho Unaosubiri",
                totalProfit: "Faida Jumla",
                activeRegions: "Mikoa Inayotumika",
                recentRepayments: "Malipo ya Hivi Karibuni",
                loanPortfolio: "Muhtasari wa Mfuko wa Mikopo",
                monthlyProfit: "Muhtasari wa Faida Kila Mwezi",
                borrowerRegistration: "Usajili wa Mkopaji Mpya",
                personalInfo: "Taarifa ya Kibinafsi",
                loanInfo: "Taarifa ya Mkopo",
                dailyRepayments: "Malipo ya Kila Siku",
                todaysRepayments: "Malipo ya Leo",
                userManagement: "Usimamizi wa Watumiaji",
                systemSettings: "Mipangilio ya Mfumo",
                complianceDashboard: "Dashibodi ya Uzingatiaji",
                complianceChecklist: "Orodha ya Uzingatiaji",
                simpleInterestRate: "Kiwango cha Raha Rahisi (%)",
                remainBalance: "Salio Lilibaki",
                remove: "Ondoa",
                call: "Piga Simu",
                sendSMS: "Tuma SMS",
                edit: "Hariri",
                delete: "Futa",
                view: "Tazama"
            }
        };

        // Initialize the app
    function initApp() {
        // Load data from localStorage
        loadData();

        // Set today's date as default for date fields
        const today = new Date().toISOString().split('T')[0];
        if (document.getElementById('calcStartDate')) {
            document.getElementById('calcStartDate').value = today;
        }
        
        // Set system name
        if (document.getElementById('systemName')) {
            document.getElementById('systemName').value = systemSettings.systemName;
            document.getElementById('defaultCurrency').value = systemSettings.defaultCurrency;
            document.getElementById('defaultLanguage').value = systemSettings.defaultLanguage;
            document.getElementById('timezone').value = systemSettings.timezone;
            document.getElementById('smsIntegration').value = systemSettings.smsIntegration;
            document.getElementById('emailIntegration').value = systemSettings.emailIntegration;
            document.getElementById('backupFrequency').value = systemSettings.backupFrequency;
            document.getElementById('backupLocation').value = systemSettings.backupLocation;
        }

        // Add close functionality to modal close buttons
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });

        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        });

        // Event listeners
        if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
        if (darkModeToggle) darkModeToggle.addEventListener('click', toggleDarkMode);
        
        // Language toggle
        languageButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const lang = btn.dataset.lang;
                setLanguage(lang);
            });
        });
        
        // Currency toggle
        currencyButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const currency = btn.dataset.currency;
                setCurrency(currency);
            });
        });
        
        // Navigation
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const target = link.dataset.target;
                showSection(target);
            });
        });
        
        // Initialize forms
        initBorrowerForm();
        initRepaymentForm();
        initCalculatorForm();
        initUserManagement();
        initComplianceSection();

        // Floating action button
        if (fabMain) fabMain.addEventListener('click', toggleFabMenu);
        document.addEventListener('click', closeFabMenuOnOutsideClick);

        // Load dashboard data
        loadDashboardData();
        loadBorrowers();
        loadReminders();
        updateRoleCounts();

        // Check for saved dark mode preference
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            if (darkModeToggle) darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        }

        // Set user role badge
        if (document.getElementById('userRoleBadge')) {
            document.getElementById('userRoleBadge').textContent = currentUser.role;
            document.getElementById('userRoleBadge').className = `status-badge status-${currentUser.role.toLowerCase().replace(' ', '-')}`;
        }
        
        // Apply role-based UI restrictions
        applyRoleBasedUI();
    }

        // Toggle sidebar on mobile
        function toggleSidebar() {
            sidebar.classList.toggle('active');
        }

        // Apply role-based UI restrictions
        function applyRoleBasedUI() {
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            const managerOnlyElements = document.querySelectorAll('.manager-only');
            const loanOfficerElements = document.querySelectorAll('.loan-officer-only');
            
            // Show/hide elements based on user role
            if (currentUser.role !== 'Administrator') {
                adminOnlyElements.forEach(el => el.style.display = 'none');
            }
            
            if (!['Administrator', 'Manager'].includes(currentUser.role)) {
                managerOnlyElements.forEach(el => el.style.display = 'none');
            }
            
            if (!['Administrator', 'Manager', 'Loan Officer'].includes(currentUser.role)) {
                loanOfficerElements.forEach(el => el.style.display = 'none');
            }
        }

        // Update role counts in settings
        function updateRoleCounts() {
            const adminCount = users.filter(u => u.role === 'Administrator').length;
            const managerCount = users.filter(u => u.role === 'Manager').length;
            const officerCount = users.filter(u => u.role === 'Loan Officer').length;
            const readonlyCount = users.filter(u => u.role === 'Read Only').length;
            
            if (document.getElementById('adminCount')) {
                document.getElementById('adminCount').textContent = adminCount;
                document.getElementById('managerCount').textContent = managerCount;
                document.getElementById('officerCount').textContent = officerCount;
                document.getElementById('readonlyCount').textContent = readonlyCount;
            }
        }

        // Update interest rate label to "Simple Interest Rate"
        function updateInterestRateLabel() {
            const labels = document.querySelectorAll('label[for="interestRate"], label[for="calcInterestRate"]');
            labels.forEach(label => {
                label.textContent = translations[currentLanguage].simpleInterestRate;
            });
        }

        // Load data from localStorage
        function loadData() {
            // Check if this is the first run
            if (!localStorage.getItem('firstRun')) {
                // Create sample data
                createSampleData();
                localStorage.setItem('firstRun', 'true');
            }
        }

        // Create sample data for first-time users
        function createSampleData() {
            // Sample borrowers
            const sampleBorrowers = [
                {
                    id: 'borrower-1',
                    fullName: 'John Doe',
                    phoneNumber: '+255712345678',
                    idType: 'NIDA',
                    idNumber: '12345678901234567890',
                    region: 'Dar es Salaam',
                    district: 'Ilala',
                    ward: 'Kariakoo',
                    address: '123 Kariakoo Street',
                    email: 'john.doe@example.com',
                    businessInfo: 'Retail Shop',
                    loanPurpose: 'Business',
                    loanAmount: 5000000,
                    loanCurrency: 'TZS',
                    interestRate: 24,
                    totalAmount: 5600000,
                    loanTerm: 90,
                    startDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    paymentFrequency: 'daily',
                    collateralInfo: 'Land title deed',
                    guarantorName: 'Jane Smith',
                    guarantorPhone: '+255712345679',
                    kycVerified: true,
                    amlChecked: true,
                    termsAccepted: true,
                    boTCompliance: true,
                    isGroupLoan: false,
                    groupMembers: [],
                    status: 'active',
                    balance: 4200000,
                    createdAt: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
                    createdBy: 'user-1'
                },
                {
                    id: 'borrower-2',
                    fullName: 'Mary Johnson',
                    phoneNumber: '+255765432109',
                    idType: 'Passport',
                    idNumber: 'AB1234567',
                    region: 'Arusha',
                    district: 'Arusha City',
                    ward: 'Themi',
                    address: '456 Themi Road',
                    email: 'mary.j@example.com',
                    businessInfo: 'Poultry Farm',
                    loanPurpose: 'Agriculture',
                    loanAmount: 10000000,
                    loanCurrency: 'TZS',
                    interestRate: 18,
                    totalAmount: 10900000,
                    loanTerm: 180,
                    startDate: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    paymentFrequency: 'weekly',
                    collateralInfo: 'Farm equipment',
                    guarantorName: 'Robert Johnson',
                    guarantorPhone: '+255765432108',
                    kycVerified: true,
                    amlChecked: true,
                    termsAccepted: true,
                    boTCompliance: true,
                    isGroupLoan: false,
                    groupMembers: [],
                    status: 'active',
                    balance: 8000000,
                    createdAt: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000).toISOString(),
                    createdBy: 'user-1'
                }
            ];

            // Sample repayments
            const sampleRepayments = [
                {
                    id: 'repayment-1',
                    borrowerId: 'borrower-1',
                    amount: 200000,
                    currency: 'TZS',
                    date: new Date().toISOString().split('T')[0],
                    paymentMethod: 'mobile',
                    mobileProvider: 'M-Pesa',
                    transactionId: 'MP123456789',
                    confirmationCode: 'ABC123',
                    transactionReference: 'REF123',
                    notes: 'Partial payment',
                    sendSMS: true,
                    sendEmail: false,
                    recordedBy: 'user-1',
                    recordedAt: new Date().toISOString()
                },
                {
                    id: 'repayment-2',
                    borrowerId: 'borrower-1',
                    amount: 300000,
                    currency: 'TZS',
                    date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    paymentMethod: 'cash',
                    transactionReference: 'CASH001',
                    notes: 'Cash payment',
                    sendSMS: false,
                    sendEmail: false,
                    recordedBy: 'user-1',
                    recordedAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 'repayment-3',
                    borrowerId: 'borrower-2',
                    amount: 500000,
                    currency: 'TZS',
                    date: new Date().toISOString().split('T')[0],
                    paymentMethod: 'bank',
                    transactionReference: 'BANK123',
                    notes: 'Bank transfer',
                    sendSMS: true,
                    sendEmail: true,
                    recordedBy: 'user-1',
                    recordedAt: new Date().toISOString()
                }
            ];

            // Sample payment schedules
            const samplePaymentSchedules = [];
            
            // Generate schedule for borrower 1 (daily payments)
            const borrower1StartDate = new Date(sampleBorrowers[0].startDate);
            for (let i = 1; i <= 90; i++) {
                const dueDate = new Date(borrower1StartDate);
                dueDate.setDate(borrower1StartDate.getDate() + i);
                
                let status = 'pending';
                let amountPaid = 0;
                let paymentDate = null;
                
                // Mark some payments as paid
                if (i <= 7) {
                    status = 'paid';
                    amountPaid = 62222; // 5,600,000 / 90  62,222
                    paymentDate = new Date(dueDate).toISOString();
                }
                
                samplePaymentSchedules.push({
                    id: `schedule-1-${i}`,
                    borrowerId: 'borrower-1',
                    dueDate: dueDate.toISOString(),
                    amountDue: 62222,
                    status: status,
                    paymentDate: paymentDate,
                    amountPaid: amountPaid,
                    createdAt: sampleBorrowers[0].createdAt
                });
            }
            
            // Generate schedule for borrower 2 (weekly payments)
            const borrower2StartDate = new Date(sampleBorrowers[1].startDate);
            for (let i = 1; i <= 26; i++) { // ~6 months = 26 weeks
                const dueDate = new Date(borrower2StartDate);
                dueDate.setDate(borrower2StartDate.getDate() + (i * 7));
                
                let status = 'pending';
                let amountPaid = 0;
                let paymentDate = null;
                
                // Mark some payments as paid
                if (i <= 4) {
                    status = 'paid';
                    amountPaid = 419231; // 10,900,000 / 26  419,231
                    paymentDate = new Date(dueDate).toISOString();
                }
                
                samplePaymentSchedules.push({
                    id: `schedule-2-${i}`,
                    borrowerId: 'borrower-2',
                    dueDate: dueDate.toISOString(),
                    amountDue: 419231,
                    status: status,
                    paymentDate: paymentDate,
                    amountPaid: amountPaid,
                    createdAt: sampleBorrowers[1].createdAt
                });
            }

            // Sample reminders
            const sampleReminders = [
                {
                    id: 'reminder-1',
                    borrowerId: 'borrower-1',
                    type: 'Payment Due',
                    date: new Date().toISOString().split('T')[0],
                    time: '10:00',
                    method: 'SMS',
                    message: 'Dear John, your loan payment of TZS 62,222 is due today. Please make payment to avoid penalties.',
                    status: 'pending',
                    createdBy: 'user-1',
                    createdAt: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 'reminder-2',
                    borrowerId: 'borrower-2',
                    type: 'Payment Due',
                    date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    time: '10:00',
                    method: 'Email',
                    message: 'Dear Mary, your weekly loan payment of TZS 419,231 is due next week. Please prepare accordingly.',
                    status: 'pending',
                    createdBy: 'user-1',
                    createdAt: new Date().toISOString()
                }
            ];

            // Save sample data to localStorage
            borrowers = sampleBorrowers;
            repayments = sampleRepayments;
            paymentSchedules = samplePaymentSchedules;
            reminders = sampleReminders;

            saveData();
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('borrowers', JSON.stringify(borrowers));
            localStorage.setItem('repayments', JSON.stringify(repayments));
            localStorage.setItem('paymentSchedules', JSON.stringify(paymentSchedules));
            localStorage.setItem('reminders', JSON.stringify(reminders));
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
        }

        // Handle logout
        function handleLogout() {
            showNotification('Logged out successfully', 'success');
            // In a real app, this would redirect to login page
            // window.location.href = 'login.html';
        }

        // Set language
        function setLanguage(lang) {
            currentLanguage = lang;
            
            // Update UI
            languageButtons.forEach(btn => {
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            document.getElementById('appTitle').textContent = 'TanzaniaLoanPro';
            
            // Update navigation texts
            document.querySelectorAll('.nav-text').forEach(el => {
                const target = el.closest('.nav-link').dataset.target;
                if (translations[lang][target]) {
                    el.textContent = translations[lang][target];
                }
            });
            
            // Update section titles
            document.querySelectorAll('.card-header h3, .card-header h4').forEach(el => {
                const text = el.textContent.trim();
                for (const key in translations[lang]) {
                    if (translations.en[key] === text) {
                        el.textContent = translations[lang][key];
                        break;
                    }
                }
            });
            
            // Update form labels
            document.querySelectorAll('.input-group label').forEach(el => {
                const text = el.textContent.trim();
                for (const key in translations[lang]) {
                    if (translations.en[key] === text) {
                        el.textContent = translations[lang][key];
                        break;
                    }
                }
            });
            
            // Update button texts
            document.querySelectorAll('.btn:not(.language-btn):not(.currency-btn)').forEach(el => {
                const text = el.textContent.trim();
                for (const key in translations[lang]) {
                    if (translations.en[key] === text) {
                        el.textContent = translations[lang][key];
                        break;
                    }
                }
            });
        }

        // Set currency
        function setCurrency(currency) {
            currentCurrency = currency;
            
            // Update UI
            currencyButtons.forEach(btn => {
                if (btn.dataset.currency === currency) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Update all currency displays in the app
            updateCurrencyDisplays();
        }

        // Show section
        function showSection(sectionId) {
            sections.forEach(section => {
                if (section.id === sectionId) {
                    section.classList.add('active');
                    
                    // Update header title
                    const navLink = document.querySelector(`.nav-link[data-target="${sectionId}"]`);
                    if (navLink) {
                        const navText = navLink.querySelector('.nav-text').textContent;
                        document.querySelector('.header-title h1').textContent = navText;
                        
                        // Special case for borrower details view
                        if (sectionId === 'borrower-details') {
                            document.querySelector('.header-title h1').textContent = translations[currentLanguage].borrowerDetails;
                        }
                    }
                } else {
                    section.classList.remove('active');
                }
            });
            
            navLinks.forEach(link => {
                if (link.dataset.target === sectionId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
            
            // Close sidebar on mobile after selection
            if (window.innerWidth <= 992) {
                sidebar.classList.remove('active');
            }
            
            // Load section-specific data
            switch(sectionId) {
                case 'home':
                    loadDashboardData();
                    break;
                case 'all-borrowers':
                    loadBorrowers();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'reminders':
                    loadReminders();
                    break;
                case 'compliance':
                    loadComplianceData();
                    break;
                case 'admin-features':
                    loadUsers();
                    break;
                case 'settings':
                    updateRoleCounts();
                    break;
            }
        }

        // Show borrower tab
        function showBorrowerTab(tabId) {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            tabContents.forEach(content => {
                if (content.id === `${tabId}Tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // Load tab-specific data
            if (tabId === 'payments' && currentBorrowerId) {
                loadBorrowerPayments(currentBorrowerId);
            }
        }

        // Show notification
        function showNotification(message, type) {
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                                  type === 'error' ? 'fa-exclamation-circle' : 
                                  type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                    <button class="close-notification"><i class="fas fa-times"></i></button>
                </div>
            `;
            notification.className = `notification ${type}`;
            notification.style.display = 'flex';
            
            // Auto-hide after duration
            const timeout = setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
            
            // Close button
            notification.querySelector('.close-notification').addEventListener('click', () => {
                clearTimeout(timeout);
                notification.style.display = 'none';
            });
        }

        // Toggle dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            
            if (document.body.classList.contains('dark-mode')) {
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                localStorage.setItem('darkMode', 'enabled');
            } else {
                darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        // Toggle floating action button menu
        function toggleFabMenu() {
            fabMenu.classList.toggle('active');
        }

        // Close FAB menu when clicking outside
        function closeFabMenuOnOutsideClick(e) {
            if (!fabMain.contains(e.target) && !fabMenu.contains(e.target)) {
                fabMenu.classList.remove('active');
            }
        }

        // Show new borrower modal
        function showNewBorrowerModal() {
            // Check user permissions
            if (!['Administrator', 'Manager', 'Loan Officer'].includes(currentUser.role)) {
                showNotification('You do not have permission to add borrowers', 'error');
                return;
            }
            
            // Reset form and show modal
            document.getElementById('borrowerForm').reset();
            document.getElementById('photoPlaceholder').style.backgroundImage = '';
            document.getElementById('photoPlaceholder').innerHTML = '<i class="fas fa-user"></i>';
            document.getElementById('groupMembersList').innerHTML = '';
            document.getElementById('groupMembersContainer').style.display = 'none';
            
            // Set today's date
            document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
            
            // Remove ID upload container if exists
            const idUploadContainer = document.getElementById('idUploadContainer');
            if (idUploadContainer) {
                idUploadContainer.remove();
            }
            
            // Show the modal
            document.getElementById('newBorrowerModal').style.display = 'flex';
            fabMenu.classList.remove('active');
        }

        // Show record payment modal
        function showRecordPaymentModal() {
            // Check user permissions
            if (!['Administrator', 'Manager', 'Loan Officer'].includes(currentUser.role)) {
                showNotification('You do not have permission to record payments', 'error');
                return;
            }
            
            document.getElementById('repaymentForm').reset();
            document.getElementById('repaymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('mobileMoneyOptions').style.display = 'none';
            
            // Update borrower dropdown
            updateBorrowerDropdown();
            
            document.getElementById('recordPaymentModal').style.display = 'flex';
            fabMenu.classList.remove('active');
        }

        // Initialize borrower form
        function initBorrowerForm() {
            const borrowerForm = document.getElementById('borrowerForm');
            if (!borrowerForm) return;
            
            const loanPurposeOptions = document.querySelectorAll('.loan-purpose-option');
            const idTypeOptions = document.querySelectorAll('.id-type-option');
            const photoUpload = document.getElementById('photoUpload');
            const photoPlaceholder = document.getElementById('photoPlaceholder');
            const isGroupLoan = document.getElementById('isGroupLoan');
            const groupMembersContainer = document.getElementById('groupMembersContainer');
            const addGroupMemberBtn = document.getElementById('addGroupMemberBtn');
            const loanAmount = document.getElementById('loanAmount');
            const interestRate = document.getElementById('interestRate');
            const totalAmount = document.getElementById('totalAmount');
            const loanTerm = document.getElementById('loanTerm');
            
            // Set loan purpose
            loanPurposeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    loanPurposeOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    document.getElementById('loanPurpose').value = option.dataset.purpose;
                });
            });
            
            // Set ID type with document upload button
            idTypeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    idTypeOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    document.getElementById('idType').value = option.dataset.type;
                    
                    // Show document upload button for ID type
                    const idUploadContainer = document.getElementById('idUploadContainer');
                    if (!idUploadContainer) {
                        const idTypeContainer = option.closest('.input-group');
                        const uploadHtml = `
                            <div class="input-group" id="idUploadContainer" style="margin-top: 10px;">
                                <label>Upload ${option.dataset.type} Document</label>
                                <input type="file" id="idDocumentUpload" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                            </div>
                        `;
                        idTypeContainer.insertAdjacentHTML('afterend', uploadHtml);
                    } else {
                        idUploadContainer.querySelector('label').textContent = `Upload ${option.dataset.type} Document`;
                    }
                });
            });
            
            // Handle photo upload
            if (photoUpload) {
                photoUpload.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            photoPlaceholder.style.backgroundImage = `url(${event.target.result})`;
                            photoPlaceholder.innerHTML = '';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // Toggle group members
            if (isGroupLoan) {
                isGroupLoan.addEventListener('change', () => {
                    groupMembersContainer.style.display = isGroupLoan.checked ? 'block' : 'none';
                });
            }
            
            // Add group member
            if (addGroupMemberBtn) {
                addGroupMemberBtn.addEventListener('click', () => {
                    const memberId = `member-${Date.now()}`;
                    const memberHtml = `
                        <div class="group-member" id="${memberId}" style="margin-bottom: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 4px;">
                            <div class="input-group-row">
                                <div class="input-group">
                                    <label>${translations[currentLanguage].personalInfo}</label>
                                    <input type="text" class="form-control" required>
                                </div>
                                <div class="input-group">
                                    <label>${translations[currentLanguage].phoneNumber}</label>
                                    <input type="tel" class="form-control" placeholder="+255" required>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>${translations[currentLanguage].idNumber}</label>
                                <input type="text" class="form-control" required>
                            </div>
                            <button type="button" class="btn btn-danger btn-sm" onclick="document.getElementById('${memberId}').remove()" style="margin-top: 10px;">
                                <i class="fas fa-times"></i> ${translations[currentLanguage].remove}
                            </button>
                        </div>
                    `;
                    document.getElementById('groupMembersList').insertAdjacentHTML('beforeend', memberHtml);
                });
            }
            
            // Calculate total amount using simple interest
            const calculateTotal = () => {
                const amount = parseFloat(loanAmount.value) || 0;
                const rate = parseFloat(interestRate.value) || 0;
                
                // Simple interest calculation: Total = Principal + (Principal * Rate)
                const total = amount + (amount * (rate / 100));
                
                totalAmount.value = total.toFixed(2);
            };
            
            if (loanAmount && interestRate) {
                loanAmount.addEventListener('input', calculateTotal);
                interestRate.addEventListener('input', calculateTotal);
            }
            
            // Handle form submission
            borrowerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                if (!validateBorrowerForm()) {
                    return;
                }
                
                // Create new borrower
                const borrowerData = {
                    id: `borrower-${Date.now()}`,
                    fullName: document.getElementById('fullName').value,
                    phoneNumber: document.getElementById('phoneNumber').value,
                    idType: document.getElementById('idType').value,
                    idNumber: document.getElementById('idNumber').value,
                    region: document.getElementById('region').value,
                    district: document.getElementById('district').value,
                    ward: document.getElementById('ward').value,
                    address: document.getElementById('address').value,
                    email: document.getElementById('email').value || null,
                    businessInfo: document.getElementById('businessInfo').value || null,
                    loanPurpose: document.getElementById('loanPurpose').value,
                    loanAmount: parseFloat(loanAmount.value),
                    loanCurrency: document.getElementById('loanCurrency').value,
                    interestRate: parseFloat(interestRate.value),
                    totalAmount: parseFloat(totalAmount.value),
                    loanTerm: parseInt(loanTerm.value),
                    startDate: document.getElementById('startDate').value,
                    paymentFrequency: document.getElementById('paymentFrequency').value,
                    collateralInfo: document.getElementById('collateralInfo').value || null,
                    guarantorName: document.getElementById('guarantorName').value || null,
                    guarantorPhone: document.getElementById('guarantorPhone').value || null,
                    kycVerified: document.getElementById('kycVerified').checked,
                    amlChecked: document.getElementById('amlChecked').checked,
                    termsAccepted: document.getElementById('termsAccepted').checked,
                    boTCompliance: document.getElementById('boTCompliance').checked,
                    isGroupLoan: isGroupLoan ? isGroupLoan.checked : false,
                    groupMembers: [],
                    status: 'active',
                    balance: parseFloat(totalAmount.value),
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.id
                };
                
                // Add group members if it's a group loan
                if (borrowerData.isGroupLoan) {
                    const members = document.querySelectorAll('.group-member');
                    members.forEach(member => {
                        const inputs = member.querySelectorAll('input');
                        borrowerData.groupMembers.push({
                            name: inputs[0].value,
                            phone: inputs[1].value,
                            idNumber: inputs[2].value
                        });
                    });
                }

                // Add borrower to the array
                borrowers.push(borrowerData);
                
                // Generate payment schedule
                generatePaymentSchedule(borrowerData);
                
                // Save data
                saveData();
                
                // Show success message
                showNotification('Borrower registered successfully!', 'success');
                
                // Reset form
                borrowerForm.reset();
                if (photoPlaceholder) {
                    photoPlaceholder.style.backgroundImage = '';
                    photoPlaceholder.innerHTML = '<i class="fas fa-user"></i>';
                }
                if (document.getElementById('groupMembersList')) {
                    document.getElementById('groupMembersList').innerHTML = '';
                }
                if (groupMembersContainer) {
                    groupMembersContainer.style.display = 'none';
                }
                
                // Remove ID upload container if exists
                const idUploadContainer = document.getElementById('idUploadContainer');
                if (idUploadContainer) {
                    idUploadContainer.remove();
                }
                
                // Close modal
                document.getElementById('newBorrowerModal').style.display = 'none';
                
                // Update dashboard and borrowers list
                loadDashboardData();
                loadBorrowers();
            });
        }

        // Validate borrower form
        function validateBorrowerForm() {
            const requiredFields = [
                'fullName', 'phoneNumber', 'idNumber', 'region', 
                'district', 'ward', 'address', 'loanAmount',
                'interestRate', 'loanTerm', 'startDate'
            ];
            
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && !field.value.trim()) {
                    field.style.borderColor = 'var(--danger-color)';
                    isValid = false;
                } else if (field) {
                    field.style.borderColor = 'var(--border-color)';
                }
            });
            
            // Validate phone number format
            const phoneNumber = document.getElementById('phoneNumber');
            if (phoneNumber && !/^\+?\d{9,15}$/.test(phoneNumber.value)) {
                phoneNumber.style.borderColor = 'var(--danger-color)';
                showNotification('Please enter a valid phone number', 'error');
                isValid = false;
            }
            
            // Validate loan amount is positive
            const loanAmount = document.getElementById('loanAmount');
            if (loanAmount) {
                const amount = parseFloat(loanAmount.value);
                if (isNaN(amount) || amount <= 0) {
                    loanAmount.style.borderColor = 'var(--danger-color)';
                    showNotification('Loan amount must be a positive number', 'error');
                    isValid = false;
                }
            }
            
            // Validate interest rate is between 0 and 100
            const interestRate = document.getElementById('interestRate');
            if (interestRate) {
                const rate = parseFloat(interestRate.value);
                if (isNaN(rate) || rate < 0 || rate > 100) {
                    interestRate.style.borderColor = 'var(--danger-color)';
                    showNotification('Interest rate must be between 0 and 100', 'error');
                    isValid = false;
                }
            }
            
            // Validate loan term is positive
            const loanTerm = document.getElementById('loanTerm');
            if (loanTerm) {
                const term = parseInt(loanTerm.value);
                if (isNaN(term) || term <= 0) {
                    loanTerm.style.borderColor = 'var(--danger-color)';
                    showNotification('Loan term must be a positive number', 'error');
                    isValid = false;
                }
            }
            
            // Validate terms accepted
            const termsAccepted = document.getElementById('termsAccepted');
            if (termsAccepted && !termsAccepted.checked) {
                showNotification('You must accept the terms and conditions', 'error');
                isValid = false;
            }
            
            return isValid;
        }

        // Generate payment schedule for a borrower
        function generatePaymentSchedule(borrower) {
            const schedule = [];
            const startDate = new Date(borrower.startDate);
            const totalPayments = calculateNumberOfPayments(borrower);
            const paymentAmount = borrower.totalAmount / totalPayments;
            
            for (let i = 1; i <= totalPayments; i++) {
                const dueDate = new Date(startDate);
                
                // Calculate due date based on payment frequency
                switch(borrower.paymentFrequency) {
                    case 'daily':
                        dueDate.setDate(startDate.getDate() + i);
                        break;
                    case 'weekly':
                        dueDate.setDate(startDate.getDate() + (i * 7));
                        break;
                    case 'monthly':
                        dueDate.setMonth(startDate.getMonth() + i);
                        break;
                    case 'bullet':
                        dueDate.setDate(startDate.getDate() + borrower.loanTerm);
                        break;
                }
                
                schedule.push({
                    id: `schedule-${borrower.id}-${i}`,
                    borrowerId: borrower.id,
                    dueDate: dueDate.toISOString(),
                    amountDue: paymentAmount,
                    status: 'pending',
                    paymentDate: null,
                    amountPaid: 0,
                    createdAt: new Date().toISOString()
                });
            }
            
            // Add to payment schedules
            paymentSchedules = paymentSchedules.concat(schedule);
            saveData();
        }

        // Calculate number of payments based on term and frequency
        function calculateNumberOfPayments(borrower) {
            switch(borrower.paymentFrequency) {
                case 'daily':
                    return borrower.loanTerm;
                case 'weekly':
                    return Math.ceil(borrower.loanTerm / 7);
                case 'monthly':
                    return Math.ceil(borrower.loanTerm / 30);
                case 'bullet':
                    return 1;
                default:
                    return borrower.loanTerm;
            }
        }

        // Initialize repayment form
        function initRepaymentForm() {
            const repaymentForm = document.getElementById('repaymentForm');
            if (!repaymentForm) return;
            
            const paymentMethod = document.getElementById('paymentMethod');
            const mobileMoneyOptions = document.getElementById('mobileMoneyOptions');
            const mobileMoneyProviders = document.querySelectorAll('.mobile-money-provider');
            
            // Toggle mobile money options
            if (paymentMethod) {
                paymentMethod.addEventListener('change', () => {
                    if (paymentMethod.value === 'mobile') {
                        mobileMoneyOptions.style.display = 'block';
                    } else {
                        mobileMoneyOptions.style.display = 'none';
                    }
                });
            }
            
            // Set mobile money provider
            if (mobileMoneyProviders) {
                mobileMoneyProviders.forEach(provider => {
                    provider.addEventListener('click', () => {
                        mobileMoneyProviders.forEach(p => p.classList.remove('selected'));
                        provider.classList.add('selected');
                        document.getElementById('mobileMoneyProvider').value = provider.dataset.provider;
                    });
                });
            }
            
            // Handle form submission
            repaymentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                if (!validateRepaymentForm()) {
                    return;
                }
                
                // Create new repayment
                const repaymentData = {
                    id: `repayment-${Date.now()}`,
                    borrowerId: document.getElementById('borrowerSelect').value,
                    amount: parseFloat(document.getElementById('repaymentAmount').value),
                    currency: document.getElementById('repaymentCurrency').value,
                    date: document.getElementById('repaymentDate').value,
                    paymentMethod: paymentMethod.value,
                    mobileProvider: paymentMethod.value === 'mobile' ? document.getElementById('mobileMoneyProvider').value : null,
                    transactionId: paymentMethod.value === 'mobile' ? document.getElementById('mobileTransactionId').value : null,
                    confirmationCode: paymentMethod.value === 'mobile' ? document.getElementById('mobileConfirmationCode').value : null,
                    transactionReference: document.getElementById('transactionReference').value || null,
                    notes: document.getElementById('repaymentNotes').value || null,
                    sendSMS: document.getElementById('sendSMSNotification').checked,
                    sendEmail: document.getElementById('sendEmailNotification').checked,
                    recordedBy: currentUser.id,
                    recordedAt: new Date().toISOString()
                };
                
                // Add repayment to the array
                repayments.push(repaymentData);
                
                // Update borrower balance
                updateBorrowerBalance(repaymentData.borrowerId, repaymentData.amount);
                
                // Update payment schedule
                updatePaymentSchedule(repaymentData.borrowerId, repaymentData.amount, repaymentData.date);
                
                // Save data
                saveData();
                
                // Show success message
                showNotification('Repayment recorded successfully!', 'success');
                
                // Reset form
                repaymentForm.reset();
                if (mobileMoneyOptions) {
                    mobileMoneyOptions.style.display = 'none';
                }
                
                // Close modal
                document.getElementById('recordPaymentModal').style.display = 'none';
                
                // Update dashboard and borrowers list
                loadDashboardData();
                loadBorrowers();
                
                // Show receipt
                showRepaymentReceipt(repaymentData);
            });
        }

        // Validate repayment form
        function validateRepaymentForm() {
            const requiredFields = ['borrowerSelect', 'repaymentAmount', 'repaymentDate'];
            
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && !field.value.trim()) {
                    field.style.borderColor = 'var(--danger-color)';
                    isValid = false;
                } else if (field) {
                    field.style.borderColor = 'var(--border-color)';
                }
            });
            
            // Validate amount is positive
            const repaymentAmount = document.getElementById('repaymentAmount');
            if (repaymentAmount) {
                const amount = parseFloat(repaymentAmount.value);
                if (isNaN(amount) || amount <= 0) {
                    repaymentAmount.style.borderColor = 'var(--danger-color)';
                    showNotification('Amount must be a positive number', 'error');
                    isValid = false;
                }
            }
            
            // For mobile payments, validate transaction ID
            const paymentMethod = document.getElementById('paymentMethod');
            if (paymentMethod && paymentMethod.value === 'mobile') {
                const transactionId = document.getElementById('mobileTransactionId');
                if (transactionId && !transactionId.value.trim()) {
                    transactionId.style.borderColor = 'var(--danger-color)';
                    showNotification('Transaction ID is required for mobile payments', 'error');
                    isValid = false;
                }
            }
            
            return isValid;
        }

        // Update borrower balance
        function updateBorrowerBalance(borrowerId, amount) {
            const borrower = borrowers.find(b => b.id === borrowerId);
            if (borrower) {
                borrower.balance -= amount;
                
                // Update status if balance is zero
                if (borrower.balance <= 0) {
                    borrower.status = 'completed';
                    borrower.balance = 0;
                }
                
                saveData();
            }
        }

        // Update payment schedule
        function updatePaymentSchedule(borrowerId, amount, paymentDate) {
            // Find pending payments for this borrower
            const pendingPayments = paymentSchedules.filter(
                ps => ps.borrowerId === borrowerId && ps.status === 'pending'
            );
            
            if (pendingPayments.length === 0) return;
            
            // Sort by due date (oldest first)
            pendingPayments.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            // Apply payment to oldest pending payment
            let remainingAmount = amount;
            for (const payment of pendingPayments) {
                if (remainingAmount <= 0) break;
                
                const amountDue = payment.amountDue - payment.amountPaid;
                const paymentAmount = Math.min(amountDue, remainingAmount);
                
                payment.amountPaid += paymentAmount;
                remainingAmount -= paymentAmount;
                
                if (payment.amountPaid >= payment.amountDue) {
                    payment.status = 'paid';
                    payment.paymentDate = paymentDate;
                }
            }
            
            saveData();
        }

        // Initialize calculator form
        function initCalculatorForm() {
            const calculatorForm = document.getElementById('calculatorForm');
            if (!calculatorForm) return;
            
            const loanAmount = document.getElementById('calcLoanAmount');
            const interestRate = document.getElementById('calcInterestRate');
            const totalAmount = document.getElementById('calcTotalAmount');
            const perPayment = document.getElementById('calcPerPayment');
            const numPayments = document.getElementById('calcNumPayments');
            const effectiveRate = document.getElementById('calcEffectiveRate');
            
            // Calculate total amount using simple interest
            const calculateTotal = () => {
                const amount = parseFloat(loanAmount.value) || 0;
                const rate = parseFloat(interestRate.value) || 0;
                
                // Simple interest calculation: Total = Principal + (Principal * Rate)
                const total = amount + (amount * (rate / 100));
                
                if (totalAmount) totalAmount.textContent = formatCurrency(total, currentCurrency);
                
                // Calculate per payment amount
                const term = parseInt(document.getElementById('calcTerm').value) || 0;
                const termUnit = document.getElementById('calcTermUnit').value;
                const frequency = document.getElementById('calcPaymentFrequency').value;
                
                let payments = 1;
                
                if (frequency === 'daily') {
                    payments = term;
                } else if (frequency === 'weekly') {
                    payments = Math.ceil(term / 7);
                } else if (frequency === 'monthly') {
                    payments = Math.ceil(term / 30);
                }
                
                if (numPayments) numPayments.textContent = payments;
                if (perPayment) perPayment.textContent = formatCurrency(total / payments, currentCurrency);
                
                // Effective rate is same as simple rate in this calculation
                if (effectiveRate) effectiveRate.textContent = `${rate.toFixed(2)}%`;
                
                // Generate schedule
                generateCalculatorSchedule(amount, total, payments, frequency, document.getElementById('calcStartDate').value);
            };
            
            // Add event listeners
            if (loanAmount) loanAmount.addEventListener('input', calculateTotal);
            if (interestRate) interestRate.addEventListener('input', calculateTotal);
            
            const calcTerm = document.getElementById('calcTerm');
            const calcTermUnit = document.getElementById('calcTermUnit');
            const calcPaymentFrequency = document.getElementById('calcPaymentFrequency');
            const calcStartDate = document.getElementById('calcStartDate');
            
            if (calcTerm) calcTerm.addEventListener('input', calculateTotal);
            if (calcTermUnit) calcTermUnit.addEventListener('change', calculateTotal);
            if (calcPaymentFrequency) calcPaymentFrequency.addEventListener('change', calculateTotal);
            if (calcStartDate) calcStartDate.addEventListener('change', calculateTotal);
            
            // Calculate button
            const calculateLoanBtn = document.getElementById('calculateLoanBtn');
            if (calculateLoanBtn) {
                calculateLoanBtn.addEventListener('click', calculateTotal);
            }
            
            // Initial calculation
            calculateTotal();
        }

        // Generate calculator schedule
        function generateCalculatorSchedule(principal, total, payments, frequency, startDate) {
            const scheduleBody = document.getElementById('calcSchedule');
            if (!scheduleBody) return;
            
            scheduleBody.innerHTML = '';
            
            if (payments <= 0) {
                scheduleBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Invalid payment schedule</td></tr>';
                return;
            }
            
            const paymentAmount = total / payments;
            const start = new Date(startDate);
            
            for (let i = 1; i <= payments; i++) {
                const dueDate = new Date(start);
                
                // Calculate due date based on frequency
                switch(frequency) {
                    case 'daily':
                        dueDate.setDate(start.getDate() + i);
                        break;
                    case 'weekly':
                        dueDate.setDate(start.getDate() + (i * 7));
                        break;
                    case 'monthly':
                        dueDate.setMonth(start.getMonth() + i);
                        break;
                    case 'bullet':
                        // For bullet payment, use the last payment date
                        if (i === payments) {
                            dueDate.setDate(start.getDate() + parseInt(document.getElementById('calcTerm').value));
                        }
                        break;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i}</td>
                    <td>${dueDate.toLocaleDateString()}</td>
                    <td>${formatCurrency(principal / payments, currentCurrency)}</td>
                    <td>${formatCurrency((total - principal) / payments, currentCurrency)}</td>
                    <td>${formatCurrency(0, currentCurrency)}</td>
                    <td>${formatCurrency(paymentAmount, currentCurrency)}</td>
                    <td>${formatCurrency(total - (paymentAmount * i), currentCurrency)}</td>
                `;
                scheduleBody.appendChild(row);
            }
        }

        // Initialize user management
        function initUserManagement() {
            const addUserBtn = document.getElementById('addUserBtn');
            if (!addUserBtn) return;
            
            addUserBtn.addEventListener('click', () => {
                // Check user permissions
                if (currentUser.role !== 'Administrator') {
                    showNotification('You do not have permission to add users', 'error');
                    return;
                }
                
                showAddUserModal();
            });
        }

        // Show add user modal
        function showAddUserModal() {
            document.getElementById('userForm').reset();
            document.getElementById('addUserModal').style.display = 'flex';
        }

        // Initialize compliance section
        function initComplianceSection() {
            const kycVerifyBtn = document.getElementById('kycVerifyBtn');
            const amlCheckBtn = document.getElementById('amlCheckBtn');
            const uploadDocBtn = document.getElementById('uploadDocBtn');
            const botComplianceBtn = document.getElementById('botComplianceBtn');
            
            if (kycVerifyBtn) {
                kycVerifyBtn.addEventListener('click', () => {
                    if (currentBorrowerId) {
                        verifyKYC(currentBorrowerId);
                    } else {
                        showNotification('Please select a borrower first', 'warning');
                    }
                });
            }
            
            if (amlCheckBtn) {
                amlCheckBtn.addEventListener('click', () => {
                    if (currentBorrowerId) {
                        checkAML(currentBorrowerId);
                    } else {
                        showNotification('Please select a borrower first', 'warning');
                    }
                });
            }
            
            if (uploadDocBtn) {
                uploadDocBtn.addEventListener('click', () => {
                    uploadComplianceDocument();
                });
            }
            
            if (botComplianceBtn) {
                botComplianceBtn.addEventListener('click', () => {
                    if (currentBorrowerId) {
                        checkBoTCompliance(currentBorrowerId);
                    } else {
                        showNotification('Please select a borrower first', 'warning');
                    }
                });
            }
        }

        // Verify KYC
        function verifyKYC(borrowerId) {
            const borrower = borrowers.find(b => b.id === borrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            borrower.kycVerified = true;
            saveData();
            
            const kycStatus = document.getElementById('kycStatus');
            if (kycStatus) {
                kycStatus.textContent = 'Verified';
                kycStatus.style.color = 'var(--success-color)';
            }
            
            showNotification('KYC verification completed successfully', 'success');
        }

        // Check AML
        function checkAML(borrowerId) {
            const borrower = borrowers.find(b => b.id === borrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            borrower.amlChecked = true;
            saveData();
            
            const amlStatus = document.getElementById('amlStatus');
            if (amlStatus) {
                amlStatus.textContent = 'Checked';
                amlStatus.style.color = 'var(--success-color)';
            }
            
            showNotification('AML check completed successfully', 'success');
        }

        // Check BoT compliance
        function checkBoTCompliance(borrowerId) {
            const borrower = borrowers.find(b => b.id === borrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            borrower.boTCompliance = true;
            saveData();
            
            const botStatus = document.getElementById('botStatus');
            if (botStatus) {
                botStatus.textContent = 'Compliant';
                botStatus.style.color = 'var(--success-color)';
            }
            
            showNotification('BoT compliance check completed successfully', 'success');
        }

        // Upload compliance document
        function uploadComplianceDocument() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf,.jpg,.jpeg,.png,.doc,.docx';
            
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const documentData = {
                            id: `doc-${Date.now()}`,
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            uploadDate: new Date().toISOString(),
                            content: event.target.result
                        };
                        
                        // Save document to localStorage
                        let documents = JSON.parse(localStorage.getItem('complianceDocuments')) || [];
                        documents.push(documentData);
                        localStorage.setItem('complianceDocuments', JSON.stringify(documents));
                        
                        // Update documents list
                        loadComplianceDocuments();
                        
                        showNotification('Document uploaded successfully', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            fileInput.click();
        }

        // Load compliance documents
        function loadComplianceDocuments() {
            const documentsList = document.getElementById('documentsList');
            if (!documentsList) return;
            
            documentsList.innerHTML = '';
            
            const documents = JSON.parse(localStorage.getItem('complianceDocuments')) || [];
            
            if (documents.length === 0) {
                documentsList.innerHTML = '<tr><td colspan="3">No documents found</td></tr>';
                return;
            }
            
            documents.forEach(doc => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${doc.name}</td>
                    <td>${new Date(doc.uploadDate).toLocaleDateString()}</td>
                    <td>
                        <button class="action-button view-button" onclick="viewDocument('${doc.id}')" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-button download-button" onclick="downloadDocument('${doc.id}')" title="Download">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="action-button delete-button" onclick="deleteDocument('${doc.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                documentsList.appendChild(row);
            });
        }

        // View document
        function viewDocument(documentId) {
            const documents = JSON.parse(localStorage.getItem('complianceDocuments')) || [];
            const document = documents.find(d => d.id === documentId);
            
            if (!document) {
                showNotification('Document not found', 'error');
                return;
            }
            
            // Open document in new tab
            const newTab = window.open();
            newTab.document.write(`
                <html>
                <head><title>${document.name}</title></head>
                <body style="margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh;">
                    <iframe src="${document.content}" width="100%" height="100%" style="border: none;"></iframe>
                </body>
                </html>
            `);
        }

        // Download document
        function downloadDocument(documentId) {
            const documents = JSON.parse(localStorage.getItem('complianceDocuments')) || [];
            const document = documents.find(d => d.id === documentId);
            
            if (!document) {
                showNotification('Document not found', 'error');
                return;
            }
            
            const link = document.createElement('a');
            link.href = document.content;
            link.download = document.name;
            link.click();
        }

        // Delete document
        function deleteDocument(documentId) {
            if (confirm('Are you sure you want to delete this document?')) {
                let documents = JSON.parse(localStorage.getItem('complianceDocuments')) || [];
                documents = documents.filter(d => d.id !== documentId);
                localStorage.setItem('complianceDocuments', JSON.stringify(documents));
                
                loadComplianceDocuments();
                showNotification('Document deleted successfully', 'success');
            }
        }

        // Load compliance data
        function loadComplianceData() {
            // Load compliance status
            if (currentBorrowerId) {
                const borrower = borrowers.find(b => b.id === currentBorrowerId);
                if (borrower) {
                    const kycStatus = document.getElementById('kycStatus');
                    const amlStatus = document.getElementById('amlStatus');
                    const botStatus = document.getElementById('botStatus');
                    
                    if (kycStatus) {
                        kycStatus.textContent = borrower.kycVerified ? 'Verified' : 'Not verified';
                        kycStatus.style.color = borrower.kycVerified ? 'var(--success-color)' : 'var(--danger-color)';
                    }
                    
                    if (amlStatus) {
                        amlStatus.textContent = borrower.amlChecked ? 'Checked' : 'Not checked';
                        amlStatus.style.color = borrower.amlChecked ? 'var(--success-color)' : 'var(--danger-color)';
                    }
                    
                    if (botStatus) {
                        botStatus.textContent = borrower.boTCompliance ? 'Compliant' : 'Not checked';
                        botStatus.style.color = borrower.boTCompliance ? 'var(--success-color)' : 'var(--danger-color)';
                    }
                }
            }
            
            // Load compliance documents
            loadComplianceDocuments();
        }

        // Load dashboard data
        function loadDashboardData() {
            // Calculate totals
            const totalLoanDisbursed = borrowers.reduce((sum, b) => sum + b.loanAmount, 0);
            const totalMoneyReceived = borrowers.reduce((sum, b) => sum + (b.totalAmount - b.balance), 0);
            const totalLoanPending = borrowers.reduce((sum, b) => sum + b.balance, 0);
            const activeBorrowers = borrowers.filter(b => b.status === 'active').length;
            const overdueLoans = paymentSchedules.filter(
                ps => new Date(ps.dueDate) < new Date() && ps.status === 'pending'
            ).length;
            const pendingReminders = reminders.filter(r => r.status === 'pending').length;
            
            // Calculate total interest income (profit)
            const totalInterestIncome = borrowers.reduce((sum, b) => sum + (b.totalAmount - b.loanAmount), 0);
            
            // Calculate active regions
            const activeRegions = [...new Set(borrowers.map(b => b.region))].length;
            
            // Update dashboard stats
            const dashboardLoanDisbursed = document.getElementById('dashboardLoanDisbursed');
            const dashboardMoneyReceived = document.getElementById('dashboardMoneyReceived');
            const dashboardLoanPending = document.getElementById('dashboardLoanPending');
            const dashboardActiveBorrowers = document.getElementById('dashboardActiveBorrowers');
            const dashboardOverdueLoans = document.getElementById('dashboardOverdueLoans');
            const dashboardPendingReminders = document.getElementById('dashboardPendingReminders');
            const dashboardTotalProfit = document.getElementById('dashboardTotalProfit');
            const dashboardActiveRegions = document.getElementById('dashboardActiveRegions');
            
            if (dashboardLoanDisbursed) dashboardLoanDisbursed.textContent = formatCurrency(totalLoanDisbursed, currentCurrency);
            if (dashboardMoneyReceived) dashboardMoneyReceived.textContent = formatCurrency(totalMoneyReceived, currentCurrency);
            if (dashboardLoanPending) dashboardLoanPending.textContent = formatCurrency(totalLoanPending, currentCurrency);
            if (dashboardActiveBorrowers) dashboardActiveBorrowers.textContent = activeBorrowers;
            if (dashboardOverdueLoans) dashboardOverdueLoans.textContent = overdueLoans;
            if (dashboardPendingReminders) dashboardPendingReminders.textContent = pendingReminders;
            if (dashboardTotalProfit) dashboardTotalProfit.textContent = formatCurrency(totalInterestIncome, currentCurrency);
            if (dashboardActiveRegions) dashboardActiveRegions.textContent = activeRegions;
            
            // Load recent repayments
            loadRecentRepayments();
            
            // Initialize charts
            initCharts();
        }

        // Load recent repayments
        function loadRecentRepayments() {
            const recentRepayments = document.getElementById('recentRepayments');
            if (!recentRepayments) return;
            
            recentRepayments.innerHTML = '';
            
            if (repayments.length === 0) {
                recentRepayments.innerHTML = '<tr><td colspan="5" style="text-align: center;">No recent repayments</td></tr>';
                return;
            }
            
            // Sort by date (newest first)
            const sortedRepayments = [...repayments].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Get last 5 repayments
            const recent = sortedRepayments.slice(0, 5);
            
            recent.forEach(repayment => {
                const borrower = borrowers.find(b => b.id === repayment.borrowerId);
                if (!borrower) return;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${borrower.fullName}</td>
                    <td>${borrower.region}</td>
                    <td>${new Date(repayment.date).toLocaleDateString()}</td>
                    <td>${formatCurrency(repayment.amount, repayment.currency)}</td>
                    <td><span class="status-indicator status-active"></span> Recorded</td>
                `;
                recentRepayments.appendChild(row);
            });
        }

        // Load all repayments
        function loadRepayments() {
            // Show all repayments in a modal or detailed view
            showNotification('Showing all repayments', 'info');
            
            // This would be implemented to show a detailed view of all repayments
            const repaymentsBody = document.getElementById('recentRepayments');
            if (!repaymentsBody) return;
            
            repaymentsBody.innerHTML = '';
            
            if (repayments.length === 0) {
                repaymentsBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No repayments found</td></tr>';
                return;
            }
            
            // Sort by date (newest first)
            const sortedRepayments = [...repayments].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedRepayments.forEach(repayment => {
                const borrower = borrowers.find(b => b.id === repayment.borrowerId);
                if (!borrower) return;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${borrower.fullName}</td>
                    <td>${borrower.region}</td>
                    <td>${new Date(repayment.date).toLocaleDateString()}</td>
                    <td>${formatCurrency(repayment.amount, repayment.currency)}</td>
                    <td><span class="status-indicator status-active"></span> Recorded</td>
                `;
                repaymentsBody.appendChild(row);
            });
        }

        // Initialize charts
        function initCharts() {
            const loanPerformanceCtx = document.getElementById('loanPerformanceChart');
            const portfolioDistributionCtx = document.getElementById('portfolioDistributionChart');
            const profitCtx = document.getElementById('profitChart');
            
            if (!loanPerformanceCtx || !portfolioDistributionCtx || !profitCtx) return;
            
            // Destroy existing charts if they exist
            if (loanPerformanceChart) {
                loanPerformanceChart.destroy();
            }
            if (portfolioDistributionChart) {
                portfolioDistributionChart.destroy();
            }
            if (profitChart) {
                profitChart.destroy();
            }
            
            // Get data for the last 3 months
            const currentDate = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(currentDate.getMonth() - 3);
            
            // Filter borrowers from the last 3 months
            const recentBorrowers = borrowers.filter(borrower => {
                const borrowerDate = new Date(borrower.createdAt);
                return borrowerDate >= threeMonthsAgo;
            });
            
            // Group loans by month for the last 3 months
            const loansByMonth = {};
            const months = [];
            
            // Initialize the last 3 months with zero values
            for (let i = 2; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthYear = `${date.getFullYear()}-${date.getMonth() + 1}`;
                const monthName = date.toLocaleString('default', { month: 'short' }) + ' ' + date.getFullYear();
                months.push(monthName);
                loansByMonth[monthYear] = 0;
            }
            
            // Add actual loan amounts
            recentBorrowers.forEach(borrower => {
                const date = new Date(borrower.createdAt);
                const monthYear = `${date.getFullYear()}-${date.getMonth() + 1}`;
                
                if (loansByMonth.hasOwnProperty(monthYear)) {
                    loansByMonth[monthYear] += borrower.loanAmount;
                }
            });
            
            // Prepare data for loan performance chart
            const loanAmounts = Object.values(loansByMonth);
            
            // Loan performance chart (line chart)
            loanPerformanceChart = new Chart(loanPerformanceCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Loan Disbursement',
                        data: loanAmounts,
                        backgroundColor: 'rgba(46, 134, 222, 0.2)',
                        borderColor: 'rgba(46, 134, 222, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` ${formatCurrency(context.raw, currentCurrency)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value, currentCurrency, true);
                                }
                            }
                        }
                    }
                }
            });
            
            // Group loans by region
            const loansByRegion = {};
            borrowers.forEach(borrower => {
                if (!loansByRegion[borrower.region]) {
                    loansByRegion[borrower.region] = 0;
                }
                
                loansByRegion[borrower.region] += borrower.loanAmount;
            });
            
            // Prepare data for portfolio distribution chart
            const regions = Object.keys(loansByRegion);
            const regionAmounts = regions.map(region => loansByRegion[region]);
            
            // Portfolio distribution chart (doughnut chart)
            portfolioDistributionChart = new Chart(portfolioDistributionCtx, {
                type: 'doughnut',
                data: {
                    labels: regions,
                    datasets: [{
                        data: regionAmounts,
                        backgroundColor: [
                            'rgba(46, 134, 222, 0.7)',
                            'rgba(16, 172, 132, 0.7)',
                            'rgba(255, 159, 67, 0.7)',
                            'rgba(238, 82, 83, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgba(46, 134, 222, 1)',
                            'rgba(16, 172, 132, 1)',
                            'rgba(255, 159, 67, 1)',
                            'rgba(238, 82, 83, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return ` ${context.label}: ${formatCurrency(value, currentCurrency)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Prepare data for profit chart (monthly profit for last 3 months)
            const profitByMonth = {};
            
            // Initialize the last 3 months with zero values
            for (let i = 2; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthYear = `${date.getFullYear()}-${date.getMonth() + 1}`;
                profitByMonth[monthYear] = 0;
            }
            
            // Add the interest as profit for recent borrowers
            recentBorrowers.forEach(borrower => {
                const date = new Date(borrower.createdAt);
                const monthYear = `${date.getFullYear()}-${date.getMonth() + 1}`;
                
                if (profitByMonth.hasOwnProperty(monthYear)) {
                    // Add the interest as profit
                    profitByMonth[monthYear] += (borrower.totalAmount - borrower.loanAmount);
                }
            });
            
            // Prepare data for profit chart
            const profitAmounts = Object.values(profitByMonth);
            
            // Profit chart (bar chart)
            profitChart = new Chart(profitCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Monthly Profit',
                        data: profitAmounts,
                        backgroundColor: 'rgba(16, 172, 132, 0.7)',
                        borderColor: 'rgba(16, 172, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` ${formatCurrency(context.raw, currentCurrency)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value, currentCurrency, true);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Load borrowers
        function loadBorrowers() {
            const borrowersBody = document.getElementById('borrowersList');
            if (!borrowersBody) return;
            
            borrowersBody.innerHTML = '';
            
            if (borrowers.length === 0) {
                borrowersBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No borrowers found</td></tr>';
                return;
            }
            
            borrowers.forEach(borrower => {
                const statusIndicator = borrower.status === 'active' ? 'status-active' : 
                                      borrower.status === 'pending' ? 'status-pending' : 
                                      borrower.status === 'overdue' ? 'status-overdue' : 
                                      'status-completed';
                
                const statusText = borrower.status === 'active' ? 'Active' : 
                                 borrower.status === 'pending' ? 'Pending' : 
                                 borrower.status === 'overdue' ? 'Overdue' : 
                                 'Completed';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${borrower.fullName}</td>
                    <td>${borrower.region}</td>
                    <td>${borrower.phoneNumber}</td>
                    <td>${formatCurrency(borrower.loanAmount, borrower.loanCurrency)}</td>
                    <td>${formatCurrency(borrower.totalAmount, borrower.loanCurrency)}</td>
                    <td>${formatCurrency(borrower.balance, borrower.loanCurrency)}</td>
                    <td><span class="status-indicator ${statusIndicator}"></span> ${statusText}</td>
                    <td>
                        <button class="action-button view-button" onclick="viewBorrowerDetails('${borrower.id}')" title="${translations[currentLanguage].view}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-button edit-button" onclick="editBorrower('${borrower.id}')" title="${translations[currentLanguage].edit}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-button delete-button" onclick="deleteBorrower('${borrower.id}')" title="${translations[currentLanguage].delete}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                borrowersBody.appendChild(row);
            });
        }

        // View borrower details
        function viewBorrowerDetails(borrowerId) {
            const borrower = borrowers.find(b => b.id === borrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            currentBorrowerId = borrowerId;
            
            // Update borrower details
            const borrowerName = document.getElementById('borrowerName');
            const borrowerIdElement = document.getElementById('borrowerId');
            const detailLoanAmount = document.getElementById('detailLoanAmount');
            const detailBalance = document.getElementById('detailBalance');
            const detailStatus = document.getElementById('detailStatus');
            
            if (borrowerName) borrowerName.textContent = borrower.fullName;
            if (borrowerIdElement) borrowerIdElement.textContent = `ID: ${borrower.id}`;
            if (detailLoanAmount) detailLoanAmount.textContent = formatCurrency(borrower.totalAmount, borrower.loanCurrency);
            if (detailBalance) detailBalance.textContent = formatCurrency(borrower.balance, borrower.loanCurrency);
            if (detailStatus) detailStatus.textContent = borrower.status.charAt(0).toUpperCase() + borrower.status.slice(1);
            
            // Update personal info tab
            const detailPhone = document.getElementById('detailPhone');
            const detailEmail = document.getElementById('detailEmail');
            const detailRegion = document.getElementById('detailRegion');
            const detailAddress = document.getElementById('detailAddress');
            const detailBusiness = document.getElementById('detailBusiness');
            const detailGuarantor = document.getElementById('detailGuarantor');
            
            if (detailPhone) detailPhone.textContent = borrower.phoneNumber;
            if (detailEmail) detailEmail.textContent = borrower.email || 'N/A';
            if (detailRegion) detailRegion.textContent = borrower.region;
            if (detailAddress) detailAddress.textContent = borrower.address;
            if (detailBusiness) detailBusiness.innerHTML = `
                <strong>Business:</strong> ${borrower.businessInfo || 'N/A'}<br>
                <strong>Loan Purpose:</strong> ${borrower.loanPurpose}
            `;
            if (detailGuarantor) detailGuarantor.innerHTML = `
                <strong>Name:</strong> ${borrower.guarantorName || 'N/A'}<br>
                <strong>Phone:</strong> ${borrower.guarantorPhone || 'N/A'}
            `;
            
            // Add call and SMS buttons for phone number
            if (detailPhone) {
                detailPhone.innerHTML = `
                    ${borrower.phoneNumber}
                    <button class="action-button call-button" onclick="callBorrower('${borrower.phoneNumber}')" title="${translations[currentLanguage].call}">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="action-button sms-button" onclick="sendSMS('${borrower.id}')" title="${translations[currentLanguage].sendSMS}">
                        <i class="fas fa-sms"></i>
                    </button>
                `;
            }
            
            // Add call and SMS buttons for guarantor phone number
            if (detailGuarantor && borrower.guarantorPhone) {
                detailGuarantor.innerHTML = `
                    <strong>Name:</strong> ${borrower.guarantorName || 'N/A'}<br>
                    <strong>Phone:</strong> ${borrower.guarantorPhone}
                    <button class="action-button call-button" onclick="callBorrower('${borrower.guarantorPhone}')" title="${translations[currentLanguage].call}">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="action-button sms-button" onclick="sendGuarantorSMS('${borrower.id}')" title="${translations[currentLanguage].sendSMS}">
                        <i class="fas fa-sms"></i>
                    </button>
                `;
            }
            
            // Update loan info tab
            const detailLoanAmount2 = document.getElementById('detailLoanAmount2');
            const detailInterestRate = document.getElementById('detailInterestRate');
            const detailTotalAmount = document.getElementById('detailTotalAmount');
            const detailAmountPaid = document.getElementById('detailAmountPaid');
            const detailBalance2 = document.getElementById('detailBalance2');
            const detailPaymentFrequency = document.getElementById('detailPaymentFrequency');
            const detailStartDate = document.getElementById('detailStartDate');
            const detailEndDate = document.getElementById('detailEndDate');
            const detailDaysRemaining = document.getElementById('detailDaysRemaining');
            const detailCollateral = document.getElementById('detailCollateral');
            
            if (detailLoanAmount2) detailLoanAmount2.textContent = formatCurrency(borrower.totalAmount, borrower.loanCurrency);
            if (detailInterestRate) detailInterestRate.textContent = `${borrower.interestRate}%`;
            if (detailTotalAmount) detailTotalAmount.textContent = formatCurrency(borrower.totalAmount, borrower.loanCurrency);
            if (detailAmountPaid) detailAmountPaid.textContent = formatCurrency(borrower.totalAmount - borrower.balance, borrower.loanCurrency);
            if (detailBalance2) detailBalance2.textContent = formatCurrency(borrower.balance, borrower.loanCurrency);
            if (detailPaymentFrequency) detailPaymentFrequency.textContent = borrower.paymentFrequency.charAt(0).toUpperCase() + borrower.paymentFrequency.slice(1);
            if (detailStartDate) detailStartDate.textContent = new Date(borrower.startDate).toLocaleDateString();
            
            const endDate = new Date(borrower.startDate);
            endDate.setDate(endDate.getDate() + borrower.loanTerm);
            if (detailEndDate) detailEndDate.textContent = endDate.toLocaleDateString();
            
            const daysRemaining = Math.max(0, Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24)));
            if (detailDaysRemaining) detailDaysRemaining.textContent = daysRemaining;
            
            if (detailCollateral) detailCollateral.textContent = borrower.collateralInfo || 'N/A';
            
            // Load payment schedule
            loadPaymentSchedule(borrowerId);
            
            // Load documents tab
            const detailIdType = document.getElementById('detailIdType');
            const detailIdNumber = document.getElementById('detailIdNumber');
            const detailAgreementSigned = document.getElementById('detailAgreementSigned');
            const detailAgreementDate = document.getElementById('detailAgreementDate');
            const detailCollateralDocs = document.getElementById('detailCollateralDocs');
            
            if (detailIdType) detailIdType.textContent = borrower.idType;
            if (detailIdNumber) detailIdNumber.textContent = borrower.idNumber;
            if (detailAgreementSigned) detailAgreementSigned.textContent = borrower.termsAccepted ? 'Yes' : 'No';
            if (detailAgreementDate) detailAgreementDate.textContent = new Date(borrower.createdAt).toLocaleDateString();
            if (detailCollateralDocs) detailCollateralDocs.textContent = borrower.collateralInfo ? 'Available' : 'None';
            
            // Show borrower details section
            const borrowerDetailsContainer = document.getElementById('borrowerDetailsContainer');
            if (borrowerDetailsContainer) borrowerDetailsContainer.style.display = 'block';
            showSection('borrower-details');
            
            // Load compliance data if we're in the compliance section
            if (document.getElementById('compliance') && document.getElementById('compliance').classList.contains('active')) {
                loadComplianceData();
            }
        }

        // Load payment schedule
        function loadPaymentSchedule(borrowerId) {
            const scheduleBody = document.getElementById('paymentSchedule');
            if (!scheduleBody) return;
            
            scheduleBody.innerHTML = '';
            
            const borrowerSchedules = paymentSchedules
                .filter(ps => ps.borrowerId === borrowerId)
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            if (borrowerSchedules.length === 0) {
                scheduleBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No payment schedule found</td></tr>';
                return;
            }
            
            borrowerSchedules.forEach(schedule => {
                const statusIndicator = schedule.status === 'paid' ? 'status-active' : 
                                      new Date(schedule.dueDate) < new Date() ? 'status-overdue' : 
                                      'status-pending';
                
                const statusText = schedule.status === 'paid' ? 'Paid' : 
                                 new Date(schedule.dueDate) < new Date() ? 'Overdue' : 
                                 'Pending';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(schedule.dueDate).toLocaleDateString()}</td>
                    <td>${formatCurrency(schedule.amountDue, currentCurrency)}</td>
                    <td><span class="status-indicator ${statusIndicator}"></span> ${statusText}</td>
                    <td>${schedule.paymentDate ? new Date(schedule.paymentDate).toLocaleDateString() : 'N/A'}</td>
                    <td>
                        ${schedule.status !== 'paid' ? `
                            <button class="btn btn-primary btn-sm" onclick="recordPaymentFromSchedule('${schedule.id}')">
                                <i class="fas fa-money-bill-wave"></i> Record
                            </button>
                        ` : ''}
                    </td>
                `;
                scheduleBody.appendChild(row);
            });
        }

        // Record payment from schedule
        function recordPaymentFromSchedule(scheduleId) {
            const schedule = paymentSchedules.find(ps => ps.id === scheduleId);
            if (!schedule) {
                showNotification('Payment schedule not found', 'error');
                return;
            }
            
            const borrower = borrowers.find(b => b.id === schedule.borrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            // Set up the repayment form
            showRecordPaymentModal();
            document.getElementById('borrowerSelect').value = borrower.id;
            document.getElementById('repaymentAmount').value = schedule.amountDue;
            document.getElementById('repaymentDate').value = new Date().toISOString().split('T')[0];
            
            showNotification(`Payment form pre-filled for ${borrower.fullName}`, 'info');
        }

        // Load borrower payments
        function loadBorrowerPayments(borrowerId) {
            const paymentsBody = document.getElementById('borrowerPayments');
            if (!paymentsBody) return;
            
            paymentsBody.innerHTML = '';
            
            const borrowerPayments = repayments
                .filter(r => r.borrowerId === borrowerId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (borrowerPayments.length === 0) {
                paymentsBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No payments found</td></tr>';
                return;
            }
            
            borrowerPayments.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(payment.date).toLocaleDateString()}</td>
                    <td>${formatCurrency(payment.amount, payment.currency)}</td>
                    <td>${payment.paymentMethod.charAt(0).toUpperCase() + payment.paymentMethod.slice(1)}</td>
                    <td>${payment.transactionReference || 'N/A'}</td>
                    <td>${payment.notes || 'N/A'}</td>
                    <td>
                        <button class="action-button view-button" onclick="viewPaymentReceipt('${payment.id}')" title="${translations[currentLanguage].view}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-button download-button" onclick="downloadPaymentReceipt('${payment.id}')" title="Download">
                            <i class="fas fa-download"></i>
                        </button>
                    </td>
                `;
                paymentsBody.appendChild(row);
            });
        }

        // View payment receipt
        function viewPaymentReceipt(paymentId) {
            const payment = repayments.find(r => r.id === paymentId);
            if (!payment) {
                showNotification('Payment not found', 'error');
                return;
            }
            
            const borrower = borrowers.find(b => b.id === payment.borrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            // Update receipt content
            const receiptNumber = document.getElementById('receiptNumber');
            const receiptDate = document.getElementById('receiptDate');
            const receiptBorrower = document.getElementById('receiptBorrower');
            const receiptAmount = document.getElementById('receiptAmount');
            const receiptMethod = document.getElementById('receiptMethod');
            const receiptReference = document.getElementById('receiptReference');
            
            if (receiptNumber) receiptNumber.textContent = payment.id.split('-')[1].toUpperCase();
            if (receiptDate) receiptDate.textContent = new Date(payment.date).toLocaleDateString();
            if (receiptBorrower) receiptBorrower.textContent = borrower.fullName;
            if (receiptAmount) receiptAmount.textContent = formatCurrency(payment.amount, payment.currency);
            if (receiptMethod) receiptMethod.textContent = payment.paymentMethod.charAt(0).toUpperCase() + payment.paymentMethod.slice(1);
            if (receiptReference) receiptReference.textContent = payment.transactionReference || 'N/A';
            
            // Add remaining balance to receipt
            const receiptContent = document.getElementById('receiptContent');
            if (receiptContent) {
                const remainBalanceElement = document.createElement('p');
                remainBalanceElement.innerHTML = `<strong>${translations[currentLanguage].remainBalance}:</strong> ${formatCurrency(borrower.balance, borrower.loanCurrency)}`;
                
                // Insert before the footer section
                const footerDiv = receiptContent.querySelector('div:last-child');
                receiptContent.insertBefore(remainBalanceElement, footerDiv);
            }
            
            // Show receipt modal
            document.getElementById('receiptModal').style.display = 'flex';
        }

        // Download payment receipt
        function downloadPaymentReceipt(paymentId) {
            const payment = repayments.find(r => r.id === paymentId);
            if (!payment) {
                showNotification('Payment not found', 'error');
                return;
            }
            
            const borrower = borrowers.find(b => b.id === payment.borrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            // Create receipt content
            const receiptContent = `
                <html>
                <head>
                    <title>Payment Receipt - ${payment.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .details { margin-bottom: 20px; }
                        .footer { margin-top: 30px; text-align: center; border-top: 1px dashed #ccc; padding-top: 10px; }
                        .detail-row { margin-bottom: 8px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>TanzaniaLoanPro</h2>
                        <p>Loan Management System</p>
                    </div>
                    <div class="details">
                        <div class="detail-row"><strong>Receipt No:</strong> ${payment.id.split('-')[1].toUpperCase()}</div>
                        <div class="detail-row"><strong>Date:</strong> ${new Date(payment.date).toLocaleDateString()}</div>
                        <div class="detail-row"><strong>Borrower:</strong> ${borrower.fullName}</div>
                        <div class="detail-row"><strong>Amount:</strong> ${formatCurrency(payment.amount, payment.currency)}</div>
                        <div class="detail-row"><strong>Payment Method:</strong> ${payment.paymentMethod.charAt(0).toUpperCase() + payment.paymentMethod.slice(1)}</div>
                        <div class="detail-row"><strong>Reference:</strong> ${payment.transactionReference || 'N/A'}</div>
                        <div class="detail-row"><strong>Remaining Balance:</strong> ${formatCurrency(borrower.balance, borrower.loanCurrency)}</div>
                        <div class="detail-row"><strong>Received By:</strong> System User</div>
                    </div>
                    <div class="footer">
                        <p>Thank you for your payment</p>
                        <p>For inquiries: +255 123 456 789</p>
                    </div>
                </body>
                </html>
            `;
            
            // Create a blob and download
            const blob = new Blob([receiptContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `receipt-${payment.id}.html`;
            a.click();
            
            showNotification('Receipt downloaded successfully', 'success');
        }

        // Edit borrower - FIXED VERSION
        function editBorrower(borrowerId) {
            // Check user permissions
            if (!['Administrator', 'Manager', 'Loan Officer'].includes(currentUser.role)) {
                showNotification('You do not have permission to edit borrowers', 'error');
                return;
            }
            
            const borrower = borrowers.find(b => b.id === borrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            // Fill the form with borrower data
            document.getElementById('fullName').value = borrower.fullName;
            document.getElementById('phoneNumber').value = borrower.phoneNumber;
            
            // Set ID type
            document.querySelectorAll('.id-type-option').forEach(option => {
                if (option.dataset.type === borrower.idType) {
                    option.classList.add('selected');
                    document.getElementById('idType').value = borrower.idType;
                } else {
                    option.classList.remove('selected');
                }
            });
            
            document.getElementById('idNumber').value = borrower.idNumber;
            document.getElementById('region').value = borrower.region;
            document.getElementById('district').value = borrower.district;
            document.getElementById('ward').value = borrower.ward;
            document.getElementById('address').value = borrower.address;
            document.getElementById('email').value = borrower.email || '';
            document.getElementById('businessInfo').value = borrower.businessInfo || '';
            
            // Set loan purpose
            document.querySelectorAll('.loan-purpose-option').forEach(option => {
                if (option.dataset.purpose === borrower.loanPurpose) {
                    option.classList.add('selected');
                    document.getElementById('loanPurpose').value = borrower.loanPurpose;
                } else {
                    option.classList.remove('selected');
                }
            });
            
            document.getElementById('loanAmount').value = borrower.loanAmount;
            document.getElementById('loanCurrency').value = borrower.loanCurrency;
            document.getElementById('interestRate').value = borrower.interestRate;
            document.getElementById('totalAmount').value = borrower.totalAmount;
            document.getElementById('loanTerm').value = borrower.loanTerm;
            document.getElementById('startDate').value = borrower.startDate;
            document.getElementById('paymentFrequency').value = borrower.paymentFrequency;
            document.getElementById('collateralInfo').value = borrower.collateralInfo || '';
            document.getElementById('guarantorName').value = borrower.guarantorName || '';
            document.getElementById('guarantorPhone').value = borrower.guarantorPhone || '';
            document.getElementById('kycVerified').checked = borrower.kycVerified;
            document.getElementById('amlChecked').checked = borrower.amlChecked;
            document.getElementById('termsAccepted').checked = borrower.termsAccepted;
            document.getElementById('boTCompliance').checked = borrower.boTCompliance;
            document.getElementById('isGroupLoan').checked = borrower.isGroupLoan;
            
            // Handle group members
            const groupMembersContainer = document.getElementById('groupMembersContainer');
            const groupMembersList = document.getElementById('groupMembersList');
            if (groupMembersList) groupMembersList.innerHTML = '';
            
            if (borrower.isGroupLoan && borrower.groupMembers.length > 0 && groupMembersContainer && groupMembersList) {
                groupMembersContainer.style.display = 'block';
                
                borrower.groupMembers.forEach(member => {
                    const memberId = `member-${Date.now()}`;
                    const memberHtml = `
                        <div class="group-member" id="${memberId}" style="margin-bottom: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 4px;">
                            <div class="input-group-row">
                                <div class="input-group">
                                    <label>${translations[currentLanguage].personalInfo}</label>
                                    <input type="text" class="form-control" value="${member.name}" required>
                                </div>
                                <div class="input-group">
                                    <label>${translations[currentLanguage].phoneNumber}</label>
                                    <input type="tel" class="form-control" value="${member.phone}" placeholder="+255" required>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>${translations[currentLanguage].idNumber}</label>
                                <input type="text" class="form-control" value="${member.idNumber}" required>
                            </div>
                            <button type="button" class="btn btn-danger btn-sm" onclick="document.getElementById('${memberId}').remove()" style="margin-top: 10px;">
                                <i class="fas fa-times"></i> ${translations[currentLanguage].remove}
                            </button>
                        </div>
                    `;
                    groupMembersList.insertAdjacentHTML('beforeend', memberHtml);
                });
            } else if (groupMembersContainer) {
                groupMembersContainer.style.display = 'none';
            }
            
            // Show the modal
            document.getElementById('newBorrowerModal').style.display = 'flex';
            
            // Remove any existing update button and add a new one
            const existingUpdateBtn = document.getElementById('updateBorrowerBtn');
            if (existingUpdateBtn) {
                existingUpdateBtn.remove();
            }
            
            const submitButton = document.querySelector('#borrowerForm button[type="submit"]');
            const updateButton = document.createElement('button');
            updateButton.type = 'button';
            updateButton.id = 'updateBorrowerBtn';
            updateButton.className = 'btn btn-success';
            updateButton.innerHTML = '<i class="fas fa-save"></i> Update Info';
            updateButton.onclick = function() {
                updateBorrower(borrowerId);
            };
            
            submitButton.parentNode.appendChild(updateButton);
            
            // Hide the original submit button
            submitButton.style.display = 'none';
        }

        // Update borrower - NEW FUNCTION
        function updateBorrower(borrowerId) {
            const borrower = borrowers.find(b => b.id === borrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            if (!validateBorrowerForm()) {
                return;
            }
            
            // Update borrower data
            borrower.fullName = document.getElementById('fullName').value;
            borrower.phoneNumber = document.getElementById('phoneNumber').value;
            borrower.idType = document.getElementById('idType').value;
            borrower.idNumber = document.getElementById('idNumber').value;
            borrower.region = document.getElementById('region').value;
            borrower.district = document.getElementById('district').value;
            borrower.ward = document.getElementById('ward').value;
            borrower.address = document.getElementById('address').value;
            borrower.email = document.getElementById('email').value || null;
            borrower.businessInfo = document.getElementById('businessInfo').value || null;
            borrower.loanPurpose = document.getElementById('loanPurpose').value;
            borrower.loanAmount = parseFloat(document.getElementById('loanAmount').value);
            borrower.loanCurrency = document.getElementById('loanCurrency').value;
            borrower.interestRate = parseFloat(document.getElementById('interestRate').value);
            
            // Recalculate total amount
            borrower.totalAmount = borrower.loanAmount + (borrower.loanAmount * (borrower.interestRate / 100));
            
            borrower.loanTerm = parseInt(document.getElementById('loanTerm').value);
            borrower.startDate = document.getElementById('startDate').value;
            borrower.paymentFrequency = document.getElementById('paymentFrequency').value;
            borrower.collateralInfo = document.getElementById('collateralInfo').value || null;
            borrower.guarantorName = document.getElementById('guarantorName').value || null;
            borrower.guarantorPhone = document.getElementById('guarantorPhone').value || null;
            borrower.kycVerified = document.getElementById('kycVerified').checked;
            borrower.amlChecked = document.getElementById('amlChecked').checked;
            borrower.termsAccepted = document.getElementById('termsAccepted').checked;
            borrower.boTCompliance = document.getElementById('boTCompliance').checked;
            borrower.isGroupLoan = document.getElementById('isGroupLoan').checked;
            
            // Update group members
            borrower.groupMembers = [];
            if (borrower.isGroupLoan) {
                const members = document.querySelectorAll('.group-member');
                members.forEach(member => {
                    const inputs = member.querySelectorAll('input');
                    borrower.groupMembers.push({
                        name: inputs[0].value,
                        phone: inputs[1].value,
                        idNumber: inputs[2].value
                    });
                });
            }
            
            // Recalculate balance if needed
            const totalPaid = repayments
                .filter(r => r.borrowerId === borrower.id)
                .reduce((sum, r) => sum + r.amount, 0);
            borrower.balance = borrower.totalAmount - totalPaid;
            
            // Update status if balance is zero
            if (borrower.balance <= 0) {
                borrower.status = 'completed';
                borrower.balance = 0;
            }
            
            // Save data
            saveData();
            
            // Show success message
            showNotification('Borrower updated successfully!', 'success');
            
            // Reset form and UI
            const borrowerForm = document.getElementById('borrowerForm');
            borrowerForm.reset();
            
            const photoPlaceholder = document.getElementById('photoPlaceholder');
            if (photoPlaceholder) {
                photoPlaceholder.style.backgroundImage = '';
                photoPlaceholder.innerHTML = '<i class="fas fa-user"></i>';
            }
            
            const groupMembersList = document.getElementById('groupMembersList');
            if (groupMembersList) groupMembersList.innerHTML = '';
            
            const groupMembersContainer = document.getElementById('groupMembersContainer');
            if (groupMembersContainer) groupMembersContainer.style.display = 'none';
            
            // Remove ID upload container if exists
            const idUploadContainer = document.getElementById('idUploadContainer');
            if (idUploadContainer) {
                idUploadContainer.remove();
            }
            
            // Close modal
            document.getElementById('newBorrowerModal').style.display = 'none';
            
            // Show the original submit button again and remove update button
            const submitButton = document.querySelector('#borrowerForm button[type="submit"]');
            submitButton.style.display = 'block';
            
            const updateButton = document.getElementById('updateBorrowerBtn');
            if (updateButton) {
                updateButton.remove();
            }
            
            // Update dashboard and borrowers list
            loadDashboardData();
            loadBorrowers();
            
            // If we're currently viewing this borrower, refresh the view
            if (currentBorrowerId === borrower.id) {
                viewBorrowerDetails(borrower.id);
            }
        }

        // Delete borrower
        function deleteBorrower(borrowerId) {
            // Check user permissions
            if (!['Administrator', 'Manager'].includes(currentUser.role)) {
                showNotification('You do not have permission to delete borrowers', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this borrower? This action cannot be undone.')) {
                const borrowerIndex = borrowers.findIndex(b => b.id === borrowerId);
                if (borrowerIndex === -1) {
                    showNotification('Borrower not found', 'error');
                    return;
                }
                
                // Check if borrower has any payments
                const hasPayments = repayments.some(r => r.borrowerId === borrowerId);
                if (hasPayments) {
                    showNotification('Cannot delete borrower with payment history. You can mark them as inactive instead.', 'error');
                    return;
                }
                
                // Remove borrower
                borrowers.splice(borrowerIndex, 1);
                
                // Remove payment schedules
                paymentSchedules = paymentSchedules.filter(ps => ps.borrowerId !== borrowerId);
                
                // Save data
                saveData();
                
                // Show success message
                showNotification('Borrower deleted successfully', 'success');
                
                // Update dashboard and borrowers list
                loadDashboardData();
                loadBorrowers();
                
                // If we're currently viewing this borrower, go back to all borrowers
                if (currentBorrowerId === borrowerId) {
                    showSection('all-borrowers');
                    currentBorrowerId = null;
                }
            }
        }

        // Call borrower
        function callBorrower(phoneNumber) {
            showNotification(`Calling ${phoneNumber}... (This would initiate a call in a real app)`, 'info');
            // In a real app, this would use tel: protocol to initiate a call
            // window.location.href = `tel:${phoneNumber}`;
        }

        // Send SMS to borrower
        function sendSMS(borrowerId) {
            const borrower = borrowers.find(b => b.id === borrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            currentBorrowerId = borrowerId;
            document.getElementById('smsTemplatesModal').style.display = 'flex';
        }

        // Send SMS to guarantor
        function sendGuarantorSMS(borrowerId) {
            const borrower = borrowers.find(b => b.id === borrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            showNotification(`SMS would be sent to guarantor ${borrower.guarantorName} at ${borrower.guarantorPhone}`, 'info');
        }

        // Send welcome SMS
        function sendWelcomeSMS(borrowerId) {
            const borrower = borrowers.find(b => b.id === borrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            showNotification(`Welcome SMS sent to ${borrower.fullName}`, 'success');
            document.getElementById('smsTemplatesModal').style.display = 'none';
        }

        // Send repayment confirmation SMS
        function sendRepaymentConfirmationSMS(borrowerId) {
            const borrower = borrowers.find(b => b.id === borrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            showNotification(`Repayment confirmation SMS sent to ${borrower.fullName}`, 'success');
            document.getElementById('smsTemplatesModal').style.display = 'none';
        }

        // Send payment reminder SMS
        function sendPaymentReminderSMS(borrowerId) {
            const borrower = borrowers.find(b => b.id === borrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            showNotification(`Payment reminder SMS sent to ${borrower.fullName}`, 'success');
            document.getElementById('smsTemplatesModal').style.display = 'none';
        }

        // Show SMS templates modal
        function showSmsTemplatesModal() {
            document.getElementById('smsTemplatesModal').style.display = 'flex';
        }

        // Update borrower dropdown
        function updateBorrowerDropdown() {
            const borrowerSelect = document.getElementById('borrowerSelect');
            if (!borrowerSelect) return;
            
            borrowerSelect.innerHTML = '<option value="">-- Select Borrower --</option>';
            
            borrowers.forEach(borrower => {
                if (borrower.status === 'active') {
                    const option = document.createElement('option');
                    option.value = borrower.id;
                    option.textContent = `${borrower.fullName} (${borrower.phoneNumber}) - Balance: ${formatCurrency(borrower.balance, borrower.loanCurrency)}`;
                    borrowerSelect.appendChild(option);
                }
            });
        }

        // Show repayment receipt
        function showRepaymentReceipt(repayment) {
            const borrower = borrowers.find(b => b.id === repayment.borrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            // Update receipt content
            const receiptNumber = document.getElementById('receiptNumber');
            const receiptDate = document.getElementById('receiptDate');
            const receiptBorrower = document.getElementById('receiptBorrower');
            const receiptAmount = document.getElementById('receiptAmount');
            const receiptMethod = document.getElementById('receiptMethod');
            const receiptReference = document.getElementById('receiptReference');
            
            if (receiptNumber) receiptNumber.textContent = repayment.id.split('-')[1].toUpperCase();
            if (receiptDate) receiptDate.textContent = new Date(repayment.date).toLocaleDateString();
            if (receiptBorrower) receiptBorrower.textContent = borrower.fullName;
            if (receiptAmount) receiptAmount.textContent = formatCurrency(repayment.amount, repayment.currency);
            if (receiptMethod) receiptMethod.textContent = repayment.paymentMethod.charAt(0).toUpperCase() + repayment.paymentMethod.slice(1);
            if (receiptReference) receiptReference.textContent = repayment.transactionReference || 'N/A';
            
            // Add remaining balance to receipt
            const receiptContent = document.getElementById('receiptContent');
            if (receiptContent) {
                const remainBalanceElement = document.createElement('p');
                remainBalanceElement.innerHTML = `<strong>${translations[currentLanguage].remainBalance}:</strong> ${formatCurrency(borrower.balance, borrower.loanCurrency)}`;
                
                // Insert before the footer section
                const footerDiv = receiptContent.querySelector('div:last-child');
                receiptContent.insertBefore(remainBalanceElement, footerDiv);
            }
            
            // Show receipt modal
            document.getElementById('receiptModal').style.display = 'flex';
        }

        // Print receipt
        function printReceipt() {
            const receiptContent = document.getElementById('receiptContent');
            if (!receiptContent) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Payment Receipt</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .details { margin-bottom: 20px; }
                        .footer { margin-top: 30px; text-align: center; border-top: 1px dashed #ccc; padding-top: 10px; }
                    </style>
                </head>
                <body>
                    ${receiptContent.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Print borrower statement
        function printBorrowerStatement() {
            if (!currentBorrowerId) {
                showNotification('Please select a borrower first', 'warning');
                return;
            }
            
            const borrower = borrowers.find(b => b.id === currentBorrowerId);
            if (!borrower) {
                showNotification('Borrower not found', 'error');
                return;
            }
            
            // Generate statement content
            const statementContent = `
                <html>
                <head>
                    <title>Borrower Statement - ${borrower.fullName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .details { margin-bottom: 20px; }
                        .summary { margin-top: 30px; padding: 15px; background-color: #f5f5f5; border-radius: 8px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>TanzaniaLoanPro</h2>
                        <p>Borrower Statement</p>
                    </div>
                    <div class="details">
                        <p><strong>Borrower:</strong> ${borrower.fullName}</p>
                        <p><strong>ID:</strong> ${borrower.id}</p>
                        <p><strong>Statement Period:</strong> ${new Date().toLocaleDateString()}</p>
                        <p><strong>Generated On:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Debit</th>
                                <th>Credit</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${new Date(borrower.startDate).toLocaleDateString()}</td>
                                <td>Loan Disbursement</td>
                                <td>${formatCurrency(borrower.loanAmount, borrower.loanCurrency)}</td>
                                <td>-</td>
                                <td>${formatCurrency(borrower.loanAmount, borrower.loanCurrency)}</td>
                            </tr>
                            ${repayments.filter(r => r.borrowerId === borrower.id).map(repayment => `
                                <tr>
                                    <td>${new Date(repayment.date).toLocaleDateString()}</td>
                                    <td>Repayment</td>
                                    <td>-</td>
                                    <td>${formatCurrency(repayment.amount, repayment.currency)}</td>
                                    <td>${formatCurrency(borrower.balance, borrower.loanCurrency)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="summary">
                        <h4>Summary</h4>
                        <p><strong>Opening Balance:</strong> ${formatCurrency(borrower.loanAmount, borrower.loanCurrency)}</p>
                        <p><strong>Total Debit:</strong> ${formatCurrency(borrower.loanAmount, borrower.loanCurrency)}</p>
                        <p><strong>Total Credit:</strong> ${formatCurrency(borrower.totalAmount - borrower.balance, borrower.loanCurrency)}</p>
                        <p><strong>Closing Balance:</strong> ${formatCurrency(borrower.balance, borrower.loanCurrency)}</p>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(statementContent);
            printWindow.document.close();
            printWindow.print();
            
            showNotification('Statement printed successfully', 'success');
        }

        // Print loan calculation
        function printLoanCalculation() {
            const calcSchedule = document.getElementById('calcSchedule');
            if (!calcSchedule) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Loan Calculation</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h2>Loan Calculation</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Date</th>
                                <th>Principal</th>
                                <th>Interest</th>
                                <th>Fees</th>
                                <th>Total</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${calcSchedule.innerHTML}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            showNotification('Loan calculation printed successfully', 'success');
        }

        // Print report
        function printReport() {
            const reportData = document.getElementById('reportData');
            if (!reportData) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h2>Report</h2>
                    <table>
                        <thead id="reportDataHeader">
                            <tr>
                                <th>Month</th>
                                <th>Loans Disbursed</th>
                                <th>Amount Disbursed</th>
                                <th>Repayments Collected</th>
                                <th>Amount Collected</th>
                                <th>PAR 30 Days</th>
                                <th>PAR 60 Days</th>
                                <th>PAR 90 Days</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.innerHTML}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            showNotification('Report printed successfully', 'success');
        }

        // Export borrowers list
        function exportBorrowersList() {
            // Create CSV content
            let csvContent = "Name,Region,Phone,Loan Amount,Total Amount,Balance,Status\n";
            
            borrowers.forEach(borrower => {
                                const status = borrower.status === 'active' ? 'Active' : 
                             borrower.status === 'pending' ? 'Pending' : 
                             borrower.status === 'overdue' ? 'Overdue' : 'Completed';
                
                csvContent += `"${borrower.fullName}",${borrower.region},${borrower.phoneNumber},${borrower.loanAmount},${borrower.totalAmount},${borrower.balance},${status}\n`;
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'borrowers-list.csv';
            link.click();
            
            showNotification('Borrowers list exported successfully', 'success');
        }

        // Format currency
        function formatCurrency(amount, currency, compact = false) {
            if (isNaN(amount)) return '0';
            
            const formatter = new Intl.NumberFormat('en-TZ', {
                style: 'currency',
                currency: currency || 'TZS',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            
            let formatted = formatter.format(amount);
            
            // For compact display (used in charts)
            if (compact && amount >= 1000000) {
                formatted = formatter.format(amount / 1000000) + 'M';
            } else if (compact && amount >= 1000) {
                formatted = formatter.format(amount / 1000) + 'K';
            }
            
            return formatted;
        }

        // Load today's repayments
        function loadTodaysRepayments() {
            const todaysRepayments = document.getElementById('todaysRepayments');
            if (!todaysRepayments) return;
            
            todaysRepayments.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            const todaysPayments = paymentSchedules.filter(
                ps => ps.dueDate.split('T')[0] === today && ps.status === 'pending'
            );
            
            if (todaysPayments.length === 0) {
                todaysRepayments.innerHTML = '<tr><td colspan="5" style="text-align: center;">No repayments due today</td></tr>';
                return;
            }
            
            todaysPayments.forEach(payment => {
                const borrower = borrowers.find(b => b.id === payment.borrowerId);
                if (!borrower) return;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${borrower.fullName}</td>
                    <td>${borrower.phoneNumber}</td>
                    <td>${formatCurrency(payment.amountDue, borrower.loanCurrency)}</td>
                    <td><span class="status-indicator status-pending"></span> Due Today</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="recordPaymentFromSchedule('${payment.id}')">
                            <i class="fas fa-money-bill-wave"></i> Record
                        </button>
                    </td>
                `;
                todaysRepayments.appendChild(row);
            });
        }

        // Load reminders
        function loadReminders() {
            const remindersBody = document.getElementById('remindersList');
            if (!remindersBody) return;
            
            remindersBody.innerHTML = '';
            
            if (reminders.length === 0) {
                remindersBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No reminders found</td></tr>';
                return;
            }
            
            // Sort by date (soonest first)
            const sortedReminders = [...reminders].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            sortedReminders.forEach(reminder => {
                const borrower = borrowers.find(b => b.id === reminder.borrowerId);
                const borrowerName = borrower ? borrower.fullName : 'Unknown Borrower';
                
                const statusIndicator = reminder.status === 'completed' ? 'status-active' : 
                                      new Date(reminder.date) < new Date() ? 'status-overdue' : 
                                      'status-pending';
                
                const statusText = reminder.status === 'completed' ? 'Completed' : 
                                 new Date(reminder.date) < new Date() ? 'Overdue' : 
                                 'Pending';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${borrowerName}</td>
                    <td>${reminder.type}</td>
                    <td>${new Date(reminder.date).toLocaleDateString()} ${reminder.time || ''}</td>
                    <td>${reminder.method}</td>
                    <td><span class="status-indicator ${statusIndicator}"></span> ${statusText}</td>
                    <td>
                        ${reminder.status !== 'completed' ? `
                            <button class="action-button edit-button" onclick="completeReminder('${reminder.id}')" title="Complete">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        <button class="action-button delete-button" onclick="deleteReminder('${reminder.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                remindersBody.appendChild(row);
            });
        }

        // Complete reminder
        function completeReminder(reminderId) {
            const reminder = reminders.find(r => r.id === reminderId);
            if (!reminder) {
                showNotification('Reminder not found', 'error');
                return;
            }
            
            reminder.status = 'completed';
            saveData();
            
            showNotification('Reminder marked as completed', 'success');
            loadReminders();
        }

        // Delete reminder
        function deleteReminder(reminderId) {
            if (confirm('Are you sure you want to delete this reminder?')) {
                const reminderIndex = reminders.findIndex(r => r.id === reminderId);
                if (reminderIndex === -1) {
                    showNotification('Reminder not found', 'error');
                    return;
                }
                
                reminders.splice(reminderIndex, 1);
                saveData();
                
                showNotification('Reminder deleted successfully', 'success');
                loadReminders();
            }
        }

        // Add reminder
        function addReminder() {
            // Check user permissions
            if (!['Administrator', 'Manager', 'Loan Officer'].includes(currentUser.role)) {
                showNotification('You do not have permission to add reminders', 'error');
                return;
            }
            
            document.getElementById('reminderForm').reset();
            document.getElementById('reminderDate').value = new Date().toISOString().split('T')[0];
            
            // Update borrower dropdown
            updateReminderBorrowerDropdown();
            
            document.getElementById('addReminderModal').style.display = 'flex';
            fabMenu.classList.remove('active');
        }

        // Update reminder borrower dropdown
        function updateReminderBorrowerDropdown() {
            const borrowerSelect = document.getElementById('reminderBorrower');
            if (!borrowerSelect) return;
            
            borrowerSelect.innerHTML = '<option value="">-- Select Borrower --</option>';
            
            borrowers.forEach(borrower => {
                if (borrower.status === 'active') {
                    const option = document.createElement('option');
                    option.value = borrower.id;
                    option.textContent = `${borrower.fullName} (${borrower.phoneNumber})`;
                    borrowerSelect.appendChild(option);
                }
            });
        }

        // Load reports
        function loadReports() {
            const reportData = document.getElementById('reportData');
            if (!reportData) return;
            
            reportData.innerHTML = '';
            
            // Generate report data for the last 6 months
            const months = [];
            const currentDate = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                months.push({
                    name: date.toLocaleString('default', { month: 'long', year: 'numeric' }),
                    year: date.getFullYear(),
                    month: date.getMonth() + 1
                });
            }
            
            months.forEach(month => {
                // Calculate metrics for this month
                const monthBorrowers = borrowers.filter(b => {
                    const borrowerDate = new Date(b.createdAt);
                    return borrowerDate.getFullYear() === month.year && 
                           borrowerDate.getMonth() + 1 === month.month;
                });
                
                const loansDisbursed = monthBorrowers.length;
                const amountDisbursed = monthBorrowers.reduce((sum, b) => sum + b.loanAmount, 0);
                
                const monthRepayments = repayments.filter(r => {
                    const repaymentDate = new Date(r.date);
                    return repaymentDate.getFullYear() === month.year && 
                           repaymentDate.getMonth() + 1 === month.month;
                });
                
                const repaymentsCollected = monthRepayments.length;
                const amountCollected = monthRepayments.reduce((sum, r) => sum + r.amount, 0);
                
                // Calculate PAR (Portfolio at Risk)
                const par30 = calculatePAR(30);
                const par60 = calculatePAR(60);
                const par90 = calculatePAR(90);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${month.name}</td>
                    <td>${loansDisbursed}</td>
                    <td>${formatCurrency(amountDisbursed, currentCurrency)}</td>
                    <td>${repaymentsCollected}</td>
                    <td>${formatCurrency(amountCollected, currentCurrency)}</td>
                    <td>${par30.toFixed(2)}%</td>
                    <td>${par60.toFixed(2)}%</td>
                    <td>${par90.toFixed(2)}%</td>
                `;
                reportData.appendChild(row);
            });
            
            // Initialize report chart
            initReportChart();
        }

        // Calculate Portfolio at Risk (PAR)
        function calculatePAR(days) {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - days);
            
            let totalParValue = 0;
            let totalPortfolioValue = 0;
            
            borrowers.forEach(borrower => {
                if (borrower.status === 'active' && borrower.balance > 0) {
                    // Check if this borrower has any overdue payments
                    const overduePayments = paymentSchedules.filter(
                        ps => ps.borrowerId === borrower.id && 
                              ps.status === 'pending' && 
                              new Date(ps.dueDate) < cutoffDate
                    );
                    
                    if (overduePayments.length > 0) {
                        totalParValue += borrower.balance;
                    }
                    
                    totalPortfolioValue += borrower.balance;
                }
            });
            
            return totalPortfolioValue > 0 ? (totalParValue / totalPortfolioValue) * 100 : 0;
        }

        // Initialize report chart
        function initReportChart() {
            const reportCtx = document.getElementById('reportChart');
            if (!reportCtx) return;
            
            if (reportChart) {
                reportChart.destroy();
            }
            
            // Prepare data for report chart (PAR over time)
            const months = [];
            const par30Data = [];
            const par60Data = [];
            const par90Data = [];
            
            const currentDate = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                months.push(date.toLocaleString('default', { month: 'short' }));
                
                // For demo purposes, use random data
                par30Data.push(Math.random() * 10);
                par60Data.push(Math.random() * 5);
                par90Data.push(Math.random() * 2);
            }
            
            reportChart = new Chart(reportCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'PAR 30',
                            data: par30Data,
                            borderColor: 'rgba(255, 159, 67, 1)',
                            backgroundColor: 'rgba(255, 159, 67, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: 'PAR 60',
                            data: par60Data,
                            borderColor: 'rgba(238, 82, 83, 1)',
                            backgroundColor: 'rgba(238, 82, 83, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: 'PAR 90',
                            data: par90Data,
                            borderColor: 'rgba(153, 102, 255, 1)',
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` ${context.dataset.label}: ${context.raw.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'PAR (%)'
                            }
                        }
                    }
                }
            });
        }

        // Load users
        function loadUsers() {
            const usersBody = document.getElementById('usersList');
            if (!usersBody) return;
            
            usersBody.innerHTML = '';
            
            if (users.length === 0) {
                usersBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No users found</td></tr>';
                return;
            }
            
            users.forEach(user => {
                const statusIndicator = user.active ? 'status-active' : 'status-inactive';
                const statusText = user.active ? 'Active' : 'Inactive';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td>${user.regions.join(', ')}</td>
                    <td><span class="status-indicator ${statusIndicator}"></span> ${statusText}</td>
                    <td>
                        ${user.id !== currentUser.id ? `
                            <button class="action-button edit-button" onclick="editUser('${user.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-button delete-button" onclick="deleteUser('${user.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </td>
                `;
                usersBody.appendChild(row);
            });
        }

        // Edit user
        function editUser(userId) {
            // Check user permissions
            if (currentUser.role !== 'Administrator') {
                showNotification('You do not have permission to edit users', 'error');
                return;
            }
            
            const user = users.find(u => u.id === userId);
            if (!user) {
                showNotification('User not found', 'error');
                return;
            }
            
            // Fill the form with user data
            document.getElementById('userFullName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userActive').checked = user.active;
            
            // Set regions
            const regionsContainer = document.getElementById('userRegions');
            regionsContainer.innerHTML = '';
            
            const allRegions = ['All', 'Dar es Salaam', 'Arusha', 'Mwanza', 'Dodoma', 'Mbeya', 'Morogoro', 'Tanga', 'Zanzibar'];
            
            allRegions.forEach(region => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `region-${region}`;
                checkbox.value = region;
                checkbox.checked = user.regions.includes(region);
                
                const label = document.createElement('label');
                label.htmlFor = `region-${region}`;
                label.textContent = region;
                
                const div = document.createElement('div');
                div.className = 'checkbox-group';
                div.appendChild(checkbox);
                div.appendChild(label);
                
                regionsContainer.appendChild(div);
            });
            
            // Show the modal
            document.getElementById('addUserModal').style.display = 'flex';
            
            // Remove any existing update button and add a new one
            const existingUpdateBtn = document.getElementById('updateUserBtn');
            if (existingUpdateBtn) {
                existingUpdateBtn.remove();
            }
            
            const submitButton = document.querySelector('#userForm button[type="submit"]');
            const updateButton = document.createElement('button');
            updateButton.type = 'button';
            updateButton.id = 'updateUserBtn';
            updateButton.className = 'btn btn-success';
            updateButton.innerHTML = '<i class="fas fa-save"></i> Update User';
            updateButton.onclick = function() {
                updateUser(userId);
            };
            
            submitButton.parentNode.appendChild(updateButton);
            
            // Hide the original submit button
            submitButton.style.display = 'none';
        }

        // Update user
        function updateUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                showNotification('User not found', 'error');
                return;
            }
            
            // Get selected regions
            const selectedRegions = [];
            document.querySelectorAll('#userRegions input[type="checkbox"]:checked').forEach(checkbox => {
                selectedRegions.push(checkbox.value);
            });
            
            // Update user data
            user.name = document.getElementById('userFullName').value;
            user.email = document.getElementById('userEmail').value;
            user.role = document.getElementById('userRole').value;
            user.active = document.getElementById('userActive').checked;
            user.regions = selectedRegions;
            
            // Save data
            saveData();
            
            // Show success message
            showNotification('User updated successfully!', 'success');
            
            // Reset form
            document.getElementById('userForm').reset();
            
            // Close modal
            document.getElementById('addUserModal').style.display = 'none';
            
            // Show the original submit button again and remove update button
            const submitButton = document.querySelector('#userForm button[type="submit"]');
            submitButton.style.display = 'block';
            
            const updateButton = document.getElementById('updateUserBtn');
            if (updateButton) {
                updateButton.remove();
            }
            
            // Update users list
            loadUsers();
        }

        // Delete user
        function deleteUser(userId) {
            // Check user permissions
            if (currentUser.role !== 'Administrator') {
                showNotification('You do not have permission to delete users', 'error');
                return;
            }
            
            if (userId === currentUser.id) {
                showNotification('You cannot delete your own account', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this user?')) {
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex === -1) {
                    showNotification('User not found', 'error');
                    return;
                }
                
                users.splice(userIndex, 1);
                saveData();
                
                showNotification('User deleted successfully', 'success');
                loadUsers();
            }
        }

        // Save system settings
        function saveSystemSettings() {
            // Check user permissions
            if (currentUser.role !== 'Administrator') {
                showNotification('You do not have permission to change system settings', 'error');
                return;
            }
            
            systemSettings.systemName = document.getElementById('systemName').value;
            systemSettings.defaultCurrency = document.getElementById('defaultCurrency').value;
            systemSettings.defaultLanguage = document.getElementById('defaultLanguage').value;
            systemSettings.timezone = document.getElementById('timezone').value;
            systemSettings.smsIntegration = document.getElementById('smsIntegration').value;
            systemSettings.emailIntegration = document.getElementById('emailIntegration').value;
            systemSettings.backupFrequency = document.getElementById('backupFrequency').value;
            systemSettings.backupLocation = document.getElementById('backupLocation').value;
            
            saveData();
            
            // Update app title
            document.getElementById('appTitle').textContent = systemSettings.systemName;
            
            showNotification('System settings saved successfully', 'success');
        }

        // Initialize the app when DOM is loaded
          document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
